'use strict';var OIMO={REVISION:"1.2",nextID:0,proxyID:0,BR_NULL:0,BR_BRUTE_FORCE:1,BR_SWEEP_AND_PRUNE:2,BR_BOUNDING_VOLUME_TREE:3,BODY_NULL:0,BODY_DYNAMIC:1,BODY_STATIC:2,SHAPE_NULL:0,SHAPE_SPHERE:1,SHAPE_BOX:2,SHAPE_CYLINDER:3,JOINT_NULL:0,JOINT_DISTANCE:1,JOINT_BALL_AND_SOCKET:2,JOINT_HINGE:3,JOINT_WHEEL:4,JOINT_SLIDER:5,JOINT_PRISMATIC:6,WORLD_SCALE:100,INV_SCALE:0.01,AABB_PROX:0.005,sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,
round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,lerp:function(a,c,b){return a+(c-a)*b},rand:function(a,c){return OIMO.lerp(a,c,OIMO.random())},randInt:function(a,c,b){return 1*OIMO.lerp(a,c,OIMO.random()).toFixed(b||0)},int:function(a){return~~a},fix:function(a,c){return a.toFixed(c||3,10)},clamp:function(a,c,b){return OIMO.max(c,OIMO.min(b,a))},degtorad:0.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,
CustomError:null,Error:function(a,c){null==OIMO.CustomError?console.error(a,c):OIMO.CustomError.innerHTML+=a+" - "+c+"<br>"}},OIMO_ARRAY_TYPE;OIMO_ARRAY_TYPE||(OIMO_ARRAY_TYPE="undefined"!==typeof Float32Array?Float32Array:Array);(function(a){var c,b=["now","webkitNow","msNow","mozNow"];if(a.performance)for(var d=0;d<b.length;++d){var e=b[d];if(a.performance[e]){c=function(){return a.performance[e]()};break}}c||(c=Date.now);OIMO.now=c})(window);OIMO.World=function(a,c,b,d){this.timeStep=a||0.01666;this.numIterations=b||8;switch(c||2){case 1:this.broadPhase=new OIMO.BruteForceBroadPhase;break;default:this.broadPhase=new OIMO.SAPBroadPhase;break;case 3:this.broadPhase=new OIMO.DBVTBroadPhase}this.performance=null;this.isNoStat=d||!1;this.isNoStat||(this.performance=new OIMO.Performance(this));this.enableRandomizer=!0;this.rigidBodies=null;this.numRigidBodies=0;this.unusedContacts=this.contacts=null;this.numContactPoints=this.numContacts=0;
this.joints=null;this.numIslands=this.numJoints=0;this.gravity=new OIMO.Vec3(0,-9.80665,0);this.detectors=[];for(a=this.detectors.length=4;a--;)this.detectors[a]=[],this.detectors[a].length=4;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_SPHERE]=new OIMO.SphereSphereCollisionDetector;this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_BOX]=new OIMO.SphereBoxCollisionDetector(!1);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_SPHERE]=new OIMO.SphereBoxCollisionDetector(!0);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_BOX]=
new OIMO.BoxBoxCollisionDetector;this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_CYLINDER]=new OIMO.CylinderCylinderCollisionDetector;this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_BOX]=new OIMO.BoxCylinderCollisionDetector(!0);this.detectors[OIMO.SHAPE_BOX][OIMO.SHAPE_CYLINDER]=new OIMO.BoxCylinderCollisionDetector(!1);this.detectors[OIMO.SHAPE_CYLINDER][OIMO.SHAPE_SPHERE]=new OIMO.SphereCylinderCollisionDetector(!0);this.detectors[OIMO.SHAPE_SPHERE][OIMO.SHAPE_CYLINDER]=new OIMO.SphereCylinderCollisionDetector(!1);
this.randX=65535;this.randA=98765;this.randB=123456789;this.islandRigidBodies=[];this.islandStack=[];this.islandConstraints=[]};
OIMO.World.prototype={constructor:OIMO.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);OIMO.nextID=0;OIMO.proxyID=0},addRigidBody:function(a){a.parent&&OIMO.Error("World","It is not possible to be added to more than one world one of the rigid body");a.parent=this;a.awake();for(var c=a.shapes;null!==c;c=c.next)this.addShape(c);
null!==this.rigidBodies&&((this.rigidBodies.prev=a).next=this.rigidBodies);this.rigidBodies=a;this.numRigidBodies++},removeRigidBody:function(a){if(a.parent===this){a.awake();for(var c=a.jointLink;null!=c;){var b=c.joint,c=c.next;this.removeJoint(b)}for(c=a.shapes;null!==c;c=c.next)this.removeShape(c);c=a.prev;b=a.next;null!==c&&(c.next=b);null!==b&&(b.prev=c);this.rigidBodies==a&&(this.rigidBodies=b);a.prev=null;a.next=null;a.parent=null;this.numRigidBodies--}},getByName:function(a){for(var c=null,
b=this.rigidBodies;null!==b;)" "!==b.name&&b.name===a&&(c=b),b=b.next;for(b=this.joints;null!==b;)""!==b.name&&b.name===a&&(c=b),b=b.next;return c},addShape:function(a){a.parent&&a.parent.parent||OIMO.Error("World","It is not possible to be added alone to shape world");a.proxy=this.broadPhase.createProxy(a);a.updateProxy();this.broadPhase.addProxy(a.proxy)},removeShape:function(a){this.broadPhase.removeProxy(a.proxy);a.proxy=null},addJoint:function(a){a.parent&&OIMO.Error("World","It is not possible to be added to more than one world one of the joint");
null!=this.joints&&((this.joints.prev=a).next=this.joints);this.joints=a;a.parent=this;this.numJoints++;a.awake();a.attach()},removeJoint:function(a){var c=a.prev,b=a.next;null!==c&&(c.next=b);null!==b&&(b.prev=c);this.joints==a&&(this.joints=b);a.prev=null;a.next=null;this.numJoints--;a.awake();a.detach();a.parent=null},worldscale:function(a){OIMO.WORLD_SCALE=a||100;OIMO.INV_SCALE=1/OIMO.WORLD_SCALE},addContact:function(a,c){var b;null!==this.unusedContacts?(b=this.unusedContacts,this.unusedContacts=
this.unusedContacts.next):b=new OIMO.Contact;b.attach(a,c);b.detector=this.detectors[a.type][c.type];this.contacts&&((this.contacts.prev=b).next=this.contacts);this.contacts=b;this.numContacts++},removeContact:function(a){var c=a.prev,b=a.next;b&&(b.prev=c);c&&(c.next=b);this.contacts==a&&(this.contacts=b);a.prev=null;a.next=null;a.detach();a.next=this.unusedContacts;this.unusedContacts=a;this.numContacts--},checkContact:function(a,c){for(var b,d,e=this.contacts;null!==e;)if(b=e.body1.name||" ",d=
e.body2.name||" ",b==a&&d==c||d==a&&b==c){if(e.touching)return!0;break}else e=e.next;return!1},callSleep:function(a){return!a.allowSleep||0.04<a.linearVelocity.lengthSq()||0.25<a.angularVelocity.lengthSq()?!1:!0},step:function(){var a,c,b,d=this.isNoStat?!1:!0;d&&(a=OIMO.now());for(var e=this.rigidBodies;null!==e;)e.addedToIsland=!1,e.sleeping&&(e.linearVelocity.testZero()||e.angularVelocity.testZero()||e.position.testDiff(e.sleepPosition)||e.orientation.testDiff(e.sleepOrientation))&&e.awake(),e=
e.next;d&&(c=OIMO.now());this.broadPhase.detectPairs();for(var f=this.broadPhase.pairs,g=this.broadPhase.numPairs;g--;){var h=f[g],k;h.shape1.id<h.shape2.id?(k=h.shape1,e=h.shape2):(k=h.shape2,e=h.shape1);var l;l=k.numContacts<e.numContacts?k.contactLink:e.contactLink;for(var n=!1;l;){h=l.contact;if(h.shape1==k&&h.shape2==e){n=h.persisting=!0;break}l=l.next}n||this.addContact(k,e)}d&&(b=OIMO.now(),this.performance.broadPhaseTime=b-c);this.numContactPoints=0;for(h=this.contacts;null!==h;)!h.persisting&&
h.shape1.aabb.intersectTest(h.shape2.aabb)?(l=h.next,this.removeContact(h),h=l):(c=h.body1,f=h.body2,(c.isDynamic&&!c.sleeping||f.isDynamic&&!f.sleeping)&&h.updateManifold(),this.numContactPoints+=h.manifold.numPoints,h.persisting=!1,h.constraint.addedToIsland=!1,h=h.next);d&&(c=OIMO.now(),this.performance.narrowPhaseTime=c-b);b=1/this.timeStep;for(c=this.joints;null!==c;c=c.next)c.addedToIsland=!1;this.islandRigidBodies=[];this.islandConstraints=[];this.islandStack=[];c=OIMO.now();this.numIslands=
0;for(f=this.rigidBodies;null!==f;f=f.next)if(!(f.addedToIsland||f.isStatic||f.sleeping)){if(f.isLonely())f.isDynamic&&f.linearVelocity.addTime(this.gravity,this.timeStep),this.callSleep(f)?(f.sleepTime+=this.timeStep,0.5<f.sleepTime?f.sleep():f.updatePosition(this.timeStep)):(f.sleepTime=0,f.updatePosition(this.timeStep));else{k=g=0;n=1;this.islandStack[0]=f;f.addedToIsland=!0;do if(e=this.islandStack[--n],this.islandStack[n]=null,e.sleeping=!1,this.islandRigidBodies[g++]=e,!e.isStatic){for(var m=
e.contactLink;null!==m;m=m.next)h=m.contact,l=h.constraint,!l.addedToIsland&&h.touching&&(this.islandConstraints[k++]=l,l.addedToIsland=!0,l=m.body,l.addedToIsland||(this.islandStack[n++]=l,l.addedToIsland=!0));for(h=e.jointLink;null!==h;h=h.next)l=h.joint,l.addedToIsland||(this.islandConstraints[k++]=l,l.addedToIsland=!0,l=h.body,!l.addedToIsland&&l.isDynamic&&(this.islandStack[n++]=l,l.addedToIsland=!0))}while(0!=n);l=(new OIMO.Vec3).addTime(this.gravity,this.timeStep);for(h=g;h--;)e=this.islandRigidBodies[h],
e.isDynamic&&e.linearVelocity.addEqual(l);if(this.enableRandomizer)for(h=k;h--;)0!==h&&(e=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*h|0,l=this.islandConstraints[h],this.islandConstraints[h]=this.islandConstraints[e],this.islandConstraints[e]=l);for(h=k;h--;)this.islandConstraints[h].preSolve(this.timeStep,b);for(e=this.numIterations;e--;)for(h=k;h--;)this.islandConstraints[h].solve();for(h=k;h--;)this.islandConstraints[h].postSolve(),this.islandConstraints[h]=null;k=10;for(h=
g;h--;)e=this.islandRigidBodies[h],this.callSleep(e)?(e.sleepTime+=this.timeStep,e.sleepTime<k&&(k=e.sleepTime)):k=e.sleepTime=0;if(0.5<k)for(h=g;h--;)this.islandRigidBodies[h].sleep(),this.islandRigidBodies[h]=null;else for(h=g;h--;)this.islandRigidBodies[h].updatePosition(this.timeStep),this.islandRigidBodies[h]=null}this.numIslands++}d&&(b=OIMO.now(),this.performance.solvingTime=b-c,b=OIMO.now(),this.performance.upfps(),this.performance.totalTime=b-a)}};OIMO.RigidBody=function(a,c,b,d,e,f,g){this.name=" ";this.MAX_SHAPES=64;this.next=this.prev=null;this.type=OIMO.BODY_NULL;this.massInfo=new OIMO.MassInfo;this.position=new OIMO.Vec3(a,c,b);this.orientation=this.rotationAxisToQuad(d||0,e||0,f||0,g||0);this.newPosition=new OIMO.Vec3;this.controlPos=!1;this.newOrientation=new OIMO.Quat;this.newRotation=new OIMO.Vec3;this.currentRotation=new OIMO.Vec3;this.controlRotInTime=this.controlRot=!1;this.linearVelocity=new OIMO.Vec3;this.angularVelocity=new OIMO.Vec3;
this.matrix=new OIMO.Mat44;this.contactLink=this.parent=null;this.numContacts=0;this.shapes=null;this.numShapes=0;this.jointLink=null;this.numJoints=0;this.sleepPosition=new OIMO.Vec3;this.sleepOrientation=new OIMO.Quat;this.isDynamic=this.isStatic=!1;this.rotation=new OIMO.Mat33;this.inverseMass=this.mass=NaN;this.inverseInertia=new OIMO.Mat33;this.localInertia=new OIMO.Mat33;this.inverseLocalInertia=new OIMO.Mat33;this.addedToIsland=!1;this.allowSleep=!0;this.sleepTime=0;this.sleeping=!1};
OIMO.RigidBody.prototype={constructor:OIMO.RigidBody,addShape:function(a){a.parent&&OIMO.Error("RigidBody","It is not possible that you add to the multi-rigid body the shape of one");null!=this.shapes&&((this.shapes.prev=a).next=this.shapes);this.shapes=a;a.parent=this;this.parent&&this.parent.addShape(a);this.numShapes++},removeShape:function(a){if(a.parent==this){var c=a.prev,b=a.next;null!=c&&(c.next=b);null!=b&&(b.prev=c);this.shapes==a&&(this.shapes=b);a.prev=null;a.next=null;a.parent=null;this.parent&&
this.parent.removeShape(a);this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(a){this.parent.checkContact(this.name,a)},setupMass:function(a,c){var b=void 0!==c?c:!0;this.type=a||OIMO.BODY_DYNAMIC;this.isDynamic=this.type==OIMO.BODY_DYNAMIC;this.isStatic=this.type==OIMO.BODY_STATIC;this.mass=0;this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var d=this.localInertia.elements,e=new OIMO.Mat33,f=new OIMO.Vec3,g=this.shapes;null!=
g;g=g.next){g.calculateMassInfo(this.massInfo);var h=this.massInfo.mass,k=g.relativePosition.x,l=g.relativePosition.y,n=g.relativePosition.z;f.addScale(g.relativePosition,h);this.mass+=h;this.rotateInertia(g.relativeRotation,this.massInfo.inertia,e);this.localInertia.addEqual(e);d[0]+=h*(l*l+n*n);d[4]+=h*(k*k+n*n);d[8]+=h*(k*k+l*l);var m=h*k*l,l=h*l*n,h=h*n*k;d[1]-=m;d[3]-=m;d[2]-=l;d[6]-=l;d[5]-=h;d[7]-=h}this.inverseMass=1/this.mass;f.scaleEqual(this.inverseMass);if(b){this.position.addEqual(f);
for(g=this.shapes;null!=g;g=g.next)g.relativePosition.subEqual(f);k=f.x;l=f.y;n=f.z;d[0]-=this.mass*(l*l+n*n);d[4]-=this.mass*(k*k+n*n);d[8]-=this.mass*(k*k+l*l);m=this.mass*k*l;l=this.mass*l*n;h=this.mass*n*k;d[1]+=m;d[3]+=m;d[2]+=l;d[6]+=l;d[5]+=h;d[7]+=h}this.inverseLocalInertia.invert(this.localInertia);this.type==OIMO.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0));this.syncShapes();this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=
!1;this.sleepTime=0;for(var a=this.contactLink;null!=a;)a.body.sleepTime=0,a.body.sleeping=!1,a=a.next;for(a=this.jointLink;null!=a;)a.body.sleepTime=0,a.body.sleeping=!1,a=a.next;for(a=this.shapes;null!=a;a=a.next)a.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0);this.angularVelocity.set(0,0,0);this.sleepPosition.copy(this.position);this.sleepOrientation.copy(this.orientation);this.sleepTime=0;this.sleeping=!0;for(var a=this.shapes;null!=a;a=a.next)a.updateProxy()}},
isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(a){switch(this.type){case OIMO.BODY_STATIC:this.linearVelocity.set(0,0,0);this.angularVelocity.set(0,0,0);this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1);this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case OIMO.BODY_DYNAMIC:this.controlPos&&(this.angularVelocity.set(0,0,0),this.linearVelocity.set(0,0,0),this.linearVelocity.x=(this.newPosition.x-
this.position.x)/a,this.linearVelocity.y=(this.newPosition.y-this.position.y)/a,this.linearVelocity.z=(this.newPosition.z-this.position.z)/a,this.controlPos=!1);this.controlRot&&(this.angularVelocity.set(0,0,0),this.orientation.copy(this.newOrientation),this.controlRot=!1);this.position.addTime(this.linearVelocity,a);this.orientation.addTime(this.angularVelocity,a);break;default:OIMO.Error("RigidBody","Invalid type.")}this.syncShapes()},rotateInertia:function(a,c,b){var d=a.elements,e=c.elements;
c=d[0];a=d[3];var f=d[6],g=d[1],h=d[4],k=d[7],l=d[2],n=d[5],d=d[8],m=e[0],p=e[3],s=e[6],q=e[1],u=e[4],r=e[7],t=e[2],z=e[5],F=e[8],e=c*m+g*p+l*s,J=c*q+g*u+l*r,H=c*t+g*z+l*F,B=a*m+h*p+n*s,I=a*q+h*u+n*r,K=a*t+h*z+n*F,m=f*m+k*p+d*s,q=f*q+k*u+d*r,t=f*t+k*z+d*F;b=b.elements;b[0]=e*c+J*g+H*l;b[1]=e*a+J*h+H*n;b[2]=e*f+J*k+H*d;b[3]=B*c+I*g+K*l;b[4]=B*a+I*h+K*n;b[5]=B*f+I*k+K*d;b[6]=m*c+q*g+t*l;b[7]=m*a+q*h+t*n;b[8]=m*f+q*k+t*d},syncShapes:function(){var a=this.orientation.s,c=this.orientation.x,b=this.orientation.y,
d=this.orientation.z,e=2*c,f=2*b,g=2*d,h=c*e,k=b*f,d=d*g,l=c*f,b=b*g,c=c*g,e=a*e,f=a*f,a=a*g,g=this.rotation.elements;g[0]=1-k-d;g[1]=l-a;g[2]=c+f;g[3]=l+a;g[4]=1-h-d;g[5]=b-e;g[6]=c-f;g[7]=b+e;g[8]=1-h-k;this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(h=this.shapes;null!=h;h=h.next)h.position.mul(this.position,h.relativePosition,this.rotation),h.rotation.mul(this.rotation,h.relativeRotation),h.updateProxy()},applyImpulse:function(a,c){this.linearVelocity.addScale(c,
this.inverseMass);var b=new OIMO.Vec3;b.sub(a,this.position).cross(b,c).mulMat(this.inverseInertia,b);this.angularVelocity.addEqual(b)},rotationVectToQuad:function(a){a=OIMO.EulerToAxis(a.x*OIMO.degtorad,a.y*OIMO.degtorad,a.z*OIMO.degtorad);return this.rotationAxisToQuad(a[0],a[1],a[2],a[3])},rotationAxisToQuad:function(a,c,b,d){var e=c*c+b*b+d*d;0<e&&(e=1/OIMO.sqrt(e),c*=e,b*=e,d*=e);e=OIMO.sin(0.5*a);a=OIMO.cos(0.5*a);return new OIMO.Quat(a,e*c,e*b,e*d)},setPosition:function(a){this.newPosition.copy(a).multiplyScalar(OIMO.INV_SCALE);
this.controlPos=!0},setQuaternion:function(a){this.newOrientation.set(a.x,a.y,a.z,a.w);this.controlRot=!0},setRotation:function(a){this.newOrientation=this.rotationVectToQuad(a);this.controlRot=!0},resetPosition:function(a,c,b){this.linearVelocity.set(0,0,0);this.angularVelocity.set(0,0,0);this.position.set(a,c,b).multiplyScalar(OIMO.INV_SCALE);this.awake()},resetQuaternion:function(a){this.angularVelocity.set(0,0,0);this.orientation=new OIMO.Quat(a.w,a.x,a.y,a.z);this.awake()},resetRotation:function(a,
c,b){this.angularVelocity.set(0,0,0);this.orientation=this.rotationVectToQuad(new OIMO.Vec3(a,c,b));this.awake()},getPosition:function(){return(new OIMO.Vec3).scale(this.position,OIMO.WORLD_SCALE)},getRotation:function(){return(new OIMO.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new OIMO.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var a=this.matrix.elements,c;this.sleeping?a[15]=1:(c=this.rotation.elements,a[0]=c[0],a[1]=c[3],a[2]=c[6],
a[3]=0,a[4]=c[1],a[5]=c[4],a[6]=c[7],a[7]=0,a[8]=c[2],a[9]=c[5],a[10]=c[8],a[11]=0,c=this.position,a[12]=c.x*OIMO.WORLD_SCALE,a[13]=c.y*OIMO.WORLD_SCALE,a[14]=c.z*OIMO.WORLD_SCALE,a[15]=0);return a}};OIMO.Body=function(a){a=a||{};a.world&&(void 0===a.type&&(a.type="box"),this.name=a.name||"",this.body=a.world.add(a))};
OIMO.Body.prototype={constructor:OIMO.Body,setPosition:function(a){this.body.setPosition(a)},setQuaternion:function(a){this.body.setQuaternion(a)},setRotation:function(a){this.body.setRotation(a)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(a,c,b){this.body.resetPosition(a,
c,b)},resetRotation:function(a,c,b){this.body.resetRotation(a,c,b)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(a){this.body.checkContact(a)}};OIMO.Link=function(a){a=a||{};a.world&&(void 0===a.type&&(a.type="jointHinge"),this.name=a.name||"",this.joint=a.world.add(a))};OIMO.Link.prototype={constructor:OIMO.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}};OIMO.Dictionary=function(){this.data={};this.keys=[]};OIMO.Dictionary.prototype={constructor:OIMO.Dictionary,set:function(a){var c=a.id;this.get[c]||this.keys.push(c);this.data[c]=a},get:function(a){return this.data[a]},del:function(a){var c=this.keys;a=c.indexOf(a.id);-1<a&&(delete this.data[c[a]],c.splice(a,1))},reset:function(){for(var a=this.data,c=this.keys,b;0<c.length;)b=c.pop(),delete a[b]}};OIMO.Performance=function(a){this.parent=a;this.infos=new OIMO_ARRAY_TYPE(13);this.f=[0,0,0];this.types=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"];this.broadPhase=this.types[this.parent.broadPhase.types];this.version=OIMO.REVISION;this.totalTime=this.solvingTime=this.narrowPhaseTime=this.broadPhaseTime=this.fps=0};
OIMO.Performance.prototype={upfps:function(){this.f[1]=Date.now();this.f[1]-1E3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0);this.f[2]++},updatingTime:function(){return OIMO.fix(this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime))},show:function(){return["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+
this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconde<br><br>","broad-phase &nbsp;"+OIMO.fix(this.broadPhaseTime)+"<br>","narrow-phase "+OIMO.fix(this.narrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+OIMO.fix(this.solvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+OIMO.fix(this.totalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime()+
"<br>"].join("\n")},toArray:function(){this.infos[0]=this.parent.broadPhase.types;this.infos[1]=this.parent.numRigidBodies;this.infos[2]=this.parent.numContacts;this.infos[3]=this.parent.broadPhase.numPairChecks;this.infos[4]=this.parent.numContactPoints;this.infos[5]=this.parent.numIslands;this.infos[6]=this.broadPhaseTime;this.infos[7]=this.narrowPhaseTime;this.infos[8]=this.solvingTime;this.infos[9]=this.updatingTime();this.infos[10]=this.totalTime;this.infos[11]=this.fps;return this.infos}};OIMO.Mat44=function(a,c,b,d,e,f,g,h,k,l,n,m,p,s,q,u){var r=this.elements=new OIMO_ARRAY_TYPE(16);r[0]=void 0!==a?a:1;r[4]=c||0;r[8]=b||0;r[12]=d||0;r[1]=e||0;r[5]=void 0!==f?f:1;r[9]=g||0;r[13]=h||0;r[2]=k||0;r[6]=l||0;r[10]=void 0!==n?n:1;r[14]=m||0;r[3]=p||0;r[7]=s||0;r[11]=q||0;r[15]=void 0!==u?u:1};
OIMO.Mat44.prototype={constructor:OIMO.Mat44,set:function(a,c,b,d,e,f,g,h,k,l,n,m,p,s,q,u){var r=this.elements;r[0]=a;r[4]=c;r[8]=b;r[12]=d;r[1]=e;r[5]=f;r[9]=g;r[13]=h;r[2]=k;r[6]=l;r[10]=n;r[14]=m;r[3]=p;r[7]=s;r[11]=q;r[15]=u;return this}};OIMO.Mat33=function(a,c,b,d,e,f,g,h,k){this.elements=new OIMO_ARRAY_TYPE(9);this.init(void 0!==a?a:1,c||0,b||0,d||0,void 0!==e?e:1,f||0,g||0,h||0,void 0!==k?k:1)};
OIMO.Mat33.prototype={constructor:OIMO.Mat33,set:function(a,c,b,d,e,f,g,h,k){var l=this.elements;l[0]=a;l[1]=c;l[2]=b;l[3]=d;l[4]=e;l[5]=f;l[6]=g;l[7]=h;l[8]=k;return this},init:function(a,c,b,d,e,f,g,h,k){var l=this.elements;l[0]=a;l[1]=c;l[2]=b;l[3]=d;l[4]=e;l[5]=f;l[6]=g;l[7]=h;l[8]=k;return this},multiply:function(a){var c=this.elements;c[0]*=a;c[1]*=a;c[2]*=a;c[3]*=a;c[4]*=a;c[5]*=a;c[6]*=a;c[7]*=a;c[8]*=a;return this},add:function(a,c){var b=this.elements,d=a.elements,e=c.elements;b[0]=d[0]+
e[0];b[1]=d[1]+e[1];b[2]=d[2]+e[2];b[3]=d[3]+e[3];b[4]=d[4]+e[4];b[5]=d[5]+e[5];b[6]=d[6]+e[6];b[7]=d[7]+e[7];b[8]=d[8]+e[8];return this},addEqual:function(a){var c=this.elements;a=a.elements;c[0]+=a[0];c[1]+=a[1];c[2]+=a[2];c[3]+=a[3];c[4]+=a[4];c[5]+=a[5];c[6]+=a[6];c[7]+=a[7];c[8]+=a[8];return this},sub:function(a,c){var b=this.elements,d=a.elements,e=c.elements;b[0]=d[0]-e[0];b[1]=d[1]-e[1];b[2]=d[2]-e[2];b[3]=d[3]-e[3];b[4]=d[4]-e[4];b[5]=d[5]-e[5];b[6]=d[6]-e[6];b[7]=d[7]-e[7];b[8]=d[8]-e[8];
return this},subEqual:function(a){var c=this.elements;a=a.elements;c[0]-=a[0];c[1]-=a[1];c[2]-=a[2];c[3]-=a[3];c[4]-=a[4];c[5]-=a[5];c[6]-=a[6];c[7]-=a[7];c[8]-=a[8];return this},scale:function(a,c){var b=this.elements,d=a.elements;b[0]=d[0]*c;b[1]=d[1]*c;b[2]=d[2]*c;b[3]=d[3]*c;b[4]=d[4]*c;b[5]=d[5]*c;b[6]=d[6]*c;b[7]=d[7]*c;b[8]=d[8]*c;return this},scaleEqual:function(a){var c=this.elements;c[0]*=a;c[1]*=a;c[2]*=a;c[3]*=a;c[4]*=a;c[5]*=a;c[6]*=a;c[7]*=a;c[8]*=a;return this},mul:function(a,c){var b=
this.elements,d=a.elements,e=c.elements,f=d[0],g=d[3],h=d[6],k=d[1],l=d[4],n=d[7],m=d[2],p=d[5],d=d[8],s=e[0],q=e[3],u=e[6],r=e[1],t=e[4],z=e[7],F=e[2],J=e[5],e=e[8];b[0]=f*s+k*q+m*u;b[1]=f*r+k*t+m*z;b[2]=f*F+k*J+m*e;b[3]=g*s+l*q+p*u;b[4]=g*r+l*t+p*z;b[5]=g*F+l*J+p*e;b[6]=h*s+n*q+d*u;b[7]=h*r+n*t+d*z;b[8]=h*F+n*J+d*e;return this},mulScale:function(a,c,b,d,e){var f=this.elements;a=a.elements;e?(f[0]=c*a[0],f[1]=c*a[1],f[2]=c*a[2],f[3]=b*a[3],f[4]=b*a[4],f[5]=b*a[5],f[6]=d*a[6],f[7]=d*a[7],f[8]=d*a[8]):
(f[0]=a[0]*c,f[1]=a[1]*b,f[2]=a[2]*d,f[3]=a[3]*c,f[4]=a[4]*b,f[5]=a[5]*d,f[6]=a[6]*c,f[7]=a[7]*b,f[8]=a[8]*d);return this},mulRotate:function(a,c,b,d,e,f){f=f||!1;var g=OIMO.sin(c),h=OIMO.cos(c),k=1-h;c=b*b*k+h;var l=b*d*k-e*g,n=b*e*k+d*g,m=d*b*k+e*g,p=d*d*k+h,s=d*e*k-b*g,q=e*b*k-d*g;b=e*d*k+b*g;e=e*e*k+h;var u=a.elements;a=u[0];d=u[3];var g=u[6],h=u[1],k=u[4],r=u[7],t=u[2],z=u[5],u=u[8],F=this.elements;f?(F[0]=c*a+l*d+n*g,F[1]=c*h+l*k+n*r,F[2]=c*t+l*z+n*u,F[3]=m*a+p*d+s*g,F[4]=m*h+p*k+s*r,F[5]=m*
t+p*z+s*u,F[6]=q*a+b*d+e*g,F[7]=q*h+b*k+e*r,F[8]=q*t+b*z+e*u):(F[0]=a*c+h*m+t*q,F[1]=a*l+h*p+t*b,F[2]=a*n+h*s+t*e,F[3]=d*c+k*m+z*q,F[4]=d*l+k*p+z*b,F[5]=d*n+k*s+z*e,F[6]=g*c+r*m+u*q,F[7]=g*l+r*p+u*b,F[8]=g*n+r*s+u*e);return this},transpose:function(a){var c=this.elements;a=a.elements;c[0]=a[0];c[1]=a[3];c[2]=a[6];c[3]=a[1];c[4]=a[4];c[5]=a[7];c[6]=a[2];c[7]=a[5];c[8]=a[8];return this},setQuat:function(a){var c=this.elements,b=2*a.x,d=2*a.y,e=2*a.z,f=a.x*b,g=a.y*d,h=a.z*e,k=a.x*d,l=a.y*e,n=a.x*e,b=
a.s*b,d=a.s*d;a=a.s*e;c[0]=1-g-h;c[1]=k-a;c[2]=n+d;c[3]=k+a;c[4]=1-f-h;c[5]=l-b;c[6]=n-d;c[7]=l+b;c[8]=1-f-g;return this},invert:function(a){var c=this.elements,b=a.elements;a=b[0];var d=b[3],e=b[6],f=b[1],g=b[4],h=b[7],k=b[2],l=b[5],b=b[8],n=g*b-h*l,m=h*k-f*b,p=f*l-g*k,s=a*n+d*m+e*p;0!=s&&(s=1/s);c[0]=s*n;c[1]=s*m;c[2]=s*p;c[3]=s*(l*e-d*b);c[4]=s*(a*b-k*e);c[5]=s*(k*d-a*l);c[6]=s*(d*h-g*e);c[7]=s*(f*e-a*h);c[8]=s*(a*g-f*d);return this},toEuler:function(){var a=this.elements,c=a[0],b=a[3],d=a[6],
e=a[4],f=a[7],g=a[5],a=a[8],h=new OIMO.Vec3;new OIMO.Quat;h.y=OIMO.asin(OIMO.min(OIMO.max(d,-1),1));0.99999>OIMO.abs(d)?(h.x=OIMO.atan2(-f,a),h.z=OIMO.atan2(-b,c)):(h.x=OIMO.atan2(g,e),h.z=0);return h},toString:function(){var a=this.elements;return"Mat33|"+a[0].toFixed(4)+", "+a[1].toFixed(4)+", "+a[2].toFixed(4)+"|\n     |"+a[3].toFixed(4)+", "+a[4].toFixed(4)+", "+a[5].toFixed(4)+"|\n     |"+a[6].toFixed(4)+", "+a[7].toFixed(4)+", "+a[8].toFixed(4)+"|"},multiplyScalar:function(a){var c=this.elements;
c[0]*=a;c[3]*=a;c[6]*=a;c[1]*=a;c[4]*=a;c[7]*=a;c[2]*=a;c[5]*=a;c[8]*=a;return this},identity:function(){this.set(1,0,0,0,1,0,0,0,1);return this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(a){a=a.elements;this.set(a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]);return this},fromArray:function(a){this.elements.set(a);return this},toArray:function(){var a=this.elements;return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8]]}};OIMO.Quat=function(a,c,b,d){this.s=void 0!==a?a:1;this.x=c||0;this.y=b||0;this.z=d||0};
OIMO.Quat.prototype={constructor:OIMO.Quat,set:function(a,c,b,d){this.x=a;this.y=c;this.z=b;this.s=d;return this},init:function(a,c,b,d){this.s=void 0!==a?a:1;this.x=c||0;this.y=b||0;this.z=d||0;return this},add:function(a,c){this.s=a.s+c.s;this.x=a.x+c.x;this.y=a.y+c.y;this.z=a.z+c.z;return this},addTime:function(a,c){var b=a.x,d=a.y,e=a.z,f=this.s,g=this.x,h=this.y,k=this.z;c*=0.5;var l=(b*f+d*k-e*h)*c,n=(-b*k+d*f+e*g)*c,m=(b*h-d*g+e*f)*c,f=f+(-b*g-d*h-e*k)*c,g=g+l,h=h+n,k=k+m,b=1/OIMO.sqrt(f*f+
g*g+h*h+k*k);this.s=f*b;this.x=g*b;this.y=h*b;this.z=k*b;return this},sub:function(a,c){this.s=a.s-c.s;this.x=a.x-c.x;this.y=a.y-c.y;this.z=a.z-c.z;return this},scale:function(a,c){this.s=a.s*c;this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},mul:function(a,c){var b=a.x,d=a.y,e=a.z,f=a.s,g=c.x,h=c.y,k=c.z,l=c.s;this.x=b*l+f*g+d*k-e*h;this.y=d*l+f*h+e*g-b*k;this.z=e*l+f*k+b*h-d*g;this.s=f*l-b*g-d*h-e*k;return this},arc:function(a,c){var b=a.x,d=a.y,e=a.z,f=c.x,g=c.y,h=c.z,k=b*f+d*g+e*h;if(-1==k)return f=
d*b-e*e,g=-e*d-b*b,h=b*e+d*d,k=1/OIMO.sqrt(f*f+g*g+h*h),this.s=0,this.x=f*k,this.y=g*k,this.z=h*k,this;var l=d*h-e*g,e=e*f-b*h,b=b*g-d*f;this.s=OIMO.sqrt(0.5*(1+k));k=0.5/this.s;this.x=l*k;this.y=e*k;this.z=b*k;return this},normalize:function(a){var c=OIMO.sqrt(a.s*a.s+a.x*a.x+a.y*a.y+a.z*a.z);0<c&&(c=1/c);this.s=a.s*c;this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},invert:function(a){this.s=a.s;this.x=-a.x;this.y=-a.y;this.z=-a.z;return this},length:function(){return OIMO.sqrt(this.s*this.s+
this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(a){this.s=a.s;this.x=a.x;this.y=a.y;this.z=a.z;return this},testDiff:function(a){return this.s!==a.s||this.x!==a.x||this.y!==a.y||this.z!==a.z?!0:!1},clone:function(a){return new OIMO.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}};OIMO.Quaternion=function(a,c,b,d){this.x=a||0;this.y=c||0;this.z=b||0;this.w=void 0!==d?d:1};
OIMO.Quaternion.prototype={constructor:OIMO.Quaternion,setFromRotationMatrix:function(a){var c=a.elements,b=c[0];a=c[1];var d=c[2],e=c[3],f=c[4],g=c[5],h=c[6],k=c[7],c=c[8],l=b+f+c;0<l?(b=0.5/OIMO.sqrt(l+1),this.w=0.25/b,this.x=(k-g)*b,this.y=(d-h)*b,this.z=(e-a)*b):b>f&&b>c?(b=2*OIMO.sqrt(1+b-f-c),this.w=(k-g)/b,this.x=0.25*b,this.y=(a+e)/b,this.z=(d+h)/b):f>c?(b=2*OIMO.sqrt(1+f-b-c),this.w=(d-h)/b,this.x=(a+e)/b,this.y=0.25*b,this.z=(g+k)/b):(b=2*OIMO.sqrt(1+c-b-f),this.w=(e-a)/b,this.x=(d+h)/b,
this.y=(g+k)/b,this.z=0.25*b);return this}};OIMO.Vec3=function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0};
OIMO.Vec3.prototype={constructor:OIMO.Vec3,init:function(a,c,b){this.x=a||0;this.y=c||0;this.z=b||0;return this},set:function(a,c,b){this.x=a;this.y=c;this.z=b;return this},add:function(a,c){this.x=a.x+c.x;this.y=a.y+c.y;this.z=a.z+c.z;return this},addEqual:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},addTime:function(a,c){this.x+=a.x*c;this.y+=a.y*c;this.z+=a.z*c;return this},sub:function(a,c){this.x=a.x-c.x;this.y=a.y-c.y;this.z=a.z-c.z;return this},subEqual:function(a){this.x-=
a.x;this.y-=a.y;this.z-=a.z;return this},addScale:function(a,c){this.x+=a.x*c;this.y+=a.y*c;this.z+=a.z*c;return this},scale:function(a,c){this.x=a.x*c;this.y=a.y*c;this.z=a.z*c;return this},scaleEqual:function(a){this.x*=a;this.y*=a;this.z*=a;return this},cross:function(a,c){var b=a.x,d=a.y,e=a.z,f=c.x,g=c.y,h=c.z;this.x=d*h-e*g;this.y=e*f-b*h;this.z=b*g-d*f;return this},mul:function(a,c,b){b=b.elements;this.x=a.x+c.x*b[0]+c.y*b[1]+c.z*b[2];this.y=a.y+c.x*b[3]+c.y*b[4]+c.z*b[5];this.z=a.z+c.x*b[6]+
c.y*b[7]+c.z*b[8];return this},mulMat:function(a,c){var b=a.elements;this.x=b[0]*c.x+b[1]*c.y+b[2]*c.z;this.y=b[3]*c.x+b[4]*c.y+b[5]*c.z;this.z=b[6]*c.x+b[7]*c.y+b[8]*c.z;return this},normalize:function(a){var c=a.x,b=a.y;a=a.z;var d=c*c+b*b+a*a;0<d&&(d=1/OIMO.sqrt(d),this.x=c*d,this.y=b*d,this.z=a*d);return this},invert:function(a){this.x=-a.x;this.y=-a.y;this.z=-a.z;return this},negate:function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this},dot:function(a){return this.x*a.x+this.y*
a.y+this.z*a.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return OIMO.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},applyQuaternion:function(a){var c=this.x,b=this.y,d=this.z,e=a.x,f=a.y,g=a.z;a=a.s;var h=a*c+f*d-g*b,k=a*b+g*c-e*d,l=a*d+e*b-f*c,c=-e*c-f*b-g*d;this.x=h*a+c*-e+k*-g-l*-f;this.y=k*a+c*-f+l*-e-h*-g;this.z=l*a+c*-g+h*-f-k*-e;return this},testZero:function(){return 0!==this.x||
0!==this.y||0!==this.z?!0:!1},testDiff:function(a){return a.x!==this.x||a.y!==this.y||a.z!==this.z},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(a){isFinite(a)?(this.x*=a,this.y*=a,this.z*=a):this.z=this.y=this.x=0;return this},divideScalar:function(a){return this.multiplyScalar(1/a)},
norm:function(){return this.divideScalar(this.length())}};OIMO.Euler=function(a,c,b,d){this._x=a||0;this._y=c||0;this._z=b||0;this._order=d||OIMO.Euler.DefaultOrder};OIMO.Euler.RotationOrders="XYZ YZX ZXY XZY YXZ ZYX".split(" ");OIMO.Euler.DefaultOrder="XYZ";OIMO.clamp=function(a,c,b){return a<c?c:a>b?b:a};
OIMO.Euler.prototype={constructor:OIMO.Euler,_x:0,_y:0,_z:0,_order:OIMO.Euler.DefaultOrder,get x(){return this._x},set x(a){this._x=a;this.onChangeCallback()},get y(){return this._y},set y(a){this._y=a;this.onChangeCallback()},get z(){return this._z},set z(a){this._z=a;this.onChangeCallback()},get order(){return this._order},set order(a){this._order=a;this.onChangeCallback()},set:function(a,c,b,d){this._x=a;this._y=c;this._z=b;this._order=d||this._order;this.onChangeCallback();return this},copy:function(a){this._x=
a._x;this._y=a._y;this._z=a._z;this._order=a._order;this.onChangeCallback();return this},setFromRotationMatrix:function(a,c){var b=OIMO.clamp,d=a.elements,e=d[0],f=d[1],g=d[2],h=d[3],k=d[4],l=d[5],n=d[6],m=d[7],d=d[8];c=c||this._order;"XYZ"===c?(this._y=OIMO.asin(b(g,-1,1)),0.99999>OIMO.abs(g)?(this._x=OIMO.atan2(-l,d),this._z=OIMO.atan2(-f,e)):(this._x=OIMO.atan2(m,k),this._z=0)):"YXZ"===c?(this._x=OIMO.asin(-b(l,-1,1)),0.99999>OIMO.abs(l)?(this._y=OIMO.atan2(g,d),this._z=OIMO.atan2(h,k)):(this._y=
OIMO.atan2(-n,e),this._z=0)):"ZXY"===c?(this._x=OIMO.asin(b(m,-1,1)),0.99999>OIMO.abs(m)?(this._y=OIMO.atan2(-n,d),this._z=OIMO.atan2(-f,k)):(this._y=0,this._z=OIMO.atan2(h,e))):"ZYX"===c?(this._y=OIMO.asin(-b(n,-1,1)),0.99999>OIMO.abs(n)?(this._x=OIMO.atan2(m,d),this._z=OIMO.atan2(h,e)):(this._x=0,this._z=OIMO.atan2(-f,k))):"YZX"===c?(this._z=OIMO.asin(b(h,-1,1)),0.99999>OIMO.abs(h)?(this._x=OIMO.atan2(-l,k),this._y=OIMO.atan2(-n,e)):(this._x=0,this._y=OIMO.atan2(g,d))):"XZY"===c?(this._z=OIMO.asin(-b(f,
-1,1)),0.99999>OIMO.abs(f)?(this._x=OIMO.atan2(m,k),this._y=OIMO.atan2(g,e)):(this._x=OIMO.atan2(-l,d),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+c);this._order=c;this.onChangeCallback();return this},setFromQuaternion:function(a,c,b){var d=OIMO.clamp,e=a.x*a.x,f=a.y*a.y,g=a.z*a.z,h=a.s*a.s;c=c||this._order;"XYZ"===c?(this._x=OIMO.atan2(2*(a.x*a.s-a.y*a.z),h-e-f+g),this._y=OIMO.asin(d(2*(a.x*a.z+a.y*a.s),-1,1)),this._z=OIMO.atan2(2*(a.z*a.s-a.x*a.y),
h+e-f-g)):"YXZ"===c?(this._x=OIMO.asin(d(2*(a.x*a.s-a.y*a.z),-1,1)),this._y=OIMO.atan2(2*(a.x*a.z+a.y*a.s),h-e-f+g),this._z=OIMO.atan2(2*(a.x*a.y+a.z*a.s),h-e+f-g)):"ZXY"===c?(this._x=OIMO.asin(d(2*(a.x*a.s+a.y*a.z),-1,1)),this._y=OIMO.atan2(2*(a.y*a.s-a.z*a.x),h-e-f+g),this._z=OIMO.atan2(2*(a.z*a.s-a.x*a.y),h-e+f-g)):"ZYX"===c?(this._x=OIMO.atan2(2*(a.x*a.s+a.z*a.y),h-e-f+g),this._y=OIMO.asin(d(2*(a.y*a.s-a.x*a.z),-1,1)),this._z=OIMO.atan2(2*(a.x*a.y+a.z*a.s),h+e-f-g)):"YZX"===c?(this._x=OIMO.atan2(2*
(a.x*a.s-a.z*a.y),h-e+f-g),this._y=OIMO.atan2(2*(a.y*a.s-a.x*a.z),h+e-f-g),this._z=OIMO.asin(d(2*(a.x*a.y+a.z*a.s),-1,1))):"XZY"===c?(this._x=OIMO.atan2(2*(a.x*a.s+a.y*a.z),h-e+f-g),this._y=OIMO.atan2(2*(a.x*a.z+a.y*a.s),h+e-f-g),this._z=OIMO.asin(d(2*(a.z*a.s-a.x*a.y),-1,1))):console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+c);this._order=c;if(!1!==b)this.onChangeCallback();return this},reorder:function(){var a=new OIMO.Quat;return function(c){a.setFromEuler(this);this.setFromQuaternion(a,
c)}}(),equals:function(a){return a._x===this._x&&a._y===this._y&&a._z===this._z&&a._order===this._order},fromArray:function(a){this._x=a[0];this._y=a[1];this._z=a[2];void 0!==a[3]&&(this._order=a[3]);this.onChangeCallback();return this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(a){this.onChangeCallback=a;return this},onChangeCallback:function(){},clone:function(){return new OIMO.Euler(this._x,this._y,this._z,this._order)}};OIMO.EulerToAxis=function(a,c,b){var d=OIMO.cos(0.5*c);c=OIMO.sin(0.5*c);var e=OIMO.cos(0.5*b),f=OIMO.sin(0.5*b),g=OIMO.cos(0.5*a),h=OIMO.sin(0.5*a),k=d*e,l=c*f;a=k*h+l*g;b=c*e*g+d*f*h;d=d*f*g-c*e*h;c=2*OIMO.acos(k*g-l*h);e=a*a+b*b+d*d;0.001>e?(a=1,b=d=0):(e=OIMO.sqrt(e),a/=e,b/=e,d/=e);return[c,a,b,d]};
OIMO.EulerToMatrix=function(a,c,b){var d=OIMO.cos(c);c=OIMO.sin(c);var e=OIMO.cos(b);b=OIMO.sin(b);var f=OIMO.cos(a);a=OIMO.sin(a);var g=new OIMO.Mat33,h=g.elements;h[0]=d*e;h[1]=c*a-d*b*f;h[2]=d*b*a+c*f;h[3]=b;h[4]=e*f;h[5]=-e*a;h[6]=-c*e;h[7]=c*b*f+d*a;h[8]=-c*b*a+d*f;return g};
OIMO.MatrixToEuler=function(a){var c=a.elements,b;0.998<c[3]?(b=OIMO.atan2(c[2],c[8]),c=OIMO.PI/2,a=0):-0.998>c[3]?(b=OIMO.atan2(c[2],c[8]),c=-OIMO.PI/2,a=0):(b=OIMO.atan2(-c[6],c[0]),a=OIMO.atan2(-c[5],c[4]),c=OIMO.asin(c[3]));return[a,b,c]};OIMO.unwrapDegrees=function(a){a%=360;180<a&&(a-=360);-180>a&&(a+=360);return a};OIMO.unwrapRadian=function(a){a%=OIMO.TwoPI;a>OIMO.PI&&(a-=OIMO.TwoPI);a<-OIMO.PI&&(a+=OIMO.TwoPI);return a};OIMO.Distance3d=function(a,c){var b=c[0]-a[0],d=c[1]-a[1],e=c[2]-a[2];return OIMO.sqrt(b*b+d*d+e*e)};OIMO.Constraint=function(){this.body2=this.body1=this.parent=null;this.addedToIsland=!1};OIMO.Constraint.prototype={constructor:OIMO.Constraint,preSolve:function(a,c){OIMO.Error("Constraint","Inheritance error.")},solve:function(){OIMO.Error("Constraint","Inheritance error.")},postSolve:function(){OIMO.Error("Constraint","Inheritance error.")}};OIMO.Joint=function(a){OIMO.Constraint.call(this);this.name="";this.type=OIMO.JOINT_NULL;this.next=this.prev=null;this.body1=a.body1;this.body2=a.body2;this.localAnchorPoint1=(new OIMO.Vec3).copy(a.localAnchorPoint1);this.localAnchorPoint2=(new OIMO.Vec3).copy(a.localAnchorPoint2);this.relativeAnchorPoint1=new OIMO.Vec3;this.relativeAnchorPoint2=new OIMO.Vec3;this.anchorPoint1=new OIMO.Vec3;this.anchorPoint2=new OIMO.Vec3;this.allowCollision=a.allowCollision;this.b1Link=new OIMO.JointLink(this);this.b2Link=
new OIMO.JointLink(this);this.matrix=new OIMO.Mat44};OIMO.Joint.prototype=Object.create(OIMO.Constraint.prototype);OIMO.Joint.prototype.constructor=OIMO.Joint;OIMO.Joint.prototype.updateAnchorPoints=function(){this.relativeAnchorPoint1.mulMat(this.body1.rotation,this.localAnchorPoint1);this.relativeAnchorPoint2.mulMat(this.body2.rotation,this.localAnchorPoint2);this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position);this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)};
OIMO.Joint.prototype.attach=function(){this.b1Link.body=this.body2;this.b2Link.body=this.body1;null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null;this.body1.jointLink=this.b1Link;this.body1.numJoints++;null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null;this.body2.jointLink=this.b2Link;this.body2.numJoints++};
OIMO.Joint.prototype.detach=function(){var a=this.b1Link.prev,c=this.b1Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body1.jointLink==this.b1Link&&(this.body1.jointLink=c);this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.body=null;this.body1.numJoints--;a=this.b2Link.prev;c=this.b2Link.next;null!=a&&(a.next=c);null!=c&&(c.prev=a);this.body2.jointLink==this.b2Link&&(this.body2.jointLink=c);this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.body=null;this.body2.numJoints--;this.b1Link.body=
null;this.b2Link.body=null};OIMO.Joint.prototype.awake=function(){this.body1.awake();this.body2.awake()};OIMO.Joint.prototype.preSolve=function(a,c){};OIMO.Joint.prototype.solve=function(){};OIMO.Joint.prototype.postSolve=function(){};OIMO.Joint.prototype.remove=function(){this.dispose()};OIMO.Joint.prototype.dispose=function(){this.parent.removeJoint(this)};
OIMO.Joint.prototype.getPosition=function(){var a=(new OIMO.Vec3).scale(this.anchorPoint1,OIMO.WORLD_SCALE),c=(new OIMO.Vec3).scale(this.anchorPoint2,OIMO.WORLD_SCALE);return[a,c]};OIMO.Joint.prototype.getMatrix=function(){var a=this.matrix.elements,c=this.anchorPoint1,b=this.anchorPoint2;a[0]=c.x*OIMO.WORLD_SCALE;a[1]=c.y*OIMO.WORLD_SCALE;a[2]=c.z*OIMO.WORLD_SCALE;a[3]=0;a[4]=b.x*OIMO.WORLD_SCALE;a[5]=b.y*OIMO.WORLD_SCALE;a[6]=b.z*OIMO.WORLD_SCALE;a[7]=0;return a};OIMO.JointConfig=function(){this.body2=this.body1=null;this.localAnchorPoint1=new OIMO.Vec3;this.localAnchorPoint2=new OIMO.Vec3;this.localAxis1=new OIMO.Vec3;this.localAxis2=new OIMO.Vec3;this.allowCollision=!1};OIMO.JointLink=function(a){this.body=this.next=this.prev=null;this.joint=a};OIMO.LimitMotor=function(a,c){this.axis=a;this.angle=0;this.lowerLimit=c?0:1;this.dampingRatio=this.frequency=this.maxMotorForce=this.motorSpeed=this.upperLimit=0};OIMO.LimitMotor.prototype={constructor:OIMO.LimitMotor,setLimit:function(a,c){this.lowerLimit=a;this.upperLimit=c},setMotor:function(a,c){this.motorSpeed=a;this.maxMotorForce=c},setSpring:function(a,c){this.frequency=a;this.dampingRatio=c}};OIMO.BallAndSocketJoint=function(a){OIMO.Joint.call(this,a);this.type=OIMO.JOINT_BALL_AND_SOCKET;this.lc=new OIMO.LinearConstraint(this)};OIMO.BallAndSocketJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.BallAndSocketJoint.prototype.constructor=OIMO.BallAndSocketJoint;OIMO.BallAndSocketJoint.prototype.preSolve=function(a,c){this.updateAnchorPoints();this.lc.preSolve(a,c)};OIMO.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()};OIMO.BallAndSocketJoint.prototype.postSolve=function(){};OIMO.DistanceJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=OIMO.JOINT_DISTANCE;this.normal=new OIMO.Vec3;this.nr=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.normal,!0);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.t=new OIMO.TranslationalConstraint(this,this.limitMotor)};OIMO.DistanceJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.DistanceJoint.prototype.constructor=OIMO.DistanceJoint;
OIMO.DistanceJoint.prototype.preSolve=function(a,c){this.updateAnchorPoints();this.nr.sub(this.anchorPoint2,this.anchorPoint1);this.normal.normalize(this.nr);this.t.preSolve(a,c)};OIMO.DistanceJoint.prototype.solve=function(){this.t.solve()};OIMO.DistanceJoint.prototype.postSolve=function(){};OIMO.HingeJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=OIMO.JOINT_HINGE;this.localAxis1=a.localAxis1.clone().norm();this.localAxis2=a.localAxis2.clone().norm();this.localAngle1=(new OIMO.Vec3(this.localAxis1.y*this.localAxis1.x-this.localAxis1.z*this.localAxis1.z,-this.localAxis1.z*this.localAxis1.y-this.localAxis1.x*this.localAxis1.x,this.localAxis1.x*this.localAxis1.z+this.localAxis1.y*this.localAxis1.y)).norm();a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2));
this.localAngle2=(new OIMO.Vec3).mulMat(a,this.localAngle1);this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.ax1=new OIMO.Vec3;this.ax2=new OIMO.Vec3;this.an1=new OIMO.Vec3;this.an2=new OIMO.Vec3;this.limitMotor=new OIMO.LimitMotor(this.nor,!1);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.lc=new OIMO.LinearConstraint(this);this.r3=new OIMO.Rotational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};
OIMO.HingeJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.HingeJoint.prototype.constructor=OIMO.HingeJoint;
OIMO.HingeJoint.prototype.preSolve=function(a,c){var b,d,e;this.updateAnchorPoints();this.ax1.mulMat(this.body1.rotation,this.localAxis1);this.ax2.mulMat(this.body2.rotation,this.localAxis2);this.an1.mulMat(this.body1.rotation,this.localAngle1);this.an2.mulMat(this.body2.rotation,this.localAngle2);this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).norm();
this.tan.set(this.nor.y*this.nor.x-this.nor.z*this.nor.z,-this.nor.z*this.nor.y-this.nor.x*this.nor.x,this.nor.x*this.nor.z+this.nor.y*this.nor.y).norm();this.bin.set(this.nor.y*this.tan.z-this.nor.z*this.tan.y,this.nor.z*this.tan.x-this.nor.x*this.tan.z,this.nor.x*this.tan.y-this.nor.y*this.tan.x);b=this.acosClamp(this.an1.x*this.an2.x+this.an1.y*this.an2.y+this.an1.z*this.an2.z);this.limitMotor.angle=0>this.nor.x*(this.an1.y*this.an2.z-this.an1.z*this.an2.y)+this.nor.y*(this.an1.z*this.an2.x-this.an1.x*
this.an2.z)+this.nor.z*(this.an1.x*this.an2.y-this.an1.y*this.an2.x)?-b:b;b=this.ax1.y*this.ax2.z-this.ax1.z*this.ax2.y;d=this.ax1.z*this.ax2.x-this.ax1.x*this.ax2.z;e=this.ax1.x*this.ax2.y-this.ax1.y*this.ax2.x;this.r3.limitMotor2.angle=this.tan.x*b+this.tan.y*d+this.tan.z*e;this.r3.limitMotor3.angle=this.bin.x*b+this.bin.y*d+this.bin.z*e;this.r3.preSolve(a,c);this.lc.preSolve(a,c)};OIMO.HingeJoint.prototype.solve=function(){this.r3.solve();this.lc.solve()};OIMO.HingeJoint.prototype.postSolve=function(){};
OIMO.HingeJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?OIMO.PI:OIMO.acos(a)};OIMO.PrismaticJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=OIMO.JOINT_PRISMATIC;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.ac=new OIMO.AngularConstraint(this,
(new OIMO.Quat).arc(this.localAxis1,this.localAxis2));this.limitMotor=new OIMO.LimitMotor(this.nor,!0);this.limitMotor.lowerLimit=c;this.limitMotor.upperLimit=b;this.t3=new OIMO.Translational3Constraint(this,this.limitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.PrismaticJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.PrismaticJoint.prototype.constructor=OIMO.PrismaticJoint;
OIMO.PrismaticJoint.prototype.preSolve=function(a,c){var b,d;this.updateAnchorPoints();b=this.body1.rotation.elements;var e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2],f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5],g=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];b=this.body2.rotation.elements;e=e*this.body2.inverseMass+(this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2])*this.body1.inverseMass;f=f*this.body2.inverseMass+
(this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5])*this.body1.inverseMass;b=g*this.body2.inverseMass+(this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8])*this.body1.inverseMass;d=OIMO.sqrt(e*e+f*f+b*b);0<d&&(d=1/d);e*=d;f*=d;b*=d;var g=f*e-b*b,h=-b*f-e*e,k=e*b+f*f;d=1/OIMO.sqrt(g*g+h*h+k*k);g*=d;h*=d;k*=d;d=f*k-b*h;var l=b*g-e*k,n=e*h-f*g;this.nor.init(e,f,b);this.tan.init(g,h,k);this.bin.init(d,l,n);this.ac.preSolve(a,c);this.t3.preSolve(a,c)};
OIMO.PrismaticJoint.prototype.solve=function(){this.ac.solve();this.t3.solve()};OIMO.PrismaticJoint.prototype.postSolve=function(){};OIMO.SliderJoint=function(a,c,b){OIMO.Joint.call(this,a);this.type=OIMO.JOINT_SLIDER;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z;this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X;this.localAngAxis1Z=this.localAxis1X*
this.localAxis1Z+this.localAxis1Y*this.localAxis1Y;a=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z);this.localAngAxis1X*=a;this.localAngAxis1Y*=a;this.localAngAxis1Z*=a;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements;this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*
a[1]+this.localAngAxis1Z*a[2];this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5];this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8];this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.rotationalLimitMotor=new OIMO.LimitMotor(this.nor,!1);this.r3=new OIMO.Rotational3Constraint(this,this.rotationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0));this.translationalLimitMotor=
new OIMO.LimitMotor(this.nor,!0);this.translationalLimitMotor.lowerLimit=c;this.translationalLimitMotor.upperLimit=b;this.t3=new OIMO.Translational3Constraint(this,this.translationalLimitMotor,new OIMO.LimitMotor(this.tan,!0),new OIMO.LimitMotor(this.bin,!0))};OIMO.SliderJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.SliderJoint.prototype.constructor=OIMO.SliderJoint;
OIMO.SliderJoint.prototype.preSolve=function(a,c){var b,d,e;this.updateAnchorPoints();b=this.body1.rotation.elements;e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2];var f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5];d=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];var g=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2],h=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],k=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var l=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],n=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],m=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],p=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],s=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5],q=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8],u=e*this.body2.inverseMass+l*this.body1.inverseMass,r=f*this.body2.inverseMass+n*this.body1.inverseMass,t=d*this.body2.inverseMass+m*this.body1.inverseMass;b=OIMO.sqrt(u*u+r*r+t*t);0<b&&(b=1/b);var u=u*b,r=r*b,t=t*b,z=r*u-t*t,F=-t*r-u*u,J=u*t+r*r;b=1/OIMO.sqrt(z*z+F*F+J*J);var z=z*b,F=F*b,J=J*b,H=r*J-t*F,B=t*z-u*J,I=u*F-r*z;this.nor.init(u,r,t);this.tan.init(z,F,J);this.bin.init(H,B,I);this.rotationalLimitMotor.angle=0>u*(h*q-k*s)+r*(k*p-g*q)+t*(g*s-h*p)?-this.acosClamp(g*p+h*s+k*q):this.acosClamp(g*
p+h*s+k*q);b=f*m-d*n;d=d*l-e*m;e=e*n-f*l;this.r3.limitMotor2.angle=z*b+F*d+J*e;this.r3.limitMotor3.angle=H*b+B*d+I*e;this.r3.preSolve(a,c);this.t3.preSolve(a,c)};OIMO.SliderJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.SliderJoint.prototype.postSolve=function(){};OIMO.SliderJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?OIMO.PI:OIMO.acos(a)};OIMO.WheelJoint=function(a){OIMO.Joint.call(this,a);this.type=OIMO.JOINT_WHEEL;this.localAxis1=(new OIMO.Vec3).normalize(a.localAxis1);this.localAxis2=(new OIMO.Vec3).normalize(a.localAxis2);this.localAxis1X=this.localAxis1.x;this.localAxis1Y=this.localAxis1.y;this.localAxis1Z=this.localAxis1.z;this.localAxis2X=this.localAxis2.x;this.localAxis2Y=this.localAxis2.y;this.localAxis2Z=this.localAxis2.z;a=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;
-1<a&&1>a?(this.localAngAxis1X=this.localAxis2X-a*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-a*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-a*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-a*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-a*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-a*this.localAxis2Z,a=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=
a,this.localAngAxis1Y*=a,this.localAngAxis1Z*=a,a=1/OIMO.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=a,this.localAngAxis2Y*=a,this.localAngAxis2Z*=a):(this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*
this.localAxis1Y,a=1/OIMO.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=a,this.localAngAxis1Y*=a,this.localAngAxis1Z*=a,a=(new OIMO.Mat33).setQuat((new OIMO.Quat).arc(this.localAxis1,this.localAxis2)).elements,this.localAngAxis2X=this.localAngAxis1X*a[0]+this.localAngAxis1Y*a[1]+this.localAngAxis1Z*a[2],this.localAngAxis2Y=this.localAngAxis1X*a[3]+this.localAngAxis1Y*a[4]+this.localAngAxis1Z*a[5],
this.localAngAxis2Z=this.localAngAxis1X*a[6]+this.localAngAxis1Y*a[7]+this.localAngAxis1Z*a[8]);this.nor=new OIMO.Vec3;this.tan=new OIMO.Vec3;this.bin=new OIMO.Vec3;this.translationalLimitMotor=new OIMO.LimitMotor(this.tan,!0);this.translationalLimitMotor.frequency=8;this.translationalLimitMotor.dampingRatio=1;this.rotationalLimitMotor1=new OIMO.LimitMotor(this.tan,!1);this.rotationalLimitMotor2=new OIMO.LimitMotor(this.bin,!1);this.t3=new OIMO.Translational3Constraint(this,new OIMO.LimitMotor(this.nor,
!0),this.translationalLimitMotor,new OIMO.LimitMotor(this.bin,!0));this.t3.weight=1;this.r3=new OIMO.Rotational3Constraint(this,new OIMO.LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)};OIMO.WheelJoint.prototype=Object.create(OIMO.Joint.prototype);OIMO.WheelJoint.prototype.constructor=OIMO.WheelJoint;
OIMO.WheelJoint.prototype.preSolve=function(a,c){var b,d;this.updateAnchorPoints();b=this.body1.rotation.elements;var e=this.localAxis1X*b[0]+this.localAxis1Y*b[1]+this.localAxis1Z*b[2],f=this.localAxis1X*b[3]+this.localAxis1Y*b[4]+this.localAxis1Z*b[5],g=this.localAxis1X*b[6]+this.localAxis1Y*b[7]+this.localAxis1Z*b[8];d=this.localAngAxis1X*b[0]+this.localAngAxis1Y*b[1]+this.localAngAxis1Z*b[2];var h=this.localAngAxis1X*b[3]+this.localAngAxis1Y*b[4]+this.localAngAxis1Z*b[5],k=this.localAngAxis1X*
b[6]+this.localAngAxis1Y*b[7]+this.localAngAxis1Z*b[8];b=this.body2.rotation.elements;var l=this.localAxis2X*b[0]+this.localAxis2Y*b[1]+this.localAxis2Z*b[2],n=this.localAxis2X*b[3]+this.localAxis2Y*b[4]+this.localAxis2Z*b[5],m=this.localAxis2X*b[6]+this.localAxis2Y*b[7]+this.localAxis2Z*b[8],p=this.localAngAxis2X*b[0]+this.localAngAxis2Y*b[1]+this.localAngAxis2Z*b[2],s=this.localAngAxis2X*b[3]+this.localAngAxis2Y*b[4]+this.localAngAxis2Z*b[5];b=this.localAngAxis2X*b[6]+this.localAngAxis2Y*b[7]+this.localAngAxis2Z*
b[8];this.r3.limitMotor1.angle=e*l+f*n+g*m;this.rotationalLimitMotor1.angle=0>e*(h*m-k*n)+f*(k*l-d*m)+g*(d*n-h*l)?-this.acosClamp(d*l+h*n+k*m):this.acosClamp(d*l+h*n+k*m);this.rotationalLimitMotor2.angle=0>l*(s*g-b*f)+n*(b*e-p*g)+m*(p*f-s*e)?this.acosClamp(p*e+s*f+b*g):-this.acosClamp(p*e+s*f+b*g);h=n*g-m*f;k=m*e-l*g;p=l*f-n*e;d=OIMO.sqrt(h*h+k*k+p*p);0<d&&(d=1/d);h*=d;k*=d;p*=d;s=k*m-p*n;m=p*l-h*m;l=h*n-k*l;d=OIMO.sqrt(s*s+m*m+l*l);0<d&&(d=1/d);s*=d;m*=d;l*=d;n=f*p-g*k;g=g*h-e*p;e=e*k-f*h;d=OIMO.sqrt(n*
n+g*g+e*e);0<d&&(d=1/d);n*=d;g*=d;e*=d;this.nor.init(h,k,p);this.tan.init(s,m,l);this.bin.init(n,g,e);this.r3.preSolve(a,c);this.t3.preSolve(a,c)};OIMO.WheelJoint.prototype.solve=function(){this.r3.solve();this.t3.solve()};OIMO.WheelJoint.prototype.postSolve=function(){};OIMO.WheelJoint.prototype.acosClamp=function(a){return 1<a?0:-1>a?OIMO.PI:OIMO.acos(a)};OIMO.AngularConstraint=function(a,c){this.joint=a;this.targetOrientation=(new OIMO.Quat).invert(c);this.relativeOrientation=new OIMO.Quat;this.dd=this.ii2=this.ii1=null;this.vel=new OIMO.Vec3;this.imp=new OIMO.Vec3;this.rn0=new OIMO.Vec3;this.rn1=new OIMO.Vec3;this.rn2=new OIMO.Vec3;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia};
OIMO.AngularConstraint.prototype={constructor:OIMO.AngularConstraint,preSolve:function(a,c){var b,d;this.ii1=this.i1.clone();this.ii2=this.i2.clone();d=(new OIMO.Mat33).add(this.ii1,this.ii2).elements;b=1/(d[0]*(d[4]*d[8]-d[7]*d[5])+d[3]*(d[7]*d[2]-d[1]*d[8])+d[6]*(d[1]*d[5]-d[4]*d[2]));this.dd=(new OIMO.Mat33(d[4]*d[8]-d[5]*d[7],d[2]*d[7]-d[1]*d[8],d[1]*d[5]-d[2]*d[4],d[5]*d[6]-d[3]*d[8],d[0]*d[8]-d[2]*d[6],d[2]*d[3]-d[0]*d[5],d[3]*d[7]-d[4]*d[6],d[1]*d[6]-d[0]*d[7],d[0]*d[4]-d[1]*d[3])).multiply(b);
this.relativeOrientation.invert(this.b1.orientation);this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation);this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation);b=2*this.relativeOrientation.s;this.vel.scale(this.relativeOrientation,b);b=this.vel.length();0.02<b?this.vel.scaleEqual((0.02-b)/b*c*0.05):this.vel.init();this.rn1.mulMat(this.ii1,this.imp);this.rn2.mulMat(this.ii2,this.imp);this.a1.addEqual(this.rn1);this.a2.subEqual(this.rn2)},solve:function(){var a=
this.a2.clone().subEqual(this.a1).subEqual(this.vel);this.rn0.mulMat(this.dd,a);this.rn1.mulMat(this.ii1,this.rn0);this.rn2.mulMat(this.ii2,this.rn0);this.imp.addEqual(this.rn0);this.a1.addEqual(this.rn1);this.a2.subEqual(this.rn2)}};OIMO.LinearConstraint=function(a){this.m2=this.m1=NaN;this.dd=this.ii2=this.ii1=null;this.velz=this.vely=this.velx=this.vel=this.az2z=this.az2y=this.az2x=this.ay2z=this.ay2y=this.ay2x=this.ax2z=this.ax2y=this.ax2x=this.az1z=this.az1y=this.az1x=this.ay1z=this.ay1y=this.ay1x=this.ax1z=this.ax1y=this.ax1x=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=NaN;this.joint=a;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.b1=a.body1;this.b2=
a.body2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.impz=this.impy=this.impx=0};
OIMO.LinearConstraint.prototype={constructor:OIMO.LinearConstraint,preSolve:function(a,c){this.r1x=this.r1.x;this.r1y=this.r1.y;this.r1z=this.r1.z;this.r2x=this.r2.x;this.r2y=this.r2.y;this.r2z=this.r2.z;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;this.ii1=this.i1.clone();this.ii2=this.i2.clone();var b=this.ii1.elements,d=this.ii2.elements;this.ax1x=this.r1z*b[1]+-this.r1y*b[2];this.ax1y=this.r1z*b[4]+-this.r1y*b[5];this.ax1z=this.r1z*b[7]+-this.r1y*b[8];this.ay1x=-this.r1z*b[0]+this.r1x*
b[2];this.ay1y=-this.r1z*b[3]+this.r1x*b[5];this.ay1z=-this.r1z*b[6]+this.r1x*b[8];this.az1x=this.r1y*b[0]+-this.r1x*b[1];this.az1y=this.r1y*b[3]+-this.r1x*b[4];this.az1z=this.r1y*b[6]+-this.r1x*b[7];this.ax2x=this.r2z*d[1]+-this.r2y*d[2];this.ax2y=this.r2z*d[4]+-this.r2y*d[5];this.ax2z=this.r2z*d[7]+-this.r2y*d[8];this.ay2x=-this.r2z*d[0]+this.r2x*d[2];this.ay2y=-this.r2z*d[3]+this.r2x*d[5];this.ay2z=-this.r2z*d[6]+this.r2x*d[8];this.az2x=this.r2y*d[0]+-this.r2x*d[1];this.az2y=this.r2y*d[3]+-this.r2x*
d[4];this.az2z=this.r2y*d[6]+-this.r2x*d[7];var e=this.m1+this.m2,e=(new OIMO.Mat33(e,0,0,0,e,0,0,0,e)).elements;e[0]+=b[4]*this.r1z*this.r1z-(b[7]+b[5])*this.r1y*this.r1z+b[8]*this.r1y*this.r1y;e[1]+=(b[6]*this.r1y+b[5]*this.r1x)*this.r1z-b[3]*this.r1z*this.r1z-b[8]*this.r1x*this.r1y;e[2]+=(b[3]*this.r1y-b[4]*this.r1x)*this.r1z-b[6]*this.r1y*this.r1y+b[7]*this.r1x*this.r1y;e[3]+=(b[2]*this.r1y+b[7]*this.r1x)*this.r1z-b[1]*this.r1z*this.r1z-b[8]*this.r1x*this.r1y;e[4]+=b[0]*this.r1z*this.r1z-(b[6]+
b[2])*this.r1x*this.r1z+b[8]*this.r1x*this.r1x;e[5]+=(b[1]*this.r1x-b[0]*this.r1y)*this.r1z-b[7]*this.r1x*this.r1x+b[6]*this.r1x*this.r1y;e[6]+=(b[1]*this.r1y-b[4]*this.r1x)*this.r1z-b[2]*this.r1y*this.r1y+b[5]*this.r1x*this.r1y;e[7]+=(b[3]*this.r1x-b[0]*this.r1y)*this.r1z-b[5]*this.r1x*this.r1x+b[2]*this.r1x*this.r1y;e[8]+=b[0]*this.r1y*this.r1y-(b[3]+b[1])*this.r1x*this.r1y+b[4]*this.r1x*this.r1x;e[0]+=d[4]*this.r2z*this.r2z-(d[7]+d[5])*this.r2y*this.r2z+d[8]*this.r2y*this.r2y;e[1]+=(d[6]*this.r2y+
d[5]*this.r2x)*this.r2z-d[3]*this.r2z*this.r2z-d[8]*this.r2x*this.r2y;e[2]+=(d[3]*this.r2y-d[4]*this.r2x)*this.r2z-d[6]*this.r2y*this.r2y+d[7]*this.r2x*this.r2y;e[3]+=(d[2]*this.r2y+d[7]*this.r2x)*this.r2z-d[1]*this.r2z*this.r2z-d[8]*this.r2x*this.r2y;e[4]+=d[0]*this.r2z*this.r2z-(d[6]+d[2])*this.r2x*this.r2z+d[8]*this.r2x*this.r2x;e[5]+=(d[1]*this.r2x-d[0]*this.r2y)*this.r2z-d[7]*this.r2x*this.r2x+d[6]*this.r2x*this.r2y;e[6]+=(d[1]*this.r2y-d[4]*this.r2x)*this.r2z-d[2]*this.r2y*this.r2y+d[5]*this.r2x*
this.r2y;e[7]+=(d[3]*this.r2x-d[0]*this.r2y)*this.r2z-d[5]*this.r2x*this.r2x+d[2]*this.r2x*this.r2y;e[8]+=d[0]*this.r2y*this.r2y-(d[3]+d[1])*this.r2x*this.r2y+d[4]*this.r2x*this.r2x;b=1/(e[0]*(e[4]*e[8]-e[7]*e[5])+e[3]*(e[7]*e[2]-e[1]*e[8])+e[6]*(e[1]*e[5]-e[4]*e[2]));this.dd=(new OIMO.Mat33(e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3])).multiply(b);this.velx=this.p2.x-
this.p1.x;this.vely=this.p2.y-this.p1.y;this.velz=this.p2.z-this.p1.z;b=OIMO.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);0.005<b?(b=(0.005-b)/b*c*0.05,this.velx*=b,this.vely*=b,this.velz*=b):this.velz=this.vely=this.velx=0;this.impx*=0.95;this.impy*=0.95;this.impz*=0.95;this.l1.x+=this.impx*this.m1;this.l1.y+=this.impy*this.m1;this.l1.z+=this.impz*this.m1;this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x;this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+
this.impz*this.az1y;this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z;this.l2.x-=this.impx*this.m2;this.l2.y-=this.impy*this.m2;this.l2.z-=this.impz*this.m2;this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x;this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y;this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var a=this.dd.elements,c=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*
this.r1z+this.a1.z*this.r1y-this.velx,b=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,d=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,e=c*a[0]+b*a[1]+d*a[2],f=c*a[3]+b*a[4]+d*a[5],a=c*a[6]+b*a[7]+d*a[8];this.impx+=e;this.impy+=f;this.impz+=a;this.l1.x+=e*this.m1;this.l1.y+=f*this.m1;this.l1.z+=a*this.m1;this.a1.x+=e*this.ax1x+f*this.ay1x+a*this.az1x;this.a1.y+=e*this.ax1y+f*this.ay1y+
a*this.az1y;this.a1.z+=e*this.ax1z+f*this.ay1z+a*this.az1z;this.l2.x-=e*this.m2;this.l2.y-=f*this.m2;this.l2.z-=a*this.m2;this.a2.x-=e*this.ax2x+f*this.ay2x+a*this.az2x;this.a2.y-=e*this.ax2y+f*this.ay2y+a*this.az2y;this.a2.z-=e*this.ax2z+f*this.ay2z+a*this.az2z}};OIMO.Rotational3Constraint=function(a,c,b,d){this.limitVelocity1=this.upperLimit1=this.lowerLimit1=this.a2z3=this.a2y3=this.a2x3=this.a1z3=this.a1y3=this.a1x3=this.a2z2=this.a2y2=this.a2x2=this.a1z2=this.a1y2=this.a1x2=this.a2z1=this.a2y1=this.a2x1=this.a1z1=this.a1y1=this.a1x1=this.az3=this.ay3=this.ax3=this.az2=this.ay2=this.ax2=this.az1=this.ay1=this.ax1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=
this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.cfm3=this.cfm2=this.cfm1=NaN;this.limitState1=0;this.enableMotor1=!1;this.limitVelocity2=this.upperLimit2=this.lowerLimit2=this.maxMotorImpulse1=this.maxMotorForce1=this.motorSpeed1=NaN;this.limitState2=0;this.enableMotor2=!1;this.limitVelocity3=this.upperLimit3=this.lowerLimit3=this.maxMotorImpulse2=this.maxMotorForce2=this.motorSpeed2=NaN;this.limitState3=0;this.enableMotor3=!1;this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=
this.d01=this.d00=this.dv22=this.dv11=this.dv00=this.kv22=this.kv11=this.kv00=this.k22=this.k21=this.k20=this.k12=this.k11=this.k10=this.k02=this.k01=this.k00=this.maxMotorImpulse3=this.maxMotorForce3=this.motorSpeed3=NaN;this.limitMotor1=c;this.limitMotor2=b;this.limitMotor3=d;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.motorImpulse3=this.limitImpulse3=this.motorImpulse2=this.limitImpulse2=
this.motorImpulse1=this.limitImpulse1=0};
OIMO.Rotational3Constraint.prototype={constructor:OIMO.Rotational3Constraint,preSolve:function(a,c){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=
this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=0<this.maxMotorForce1;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=0<this.maxMotorForce2;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;
this.enableMotor3=0<this.maxMotorForce3;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var e=this.limitMotor1.frequency,b=this.limitMotor2.frequency,d=this.limitMotor3.frequency,f=0<e,g=0<b,h=0<d,k=this.lowerLimit2<=this.upperLimit2,
l=this.lowerLimit3<=this.upperLimit3,n=this.limitMotor1.angle;this.lowerLimit1<=this.upperLimit1?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitImpulse1=this.limitState1=0),this.limitVelocity1=this.lowerLimit1-n):n<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-n):n>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-n):(this.limitState1=
2,this.limitVelocity1=this.limitImpulse1=0),f||(this.limitVelocity1=0.02<this.limitVelocity1?this.limitVelocity1-0.02:-0.02>this.limitVelocity1?this.limitVelocity1+0.02:0)):(this.limitState1=2,this.limitImpulse1=0);n=this.limitMotor2.angle;k?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitImpulse2=this.limitState2=0),this.limitVelocity2=this.lowerLimit2-n):n<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-
n):n>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-n):(this.limitState2=2,this.limitVelocity2=this.limitImpulse2=0),g||(this.limitVelocity2=0.02<this.limitVelocity2?this.limitVelocity2-0.02:-0.02>this.limitVelocity2?this.limitVelocity2+0.02:0)):(this.limitState2=2,this.limitImpulse2=0);k=this.limitMotor3.angle;l?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitImpulse3=this.limitState3=0),this.limitVelocity3=
this.lowerLimit3-k):k<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-k):k>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-k):(this.limitState3=2,this.limitVelocity3=this.limitImpulse3=0),h||(this.limitVelocity3=0.02<this.limitVelocity3?this.limitVelocity3-0.02:-0.02>this.limitVelocity3?this.limitVelocity3+0.02:0)):(this.limitState3=2,this.limitImpulse3=0);
this.maxMotorImpulse1=this.enableMotor1&&(0!=this.limitState1||f)?this.maxMotorForce1*a:this.motorImpulse1=0;this.maxMotorImpulse2=this.enableMotor2&&(0!=this.limitState2||g)?this.maxMotorForce2*a:this.motorImpulse2=0;this.maxMotorImpulse3=this.enableMotor3&&(0!=this.limitState3||h)?this.maxMotorForce3*a:this.motorImpulse3=0;this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02;this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12;this.a1z1=this.ax1*this.i1e20+this.ay1*
this.i1e21+this.az1*this.i1e22;this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02;this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12;this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22;this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02;this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12;this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22;this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+
this.az2*this.i2e02;this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12;this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22;this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02;this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12;this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22;this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02;this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12;
this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22;this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1);this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2);this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3);this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1);this.k11=this.ax2*(this.a1x2+
this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2);this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3);this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1);this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2);this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3);this.kv00=this.k00;this.kv11=
this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;f&&2!=this.limitState1?(f=6.2831853*e,e=f*f*a,f=c/(e+2*this.limitMotor1.dampingRatio*f),this.cfm1=this.kv00*f,this.limitVelocity1=this.limitVelocity1*e*f):(this.cfm1=0,this.limitVelocity1=0.05*this.limitVelocity1*c);g&&2!=this.limitState2?(f=6.2831853*b,e=f*f*a,f=c/(e+2*this.limitMotor2.dampingRatio*f),this.cfm2=this.kv11*f,this.limitVelocity2=this.limitVelocity2*e*f):(this.cfm2=0,this.limitVelocity2=0.05*
this.limitVelocity2*c);h&&2!=this.limitState3?(f=6.2831853*d,e=f*f*a,f=c/(e+2*this.limitMotor3.dampingRatio*f),this.cfm3=this.kv22*f,this.limitVelocity3=this.limitVelocity3*e*f):(this.cfm3=0,this.limitVelocity3=0.05*this.limitVelocity3*c);this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*b;this.d01=
(this.k02*this.k21-this.k01*this.k22)*b;this.d02=(this.k01*this.k12-this.k02*this.k11)*b;this.d10=(this.k12*this.k20-this.k10*this.k22)*b;this.d11=(this.k00*this.k22-this.k02*this.k20)*b;this.d12=(this.k02*this.k10-this.k00*this.k12)*b;this.d20=(this.k10*this.k21-this.k11*this.k20)*b;this.d21=(this.k01*this.k20-this.k00*this.k21)*b;this.d22=(this.k00*this.k11-this.k01*this.k10)*b;this.limitImpulse1*=0.95;this.motorImpulse1*=0.95;this.limitImpulse2*=0.95;this.motorImpulse2*=0.95;this.limitImpulse3*=
0.95;this.motorImpulse3*=0.95;b=this.limitImpulse1+this.motorImpulse1;d=this.limitImpulse2+this.motorImpulse2;g=this.limitImpulse3+this.motorImpulse3;this.a1.x+=b*this.a1x1+d*this.a1x2+g*this.a1x3;this.a1.y+=b*this.a1y1+d*this.a1y2+g*this.a1y3;this.a1.z+=b*this.a1z1+d*this.a1z2+g*this.a1z3;this.a2.x-=b*this.a2x1+d*this.a2x2+g*this.a2x3;this.a2.y-=b*this.a2y1+d*this.a2y2+g*this.a2y3;this.a2.z-=b*this.a2z1+d*this.a2z2+g*this.a2z3},solve_:function(){var a=this.a2.x-this.a1.x,c=this.a2.y-this.a1.y,b=
this.a2.z-this.a1.z;this.limitVelocity3=30;var d=a*this.ax1+c*this.ay1+b*this.az1-this.limitVelocity1,e=a*this.ax2+c*this.ay2+b*this.az2-this.limitVelocity2,b=a*this.ax3+c*this.ay3+b*this.az3-this.limitVelocity3,a=d*this.d00+e*this.d01+b*this.d02,c=d*this.d10+e*this.d11+b*this.d12,d=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=a;this.limitImpulse2+=c;this.limitImpulse3+=d;this.a1.x+=a*this.a1x1+c*this.a1x2+d*this.a1x3;this.a1.y+=a*this.a1y1+c*this.a1y2+d*this.a1y3;this.a1.z+=a*this.a1z1+c*
this.a1z2+d*this.a1z3;this.a2.x-=a*this.a2x1+c*this.a2x2+d*this.a2x3;this.a2.y-=a*this.a2y1+c*this.a2y2+d*this.a2y3;this.a2.z-=a*this.a2z1+c*this.a2z2+d*this.a2z3},solve:function(){var a=this.a2.x-this.a1.x,c=this.a2.y-this.a1.y,b=this.a2.z-this.a1.z,d=a*this.ax1+c*this.ay1+b*this.az1,e=a*this.ax2+c*this.ay2+b*this.az2,b=a*this.ax3+c*this.ay3+b*this.az3,f=this.motorImpulse1,g=this.motorImpulse2,h=this.motorImpulse3,k=0,a=c=0;this.enableMotor1&&(k=(d-this.motorSpeed1)*this.dv00,this.motorImpulse1+=
k,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),k=this.motorImpulse1-f);this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-g);this.enableMotor3&&(a=(b-this.motorSpeed3)*
this.dv22,this.motorImpulse3+=a,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),a=this.motorImpulse3-h);var d=d+(k*this.kv00+c*this.k01+a*this.k02),e=e+(k*this.k10+c*this.kv11+a*this.k12),b=b+(k*this.k20+c*this.k21+a*this.kv22),d=d-(this.limitVelocity1+this.limitImpulse1*this.cfm1),e=e-(this.limitVelocity2+this.limitImpulse2*this.cfm2),b=b-(this.limitVelocity3+this.limitImpulse3*
this.cfm3),h=this.limitImpulse1,l=this.limitImpulse2,n=this.limitImpulse3,m=d*this.d00+e*this.d01+b*this.d02,g=d*this.d10+e*this.d11+b*this.d12,f=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=m;this.limitImpulse2+=g;this.limitImpulse3+=f;var p=0;if(2==this.limitState1||0>this.limitImpulse1*this.limitState1)m=-h,e+=m*this.k10,b+=m*this.k20,p|=1;if(2==this.limitState2||0>this.limitImpulse2*this.limitState2)g=-l,d+=g*this.k01,b+=g*this.k21,p|=2;if(2==this.limitState3||0>this.limitImpulse3*this.limitState3)f=
-n,d+=f*this.k02,e+=f*this.k12,p|=4;switch(p){case 1:p=1/(this.k11*this.k22-this.k12*this.k21);g=(this.k22*e+-this.k12*b)*p;f=(-this.k21*e+this.k11*b)*p;break;case 2:p=1/(this.k00*this.k22-this.k02*this.k20);m=(this.k22*d+-this.k02*b)*p;f=(-this.k20*d+this.k00*b)*p;break;case 3:f=b/this.k22;break;case 4:p=1/(this.k00*this.k11-this.k01*this.k10);m=(this.k11*d+-this.k01*e)*p;g=(-this.k10*d+this.k00*e)*p;break;case 5:g=e/this.k11;break;case 6:m=d/this.k00}this.limitImpulse1=m+h;this.limitImpulse2=g+
l;this.limitImpulse3=f+n;d=k+m;e=c+g;a+=f;this.a1.x+=d*this.a1x1+e*this.a1x2+a*this.a1x3;this.a1.y+=d*this.a1y1+e*this.a1y2+a*this.a1y3;this.a1.z+=d*this.a1z1+e*this.a1z2+a*this.a1z3;this.a2.x-=d*this.a2x1+e*this.a2x2+a*this.a2x3;this.a2.y-=d*this.a2y1+e*this.a2y2+a*this.a2y3;this.a2.z-=d*this.a2z1+e*this.a2z2+a*this.a2z3}};OIMO.RotationalConstraint=function(a,c){this.a2z=this.a2y=this.a2x=this.a1z=this.a1y=this.a1x=this.az=this.ay=this.ax=this.invDenom=this.invMotorDenom=this.motorDenom=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.cfm=NaN;this.enableLimit=!1;this.limitVelocity=this.upperLimit=this.lowerLimit=NaN;this.limitState=0;this.enableMotor=!1;this.maxMotorImpulse=
this.maxMotorForce=this.motorSpeed=NaN;this.limitMotor=c;this.b1=a.body1;this.b2=a.body2;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;this.motorImpulse=this.limitImpulse=0};
OIMO.RotationalConstraint.prototype={constructor:OIMO.RotationalConstraint,preSolve:function(a,c){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=0<this.maxMotorForce;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=
b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.limitMotor.frequency,d=0<b,e=this.limitMotor.angle;this.lowerLimit<=this.upperLimit?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitImpulse=this.limitState=0),this.limitVelocity=this.lowerLimit-e):e<this.lowerLimit?(-1!=this.limitState&&(this.limitState=
-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-e):e>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-e):(this.limitState=2,this.limitVelocity=this.limitImpulse=0),d||(this.limitVelocity=0.02<this.limitVelocity?this.limitVelocity-0.02:-0.02>this.limitVelocity?this.limitVelocity+0.02:0)):(this.limitState=2,this.limitImpulse=0);this.maxMotorImpulse=this.enableMotor&&(0!=this.limitState||d)?this.maxMotorForce*a:this.motorImpulse=
0;this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02;this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12;this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22;this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02;this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12;this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22;this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z);this.invMotorDenom=
1/this.motorDenom;d&&2!=this.limitState?(d=6.2831853*b,b=d*d*a,d=c/(b+2*this.limitMotor.dampingRatio*d),this.cfm=this.motorDenom*d,this.limitVelocity=this.limitVelocity*b*d):(this.cfm=0,this.limitVelocity=0.05*this.limitVelocity*c);this.invDenom=1/(this.motorDenom+this.cfm);this.limitImpulse*=0.95;this.motorImpulse*=0.95;b=this.limitImpulse+this.motorImpulse;this.a1.x+=b*this.a1x;this.a1.y+=b*this.a1y;this.a1.z+=b*this.a1z;this.a2.x-=b*this.a2x;this.a2.y-=b*this.a2y;this.a2.z-=b*this.a2z},solve:function(){var a=
this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z),c;if(this.enableMotor){c=(a-this.motorSpeed)*this.invMotorDenom;var b=this.motorImpulse;this.motorImpulse+=c;this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse);c=this.motorImpulse-b;a-=c*this.motorDenom}else c=0;2!=this.limitState?(a=(a-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom,b=this.limitImpulse,
this.limitImpulse+=a,0>this.limitImpulse*this.limitState&&(this.limitImpulse=0),a=this.limitImpulse-b):a=0;c=a+c;this.a1.x+=c*this.a1x;this.a1.y+=c*this.a1y;this.a1.z+=c*this.a1z;this.a2.x-=c*this.a2x;this.a2.y-=c*this.a2y;this.a2.z-=c*this.a2z}};OIMO.Translational3Constraint=function(a,c,b,d){this.limitVelocity1=this.upperLimit1=this.lowerLimit1=this.a2z3=this.a2y3=this.a2x3=this.a1z3=this.a1y3=this.a1x3=this.l2z3=this.l2y3=this.l2x3=this.l1z3=this.l1y3=this.l1x3=this.t2z3=this.t2y3=this.t2x3=this.t1z3=this.t1y3=this.t1x3=this.a2z2=this.a2y2=this.a2x2=this.a1z2=this.a1y2=this.a1x2=this.l2z2=this.l2y2=this.l2x2=this.l1z2=this.l1y2=this.l1x2=this.t2z2=this.t2y2=this.t2x2=this.t1z2=this.t1y2=this.t1x2=this.a2z1=this.a2y1=this.a2x1=this.a1z1=
this.a1y1=this.a1x1=this.l2z1=this.l2y1=this.l2x1=this.l1z1=this.l1y1=this.l1x1=this.t2z1=this.t2y1=this.t2x1=this.t1z1=this.t1y1=this.t1x1=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.az3=this.ay3=this.ax3=this.az2=this.ay2=this.ax2=this.az1=this.ay1=this.ax1=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=NaN;this.limitState1=
0;this.enableMotor1=!1;this.limitVelocity2=this.upperLimit2=this.lowerLimit2=this.maxMotorImpulse1=this.maxMotorForce1=this.motorSpeed1=NaN;this.limitState2=0;this.enableMotor2=!1;this.limitVelocity3=this.upperLimit3=this.lowerLimit3=this.maxMotorImpulse2=this.maxMotorForce2=this.motorSpeed2=NaN;this.limitState3=0;this.enableMotor3=!1;this.d22=this.d21=this.d20=this.d12=this.d11=this.d10=this.d02=this.d01=this.d00=this.dv22=this.dv11=this.dv00=this.kv22=this.kv11=this.kv00=this.k22=this.k21=this.k20=
this.k12=this.k11=this.k10=this.k02=this.k01=this.k00=this.maxMotorImpulse3=this.maxMotorForce3=this.motorSpeed3=NaN;this.limitMotor1=c;this.limitMotor2=b;this.limitMotor3=d;this.b1=a.body1;this.b2=a.body2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;this.i2=this.b2.inverseInertia;
this.cfm3=this.cfm2=this.cfm1=this.motorImpulse3=this.limitImpulse3=this.motorImpulse2=this.limitImpulse2=this.motorImpulse1=this.limitImpulse1=0;this.weight=-1};
OIMO.Translational3Constraint.prototype={constructor:OIMO.Translational3Constraint,preSolve:function(a,c){this.ax1=this.limitMotor1.axis.x;this.ay1=this.limitMotor1.axis.y;this.az1=this.limitMotor1.axis.z;this.ax2=this.limitMotor2.axis.x;this.ay2=this.limitMotor2.axis.y;this.az2=this.limitMotor2.axis.z;this.ax3=this.limitMotor3.axis.x;this.ay3=this.limitMotor3.axis.y;this.az3=this.limitMotor3.axis.z;this.lowerLimit1=this.limitMotor1.lowerLimit;this.upperLimit1=this.limitMotor1.upperLimit;this.motorSpeed1=
this.limitMotor1.motorSpeed;this.maxMotorForce1=this.limitMotor1.maxMotorForce;this.enableMotor1=0<this.maxMotorForce1;this.lowerLimit2=this.limitMotor2.lowerLimit;this.upperLimit2=this.limitMotor2.upperLimit;this.motorSpeed2=this.limitMotor2.motorSpeed;this.maxMotorForce2=this.limitMotor2.maxMotorForce;this.enableMotor2=0<this.maxMotorForce2;this.lowerLimit3=this.limitMotor3.lowerLimit;this.upperLimit3=this.limitMotor3.upperLimit;this.motorSpeed3=this.limitMotor3.motorSpeed;this.maxMotorForce3=this.limitMotor3.maxMotorForce;
this.enableMotor3=0<this.maxMotorForce3;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var b=this.p2.x-this.p1.x,d=this.p2.y-this.p1.y,e=this.p2.z-this.p1.z,f=b*this.ax1+
d*this.ay1+e*this.az1,g=b*this.ax2+d*this.ay2+e*this.az2,h=b*this.ax3+d*this.ay3+e*this.az3,k=this.limitMotor1.frequency,b=this.limitMotor2.frequency,d=this.limitMotor3.frequency,l=0<k,e=0<b,n=0<d,m=this.lowerLimit1<=this.upperLimit1,p=this.lowerLimit2<=this.upperLimit2,s=this.lowerLimit3<=this.upperLimit3;if(l&&20<f||-20>f)l=!1;if(e&&20<g||-20>g)e=!1;if(n&&20<h||-20>h)n=!1;m?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitImpulse1=this.limitState1=0),this.limitVelocity1=this.lowerLimit1-
f,l||(f=this.lowerLimit1)):f<this.lowerLimit1?(-1!=this.limitState1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-f,l||(f=this.lowerLimit1)):f>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-f,l||(f=this.upperLimit1)):(this.limitState1=2,this.limitVelocity1=this.limitImpulse1=0),l||(this.limitVelocity1=0.005<this.limitVelocity1?this.limitVelocity1-0.005:-0.005>this.limitVelocity1?this.limitVelocity1+
0.005:0)):(this.limitState1=2,this.limitImpulse1=0);p?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitImpulse2=this.limitState2=0),this.limitVelocity2=this.lowerLimit2-g,e||(g=this.lowerLimit2)):g<this.lowerLimit2?(-1!=this.limitState2&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-g,e||(g=this.lowerLimit2)):g>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-g,e||(g=this.upperLimit2)):
(this.limitState2=2,this.limitVelocity2=this.limitImpulse2=0),e||(this.limitVelocity2=0.005<this.limitVelocity2?this.limitVelocity2-0.005:-0.005>this.limitVelocity2?this.limitVelocity2+0.005:0)):(this.limitState2=2,this.limitImpulse2=0);s?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitImpulse3=this.limitState3=0),this.limitVelocity3=this.lowerLimit3-h,n||(h=this.lowerLimit3)):h<this.lowerLimit3?(-1!=this.limitState3&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=
this.lowerLimit3-h,n||(h=this.lowerLimit3)):h>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-h,n||(h=this.upperLimit3)):(this.limitState3=2,this.limitVelocity3=this.limitImpulse3=0),n||(this.limitVelocity3=0.005<this.limitVelocity3?this.limitVelocity3-0.005:-0.005>this.limitVelocity3?this.limitVelocity3+0.005:0)):(this.limitState3=2,this.limitImpulse3=0);this.maxMotorImpulse1=this.enableMotor1&&(0!=this.limitState1||l)?this.maxMotorForce1*
a:this.motorImpulse1=0;this.maxMotorImpulse2=this.enableMotor2&&(0!=this.limitState2||e)?this.maxMotorForce2*a:this.motorImpulse2=0;this.maxMotorImpulse3=this.enableMotor3&&(0!=this.limitState3||n)?this.maxMotorForce3*a:this.motorImpulse3=0;m=f*this.ax1+g*this.ax2+h*this.ax2;p=f*this.ay1+g*this.ay2+h*this.ay2;f=f*this.az1+g*this.az2+h*this.az2;g=this.m2/(this.m1+this.m2);0<=this.weight&&(g=this.weight);h=1-g;this.r1x=this.r1.x+m*g;this.r1y=this.r1.y+p*g;this.r1z=this.r1.z+f*g;this.r2x=this.r2.x-m*
h;this.r2y=this.r2.y-p*h;this.r2z=this.r2.z-f*h;this.t1x1=this.r1y*this.az1-this.r1z*this.ay1;this.t1y1=this.r1z*this.ax1-this.r1x*this.az1;this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1;this.t2x1=this.r2y*this.az1-this.r2z*this.ay1;this.t2y1=this.r2z*this.ax1-this.r2x*this.az1;this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1;this.l1x1=this.ax1*this.m1;this.l1y1=this.ay1*this.m1;this.l1z1=this.az1*this.m1;this.l2x1=this.ax1*this.m2;this.l2y1=this.ay1*this.m2;this.l2z1=this.az1*this.m2;this.a1x1=this.t1x1*
this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02;this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12;this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22;this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02;this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12;this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22;this.t1x2=this.r1y*this.az2-this.r1z*this.ay2;this.t1y2=this.r1z*this.ax2-this.r1x*
this.az2;this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2;this.t2x2=this.r2y*this.az2-this.r2z*this.ay2;this.t2y2=this.r2z*this.ax2-this.r2x*this.az2;this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2;this.l1x2=this.ax2*this.m1;this.l1y2=this.ay2*this.m1;this.l1z2=this.az2*this.m1;this.l2x2=this.ax2*this.m2;this.l2y2=this.ay2*this.m2;this.l2z2=this.az2*this.m2;this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02;this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12;
this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22;this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02;this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12;this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22;this.t1x3=this.r1y*this.az3-this.r1z*this.ay3;this.t1y3=this.r1z*this.ax3-this.r1x*this.az3;this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3;this.t2x3=this.r2y*this.az3-this.r2z*this.ay3;this.t2y3=this.r2z*this.ax3-
this.r2x*this.az3;this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3;this.l1x3=this.ax3*this.m1;this.l1y3=this.ay3*this.m1;this.l1z3=this.az3*this.m1;this.l2x3=this.ax3*this.m2;this.l2y3=this.ay3*this.m2;this.l2z3=this.az3*this.m2;this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02;this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12;this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22;this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*
this.i2e02;this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12;this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;f=this.m1+this.m2;this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*f;this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*f;this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*f;this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*f;this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*
f;this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*f;this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*f;this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*f;this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*f;this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1;this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2;this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3;this.k10+=this.t1x2*this.a1x1+
this.t1y2*this.a1y1+this.t1z2*this.a1z1;this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2;this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3;this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1;this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2;this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3;this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1;this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+
this.t2z1*this.a2z2;this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3;this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1;this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2;this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3;this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1;this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2;this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3;
this.kv00=this.k00;this.kv11=this.k11;this.kv22=this.k22;this.dv00=1/this.kv00;this.dv11=1/this.kv11;this.dv22=1/this.kv22;l&&2!=this.limitState1?(l=6.2831853*k,k=l*l*a,l=c/(k+2*this.limitMotor1.dampingRatio*l),this.cfm1=this.kv00*l,this.limitVelocity1=this.limitVelocity1*k*l):(this.cfm1=0,this.limitVelocity1=0.05*this.limitVelocity1*c);e&&2!=this.limitState2?(l=6.2831853*b,k=l*l*a,l=c/(k+2*this.limitMotor2.dampingRatio*l),this.cfm2=this.kv11*l,this.limitVelocity2=this.limitVelocity2*k*l):(this.cfm2=
0,this.limitVelocity2=0.05*this.limitVelocity2*c);n&&2!=this.limitState3?(l=6.2831853*d,k=l*l*a,l=c/(k+2*this.limitMotor3.dampingRatio*l),this.cfm3=this.kv22*l,this.limitVelocity3=this.limitVelocity3*k*l):(this.cfm3=0,this.limitVelocity3=0.05*this.limitVelocity3*c);this.k00+=this.cfm1;this.k11+=this.cfm2;this.k22+=this.cfm3;b=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-
this.k12*this.k21)*b;this.d01=(this.k02*this.k21-this.k01*this.k22)*b;this.d02=(this.k01*this.k12-this.k02*this.k11)*b;this.d10=(this.k12*this.k20-this.k10*this.k22)*b;this.d11=(this.k00*this.k22-this.k02*this.k20)*b;this.d12=(this.k02*this.k10-this.k00*this.k12)*b;this.d20=(this.k10*this.k21-this.k11*this.k20)*b;this.d21=(this.k01*this.k20-this.k00*this.k21)*b;this.d22=(this.k00*this.k11-this.k01*this.k10)*b;b=this.limitImpulse1+this.motorImpulse1;d=this.limitImpulse2+this.motorImpulse2;e=this.limitImpulse3+
this.motorImpulse3;this.l1.x+=b*this.l1x1+d*this.l1x2+e*this.l1x3;this.l1.y+=b*this.l1y1+d*this.l1y2+e*this.l1y3;this.l1.z+=b*this.l1z1+d*this.l1z2+e*this.l1z3;this.a1.x+=b*this.a1x1+d*this.a1x2+e*this.a1x3;this.a1.y+=b*this.a1y1+d*this.a1y2+e*this.a1y3;this.a1.z+=b*this.a1z1+d*this.a1z2+e*this.a1z3;this.l2.x-=b*this.l2x1+d*this.l2x2+e*this.l2x3;this.l2.y-=b*this.l2y1+d*this.l2y2+e*this.l2y3;this.l2.z-=b*this.l2z1+d*this.l2z2+e*this.l2z3;this.a2.x-=b*this.a2x1+d*this.a2x2+e*this.a2x3;this.a2.y-=b*
this.a2y1+d*this.a2y2+e*this.a2y3;this.a2.z-=b*this.a2z1+d*this.a2z2+e*this.a2z3},solve:function(){var a=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,c=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,b=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,d=a*this.ax1+c*this.ay1+b*this.az1,e=a*this.ax2+c*this.ay2+b*this.az2,b=a*this.ax3+c*this.ay3+b*this.az3,
f=this.motorImpulse1,g=this.motorImpulse2,h=this.motorImpulse3,k=0,a=c=0;this.enableMotor1&&(k=(d-this.motorSpeed1)*this.dv00,this.motorImpulse1+=k,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),k=this.motorImpulse1-f);this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<
-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-g);this.enableMotor3&&(a=(b-this.motorSpeed3)*this.dv22,this.motorImpulse3+=a,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),a=this.motorImpulse3-h);var d=d+(k*this.kv00+c*this.k01+a*this.k02),e=e+(k*this.k10+c*this.kv11+a*this.k12),b=b+(k*this.k20+c*this.k21+a*this.kv22),d=d-(this.limitVelocity1+
this.limitImpulse1*this.cfm1),e=e-(this.limitVelocity2+this.limitImpulse2*this.cfm2),b=b-(this.limitVelocity3+this.limitImpulse3*this.cfm3),h=this.limitImpulse1,l=this.limitImpulse2,n=this.limitImpulse3,m=d*this.d00+e*this.d01+b*this.d02,g=d*this.d10+e*this.d11+b*this.d12,f=d*this.d20+e*this.d21+b*this.d22;this.limitImpulse1+=m;this.limitImpulse2+=g;this.limitImpulse3+=f;var p=0;if(2==this.limitState1||0>this.limitImpulse1*this.limitState1)m=-h,e+=m*this.k10,b+=m*this.k20,p|=1;if(2==this.limitState2||
0>this.limitImpulse2*this.limitState2)g=-l,d+=g*this.k01,b+=g*this.k21,p|=2;if(2==this.limitState3||0>this.limitImpulse3*this.limitState3)f=-n,d+=f*this.k02,e+=f*this.k12,p|=4;switch(p){case 1:p=1/(this.k11*this.k22-this.k12*this.k21);g=(this.k22*e+-this.k12*b)*p;f=(-this.k21*e+this.k11*b)*p;break;case 2:p=1/(this.k00*this.k22-this.k02*this.k20);m=(this.k22*d+-this.k02*b)*p;f=(-this.k20*d+this.k00*b)*p;break;case 3:f=b/this.k22;break;case 4:p=1/(this.k00*this.k11-this.k01*this.k10);m=(this.k11*d+
-this.k01*e)*p;g=(-this.k10*d+this.k00*e)*p;break;case 5:g=e/this.k11;break;case 6:m=d/this.k00}this.limitImpulse1=h+m;this.limitImpulse2=l+g;this.limitImpulse3=n+f;d=k+m;e=c+g;a+=f;this.l1.x+=d*this.l1x1+e*this.l1x2+a*this.l1x3;this.l1.y+=d*this.l1y1+e*this.l1y2+a*this.l1y3;this.l1.z+=d*this.l1z1+e*this.l1z2+a*this.l1z3;this.a1.x+=d*this.a1x1+e*this.a1x2+a*this.a1x3;this.a1.y+=d*this.a1y1+e*this.a1y2+a*this.a1y3;this.a1.z+=d*this.a1z1+e*this.a1z2+a*this.a1z3;this.l2.x-=d*this.l2x1+e*this.l2x2+a*
this.l2x3;this.l2.y-=d*this.l2y1+e*this.l2y2+a*this.l2y3;this.l2.z-=d*this.l2z1+e*this.l2z2+a*this.l2z3;this.a2.x-=d*this.a2x1+e*this.a2x2+a*this.a2x3;this.a2.y-=d*this.a2y1+e*this.a2y2+a*this.a2y3;this.a2.z-=d*this.a2z1+e*this.a2z2+a*this.a2z3}};OIMO.TranslationalConstraint=function(a,c){this.limitVelocity=this.upperLimit=this.lowerLimit=this.a2z=this.a2y=this.a2x=this.a1z=this.a1y=this.a1x=this.l2z=this.l2y=this.l2x=this.l1z=this.l1y=this.l1x=this.t2z=this.t2y=this.t2x=this.t1z=this.t1y=this.t1x=this.r2z=this.r2y=this.r2x=this.r1z=this.r1y=this.r1x=this.az=this.ay=this.ax=this.invDenom=this.invMotorDenom=this.motorDenom=this.i2e22=this.i2e21=this.i2e20=this.i2e12=this.i2e11=this.i2e10=this.i2e02=this.i2e01=this.i2e00=this.i1e22=this.i1e21=
this.i1e20=this.i1e12=this.i1e11=this.i1e10=this.i1e02=this.i1e01=this.i1e00=this.m2=this.m1=this.cfm=NaN;this.limitState=0;this.enableMotor=!1;this.maxMotorImpulse=this.maxMotorForce=this.motorSpeed=NaN;this.limitMotor=c;this.b1=a.body1;this.b2=a.body2;this.p1=a.anchorPoint1;this.p2=a.anchorPoint2;this.r1=a.relativeAnchorPoint1;this.r2=a.relativeAnchorPoint2;this.l1=this.b1.linearVelocity;this.l2=this.b2.linearVelocity;this.a1=this.b1.angularVelocity;this.a2=this.b2.angularVelocity;this.i1=this.b1.inverseInertia;
this.i2=this.b2.inverseInertia;this.motorImpulse=this.limitImpulse=0};
OIMO.TranslationalConstraint.prototype={constructor:OIMO.TranslationalConstraint,preSolve:function(a,c){this.ax=this.limitMotor.axis.x;this.ay=this.limitMotor.axis.y;this.az=this.limitMotor.axis.z;this.lowerLimit=this.limitMotor.lowerLimit;this.upperLimit=this.limitMotor.upperLimit;this.motorSpeed=this.limitMotor.motorSpeed;this.maxMotorForce=this.limitMotor.maxMotorForce;this.enableMotor=0<this.maxMotorForce;this.m1=this.b1.inverseMass;this.m2=this.b2.inverseMass;var b=this.i1.elements,d=this.i2.elements;
this.i1e00=b[0];this.i1e01=b[1];this.i1e02=b[2];this.i1e10=b[3];this.i1e11=b[4];this.i1e12=b[5];this.i1e20=b[6];this.i1e21=b[7];this.i1e22=b[8];this.i2e00=d[0];this.i2e01=d[1];this.i2e02=d[2];this.i2e10=d[3];this.i2e11=d[4];this.i2e12=d[5];this.i2e20=d[6];this.i2e21=d[7];this.i2e22=d[8];var e=(this.p2.x-this.p1.x)*this.ax+(this.p2.y-this.p1.y)*this.ay+(this.p2.z-this.p1.z)*this.az,b=this.limitMotor.frequency,d=0<b,f=this.lowerLimit<=this.upperLimit;if(d&&20<e||-20>e)d=!1;f?(this.lowerLimit==this.upperLimit?
(0!=this.limitState&&(this.limitImpulse=this.limitState=0),this.limitVelocity=this.lowerLimit-e,d||(e=this.lowerLimit)):e<this.lowerLimit?(-1!=this.limitState&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-e,d||(e=this.lowerLimit)):e>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-e,d||(e=this.upperLimit)):(this.limitState=2,this.limitVelocity=this.limitImpulse=0),d||(this.limitVelocity=0.005<this.limitVelocity?
this.limitVelocity-0.005:-0.005>this.limitVelocity?this.limitVelocity+0.005:0)):(this.limitState=2,this.limitImpulse=0);this.maxMotorImpulse=this.enableMotor&&(0!=this.limitState||d)?this.maxMotorForce*a:this.motorImpulse=0;var f=e*this.ax,g=e*this.ay,e=e*this.az,h=this.m1/(this.m1+this.m2),k=1-h;this.r1x=this.r1.x+f*h;this.r1y=this.r1.y+g*h;this.r1z=this.r1.z+e*h;this.r2x=this.r2.x-f*k;this.r2y=this.r2.y-g*k;this.r2z=this.r2.z-e*k;this.t1x=this.r1y*this.az-this.r1z*this.ay;this.t1y=this.r1z*this.ax-
this.r1x*this.az;this.t1z=this.r1x*this.ay-this.r1y*this.ax;this.t2x=this.r2y*this.az-this.r2z*this.ay;this.t2y=this.r2z*this.ax-this.r2x*this.az;this.t2z=this.r2x*this.ay-this.r2y*this.ax;this.l1x=this.ax*this.m1;this.l1y=this.ay*this.m1;this.l1z=this.az*this.m1;this.l2x=this.ax*this.m2;this.l2y=this.ay*this.m2;this.l2z=this.az*this.m2;this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02;this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12;this.a1z=this.t1x*this.i1e20+
this.t1y*this.i1e21+this.t1z*this.i1e22;this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02;this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12;this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22;this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-
this.a2y*this.r2x);this.invMotorDenom=1/this.motorDenom;d&&2!=this.limitState?(d=6.2831853*b,b=d*d*a,d=c/(b+2*this.limitMotor.dampingRatio*d),this.cfm=this.motorDenom*d,this.limitVelocity=this.limitVelocity*b*d):(this.cfm=0,this.limitVelocity=0.05*this.limitVelocity*c);this.invDenom=1/(this.motorDenom+this.cfm);b=this.limitImpulse+this.motorImpulse;this.l1.x+=b*this.l1x;this.l1.y+=b*this.l1y;this.l1.z+=b*this.l1z;this.a1.x+=b*this.a1x;this.a1.y+=b*this.a1y;this.a1.z+=b*this.a1z;this.l2.x-=b*this.l2x;
this.l2.y-=b*this.l2y;this.l2.z-=b*this.l2z;this.a2.x-=b*this.a2x;this.a2.y-=b*this.a2y;this.a2.z-=b*this.a2z},solve:function(){var a=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z,c;if(this.enableMotor){c=(a-this.motorSpeed)*this.invMotorDenom;var b=this.motorImpulse;this.motorImpulse+=c;this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=
this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse);c=this.motorImpulse-b;a-=c*this.motorDenom}else c=0;2!=this.limitState?(a=(a-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom,b=this.limitImpulse,this.limitImpulse+=a,0>this.limitImpulse*this.limitState&&(this.limitImpulse=0),a=this.limitImpulse-b):a=0;c=a+c;this.l1.x+=c*this.l1x;this.l1.y+=c*this.l1y;this.l1.z+=c*this.l1z;this.a1.x+=c*this.a1x;this.a1.y+=c*this.a1y;this.a1.z+=c*this.a1z;
this.l2.x-=c*this.l2x;this.l2.y-=c*this.l2y;this.l2.z-=c*this.l2z;this.a2.x-=c*this.a2x;this.a2.y-=c*this.a2y;this.a2.z-=c*this.a2z}};OIMO.Contact=function(){this.next=this.prev=this.body2=this.body1=this.shape2=this.shape1=null;this.sleeping=this.persisting=!1;this.constraint=this.detector=null;this.touching=!1;this.b1Link=new OIMO.ContactLink(this);this.b2Link=new OIMO.ContactLink(this);this.s1Link=new OIMO.ContactLink(this);this.s2Link=new OIMO.ContactLink(this);this.manifold=new OIMO.ContactManifold;this.buffer=[];this.buffer.length=4;this.buffer[0]=new OIMO.ImpulseDataBuffer;this.buffer[1]=new OIMO.ImpulseDataBuffer;this.buffer[2]=
new OIMO.ImpulseDataBuffer;this.buffer[3]=new OIMO.ImpulseDataBuffer;this.points=this.manifold.points;this.constraint=new OIMO.ContactConstraint(this.manifold)};
OIMO.Contact.prototype={constructor:OIMO.Contact,mixRestitution:function(a,c){return OIMO.sqrt(a*c)},mixFriction:function(a,c){return OIMO.sqrt(a*c)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution);this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var a=this.manifold.numPoints,c=a;c--;){var b=this.buffer[c],d=this.points[c];b.lp1X=d.localPoint1.x;b.lp1Y=d.localPoint1.y;b.lp1Z=d.localPoint1.z;
b.lp2X=d.localPoint2.x;b.lp2Y=d.localPoint2.y;b.lp2Z=d.localPoint2.z;b.impulse=d.normalImpulse}this.manifold.numPoints=0;this.detector.detectCollision(this.shape1,this.shape2,this.manifold);c=this.manifold.numPoints;if(0==c)this.touching=!1;else for(this.touching=!0;c--;){for(var d=this.points[c],e=d.localPoint1.x,f=d.localPoint1.y,g=d.localPoint1.z,h=d.localPoint2.x,k=d.localPoint2.y,l=d.localPoint2.z,n=-1,m=4E-4,p=a;p--;){var b=this.buffer[p],s=b.lp1X-e,q=b.lp1Y-f,u=b.lp1Z-g,r=s*s+q*q+u*u,s=b.lp2X-
h,q=b.lp2Y-k,u=b.lp2Z-l,b=s*s+q*q+u*u;r<b?r<m&&(m=r,n=p):b<m&&(m=b,n=p)}-1!=n?(e=this.buffer[n],this.buffer[n]=this.buffer[--a],this.buffer[a]=e,d.normalImpulse=e.impulse,d.warmStarted=!0):(d.normalImpulse=0,d.warmStarted=!1)}},attach:function(a,c){this.shape1=a;this.shape2=c;this.body1=a.parent;this.body2=c.parent;this.manifold.body1=this.body1;this.manifold.body2=this.body2;this.constraint.body1=this.body1;this.constraint.body2=this.body2;this.constraint.attach();this.s1Link.shape=c;this.s1Link.body=
this.body2;this.s2Link.shape=a;this.s2Link.body=this.body1;null!=a.contactLink?(this.s1Link.next=a.contactLink).prev=this.s1Link:this.s1Link.next=null;a.contactLink=this.s1Link;a.numContacts++;null!=c.contactLink?(this.s2Link.next=c.contactLink).prev=this.s2Link:this.s2Link.next=null;c.contactLink=this.s2Link;c.numContacts++;this.b1Link.shape=c;this.b1Link.body=this.body2;this.b2Link.shape=a;this.b2Link.body=this.body1;null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:
this.b1Link.next=null;this.body1.contactLink=this.b1Link;this.body1.numContacts++;null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null;this.body2.contactLink=this.b2Link;this.body2.numContacts++;this.next=this.prev=null;this.persisting=!0;this.sleeping=this.body1.sleeping&&this.body2.sleeping;this.manifold.numPoints=0},detach:function(){var a=this.s1Link.prev,c=this.s1Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.shape1.contactLink==
this.s1Link&&(this.shape1.contactLink=c);this.s1Link.prev=null;this.s1Link.next=null;this.s1Link.shape=null;this.s1Link.body=null;this.shape1.numContacts--;a=this.s2Link.prev;c=this.s2Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=c);this.s2Link.prev=null;this.s2Link.next=null;this.s2Link.shape=null;this.s2Link.body=null;this.shape2.numContacts--;a=this.b1Link.prev;c=this.b1Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.body1.contactLink==
this.b1Link&&(this.body1.contactLink=c);this.b1Link.prev=null;this.b1Link.next=null;this.b1Link.shape=null;this.b1Link.body=null;this.body1.numContacts--;a=this.b2Link.prev;c=this.b2Link.next;null!==a&&(a.next=c);null!==c&&(c.prev=a);this.body2.contactLink==this.b2Link&&(this.body2.contactLink=c);this.b2Link.prev=null;this.b2Link.next=null;this.b2Link.shape=null;this.b2Link.body=null;this.body2.numContacts--;this.manifold.body1=null;this.manifold.body2=null;this.constraint.body1=null;this.constraint.body2=
null;this.constraint.detach();this.body2=this.body1=this.shape2=this.shape1=null}};OIMO.ContactConstraint=function(a){OIMO.Constraint.call(this);this.manifold=a;this.friction=this.restitution=NaN;this.ii2=this.ii1=this.i2=this.i1=this.av2=this.av1=this.lv2=this.lv1=this.p2=this.p1=null;this.m2=this.m1=NaN;this.num=0;this.ps=a.points;this.cs=new OIMO.ContactPointDataBuffer;this.cs.next=new OIMO.ContactPointDataBuffer;this.cs.next.next=new OIMO.ContactPointDataBuffer;this.cs.next.next.next=new OIMO.ContactPointDataBuffer};OIMO.ContactConstraint.prototype=Object.create(OIMO.Constraint.prototype);
OIMO.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position;this.p2=this.body2.position;this.lv1=this.body1.linearVelocity;this.av1=this.body1.angularVelocity;this.lv2=this.body2.linearVelocity;this.av2=this.body2.angularVelocity;this.i1=this.body1.inverseInertia;this.i2=this.body2.inverseInertia};OIMO.ContactConstraint.prototype.detach=function(){this.i2=this.i1=this.av2=this.av1=this.lv2=this.lv1=this.p2=this.p1=null};
OIMO.ContactConstraint.prototype.preSolve=function(a,c){this.m1=this.body1.inverseMass;this.m2=this.body2.inverseMass;this.ii1=this.i1.clone();this.ii2=this.i2.clone();var b=this.ii1.elements,d=this.ii2.elements,e=this.p1.x,f=this.p1.y,g=this.p1.z,h=this.p2.x,k=this.p2.y,l=this.p2.z,n=this.m1+this.m2;this.num=this.manifold.numPoints;for(var m=this.cs,p=0;p<this.num;p++){var s=this.ps[p],q,u,r,t,z,F;q=s.position.x;u=s.position.y;r=s.position.z;var J=q-e,H=u-f,B=r-g,I=q-h,K=u-k,x=r-l;m.rp1X=J;m.rp1Y=
H;m.rp1Z=B;m.rp2X=I;m.rp2Y=K;m.rp2Z=x;m.norImp=s.normalImpulse;m.tanImp=s.tangentImpulse;m.binImp=s.binormalImpulse;var C=s.normal.x,v=s.normal.y,L=s.normal.z,O=this.lv2.x+this.av2.y*x-this.av2.z*K-(this.lv1.x+this.av1.y*B-this.av1.z*H),P=this.lv2.y+this.av2.z*I-this.av2.x*x-(this.lv1.y+this.av1.z*J-this.av1.x*B),Q=this.lv2.z+this.av2.x*K-this.av2.y*I-(this.lv1.z+this.av1.x*H-this.av1.y*J),S=C*O+v*P+L*Q,O=O-S*C,M=P-S*v,N=Q-S*L,Q=O*O+M*M+N*N;0.04<Q?Q=1/OIMO.sqrt(Q):(O=v*C-L*L,M=-L*v-C*C,N=C*L+v*v,
Q=1/OIMO.sqrt(O*O+M*M+N*N));var O=O*Q,M=M*Q,N=N*Q,U=v*N-L*M,V=L*O-C*N,Pa=C*M-v*O;m.norX=C;m.norY=v;m.norZ=L;m.tanX=O;m.tanY=M;m.tanZ=N;m.binX=U;m.binY=V;m.binZ=Pa;m.norU1X=C*this.m1;m.norU1Y=v*this.m1;m.norU1Z=L*this.m1;m.norU2X=C*this.m2;m.norU2Y=v*this.m2;m.norU2Z=L*this.m2;m.tanU1X=O*this.m1;m.tanU1Y=M*this.m1;m.tanU1Z=N*this.m1;m.tanU2X=O*this.m2;m.tanU2Y=M*this.m2;m.tanU2Z=N*this.m2;m.binU1X=U*this.m1;m.binU1Y=V*this.m1;m.binU1Z=Pa*this.m1;m.binU2X=U*this.m2;m.binU2Y=V*this.m2;m.binU2Z=Pa*this.m2;
r=H*L-B*v;t=B*C-J*L;z=J*v-H*C;var Ca=K*L-x*v,Da=x*C-I*L,Ea=I*v-K*C,Ka=H*N-B*M,La=B*O-J*N,X=J*M-H*O,D=K*N-x*M,E=x*O-I*N,R=I*M-K*O,Y=H*Pa-B*V,Z=B*U-J*Pa,ha=J*V-H*U,da=K*Pa-x*V,ja=x*U-I*Pa,ka=I*V-K*U,Q=r*b[0]+t*b[1]+z*b[2],P=r*b[3]+t*b[4]+z*b[5],ea=r*b[6]+t*b[7]+z*b[8],fa=Ca*d[0]+Da*d[1]+Ea*d[2],W=Ca*d[3]+Da*d[4]+Ea*d[5],$=Ca*d[6]+Da*d[7]+Ea*d[8];q=Ka*b[0]+La*b[1]+X*b[2];u=Ka*b[3]+La*b[4]+X*b[5];F=Ka*b[6]+La*b[7]+X*b[8];var sa=D*d[0]+E*d[1]+R*d[2],ta=D*d[3]+E*d[4]+R*d[5],ya=D*d[6]+E*d[7]+R*d[8],za=Y*
b[0]+Z*b[1]+ha*b[2],Aa=Y*b[3]+Z*b[4]+ha*b[5],yb=Y*b[6]+Z*b[7]+ha*b[8],Nb=da*d[0]+ja*d[1]+ka*d[2],Ob=da*d[3]+ja*d[4]+ka*d[5],Pb=da*d[6]+ja*d[7]+ka*d[8];m.norT1X=r;m.norT1Y=t;m.norT1Z=z;m.tanT1X=Ka;m.tanT1Y=La;m.tanT1Z=X;m.binT1X=Y;m.binT1Y=Z;m.binT1Z=ha;m.norT2X=Ca;m.norT2Y=Da;m.norT2Z=Ea;m.tanT2X=D;m.tanT2Y=E;m.tanT2Z=R;m.binT2X=da;m.binT2Y=ja;m.binT2Z=ka;m.norTU1X=Q;m.norTU1Y=P;m.norTU1Z=ea;m.tanTU1X=q;m.tanTU1Y=u;m.tanTU1Z=F;m.binTU1X=za;m.binTU1Y=Aa;m.binTU1Z=yb;m.norTU2X=fa;m.norTU2Y=W;m.norTU2Z=
$;m.tanTU2X=sa;m.tanTU2Y=ta;m.tanTU2Z=ya;m.binTU2X=Nb;m.binTU2Y=Ob;m.binTU2Z=Pb;q=r*b[0]+t*b[1]+z*b[2];u=r*b[3]+t*b[4]+z*b[5];r=r*b[6]+t*b[7]+z*b[8];t=u*B-r*H;z=r*J-q*B;F=q*H-u*J;q=Ca*d[0]+Da*d[1]+Ea*d[2];u=Ca*d[3]+Da*d[4]+Ea*d[5];r=Ca*d[6]+Da*d[7]+Ea*d[8];t+=u*x-r*K;z+=r*I-q*x;F+=q*K-u*I;C=1/(n+C*t+v*z+L*F);q=Ka*b[0]+La*b[1]+X*b[2];u=Ka*b[3]+La*b[4]+X*b[5];r=Ka*b[6]+La*b[7]+X*b[8];t=u*B-r*H;z=r*J-q*B;F=q*H-u*J;q=D*d[0]+E*d[1]+R*d[2];u=D*d[3]+E*d[4]+R*d[5];r=D*d[6]+E*d[7]+R*d[8];t+=u*x-r*K;z+=r*I-
q*x;F+=q*K-u*I;v=1/(n+O*t+M*z+N*F);q=Y*b[0]+Z*b[1]+ha*b[2];u=Y*b[3]+Z*b[4]+ha*b[5];r=Y*b[6]+Z*b[7]+ha*b[8];t=u*B-r*H;z=r*J-q*B;F=q*H-u*J;q=da*d[0]+ja*d[1]+ka*d[2];u=da*d[3]+ja*d[4]+ka*d[5];r=da*d[6]+ja*d[7]+ka*d[8];t+=u*x-r*K;z+=r*I-q*x;F+=q*K-u*I;J=1/(n+U*t+V*z+Pa*F);m.norDen=C;m.tanDen=v;m.binDen=J;s.warmStarted?(S=s.normalImpulse,this.lv1.x+=m.norU1X*S,this.lv1.y+=m.norU1Y*S,this.lv1.z+=m.norU1Z*S,this.av1.x+=Q*S,this.av1.y+=P*S,this.av1.z+=ea*S,this.lv2.x-=m.norU2X*S,this.lv2.y-=m.norU2Y*S,this.lv2.z-=
m.norU2Z*S,this.av2.x-=fa*S,this.av2.y-=W*S,this.av2.z-=$*S,m.norImp=S,m.tanImp=0,S=m.binImp=0):(m.norImp=0,m.tanImp=0,m.binImp=0);-1<S&&(S=0);S=this.restitution*-S;s=-(s.penetration+0.005)*c*0.05;S<s&&(S=s);m.norTar=S;m.last=p==this.num-1;m=m.next}};
OIMO.ContactConstraint.prototype.solve=function(){for(var a=this.lv1.x,c=this.lv1.y,b=this.lv1.z,d=this.lv2.x,e=this.lv2.y,f=this.lv2.z,g=this.av1.x,h=this.av1.y,k=this.av1.z,l=this.av2.x,n=this.av2.y,m=this.av2.z,p=this.cs;;){var s,q,u,r,t=p.norImp,z=p.tanImp,F=p.binImp,J=-t*this.friction;u=d-a;r=e-c;var H=f-b;q=u*p.tanX+r*p.tanY+H*p.tanZ+l*p.tanT2X+n*p.tanT2Y+m*p.tanT2Z-g*p.tanT1X-h*p.tanT1Y-k*p.tanT1Z;s=z;q*=p.tanDen;z+=q;q=u*p.binX+r*p.binY+H*p.binZ+l*p.binT2X+n*p.binT2Y+m*p.binT2Z-g*p.binT1X-
h*p.binT1Y-k*p.binT1Z;u=F;r=q*p.binDen;F+=r;q=z*z+F*F;q>J*J&&(q=J/OIMO.sqrt(q),z*=q,F*=q);q=z-s;r=F-u;a+=p.tanU1X*q+p.binU1X*r;c+=p.tanU1Y*q+p.binU1Y*r;b+=p.tanU1Z*q+p.binU1Z*r;g+=p.tanTU1X*q+p.binTU1X*r;h+=p.tanTU1Y*q+p.binTU1Y*r;k+=p.tanTU1Z*q+p.binTU1Z*r;d-=p.tanU2X*q+p.binU2X*r;e-=p.tanU2Y*q+p.binU2Y*r;f-=p.tanU2Z*q+p.binU2Z*r;l-=p.tanTU2X*q+p.binTU2X*r;n-=p.tanTU2Y*q+p.binTU2Y*r;m-=p.tanTU2Z*q+p.binTU2Z*r;q=(d-a)*p.norX+(e-c)*p.norY+(f-b)*p.norZ+l*p.norT2X+n*p.norT2Y+m*p.norT2Z-g*p.norT1X-h*
p.norT1Y-k*p.norT1Z;s=t;q=(q-p.norTar)*p.norDen;t+=q;0<t&&(t=0);q=t-s;a+=p.norU1X*q;c+=p.norU1Y*q;b+=p.norU1Z*q;g+=p.norTU1X*q;h+=p.norTU1Y*q;k+=p.norTU1Z*q;d-=p.norU2X*q;e-=p.norU2Y*q;f-=p.norU2Z*q;l-=p.norTU2X*q;n-=p.norTU2Y*q;m-=p.norTU2Z*q;p.norImp=t;p.tanImp=z;p.binImp=F;if(p.last)break;p=p.next}this.lv1.x=a;this.lv1.y=c;this.lv1.z=b;this.lv2.x=d;this.lv2.y=e;this.lv2.z=f;this.av1.x=g;this.av1.y=h;this.av1.z=k;this.av2.x=l;this.av2.y=n;this.av2.z=m};
OIMO.ContactConstraint.prototype.postSolve=function(){for(var a=this.cs,c=this.num;c--;){var b=this.ps[c];b.normal.x=a.norX;b.normal.y=a.norY;b.normal.z=a.norZ;b.tangent.x=a.tanX;b.tangent.y=a.tanY;b.tangent.z=a.tanZ;b.binormal.x=a.binX;b.binormal.y=a.binY;b.binormal.z=a.binZ;b.normalImpulse=a.norImp;b.tangentImpulse=a.tanImp;b.binormalImpulse=a.binImp;b.normalDenominator=a.norDen;b.tangentDenominator=a.tanDen;b.binormalDenominator=a.binDen;a=a.next}};OIMO.ContactLink=function(a){this.body=this.shape=this.next=this.prev=null;this.contact=a};OIMO.ContactManifold=function(){this.body2=this.body1=null;this.numPoints=0;this.points=[];this.points.length=4;this.points[0]=new OIMO.ManifoldPoint;this.points[1]=new OIMO.ManifoldPoint;this.points[2]=new OIMO.ManifoldPoint;this.points[3]=new OIMO.ManifoldPoint};
OIMO.ContactManifold.prototype={constructor:OIMO.ContactManifold,reset:function(a,c){this.body1=a.parent;this.body2=c.parent;this.numPoints=0},addPoint:function(a,c,b,d,e,f,g,h){var k=this.points[this.numPoints++];k.position.x=a;k.position.y=c;k.position.z=b;var l=a-this.body1.position.x,n=c-this.body1.position.y,m=b-this.body1.position.z,p=this.body1.rotation.elements;k.localPoint1.x=l*p[0]+n*p[3]+m*p[6];k.localPoint1.y=l*p[1]+n*p[4]+m*p[7];k.localPoint1.z=l*p[2]+n*p[5]+m*p[8];l=a-this.body2.position.x;
n=c-this.body2.position.y;m=b-this.body2.position.z;k.localPoint2.x=l*p[0]+n*p[3]+m*p[6];k.localPoint2.y=l*p[1]+n*p[4]+m*p[7];k.localPoint2.z=l*p[2]+n*p[5]+m*p[8];k.normalImpulse=0;h?(k.normal.x=-d,k.normal.y=-e,k.normal.z=-f):(k.normal.x=d,k.normal.y=e,k.normal.z=f);k.penetration=g;k.warmStarted=!1}};OIMO.ContactPointDataBuffer=function(){this.norTar=this.binDen=this.tanDen=this.norDen=this.binImp=this.tanImp=this.norImp=this.binTU2Z=this.binTU2Y=this.binTU2X=this.binTU1Z=this.binTU1Y=this.binTU1X=this.tanTU2Z=this.tanTU2Y=this.tanTU2X=this.tanTU1Z=this.tanTU1Y=this.tanTU1X=this.norTU2Z=this.norTU2Y=this.norTU2X=this.norTU1Z=this.norTU1Y=this.norTU1X=this.binT2Z=this.binT2Y=this.binT2X=this.binT1Z=this.binT1Y=this.binT1X=this.tanT2Z=this.tanT2Y=this.tanT2X=this.tanT1Z=this.tanT1Y=this.tanT1X=
this.norT2Z=this.norT2Y=this.norT2X=this.norT1Z=this.norT1Y=this.norT1X=this.binU2Z=this.binU2Y=this.binU2X=this.binU1Z=this.binU1Y=this.binU1X=this.tanU2Z=this.tanU2Y=this.tanU2X=this.tanU1Z=this.tanU1Y=this.tanU1X=this.norU2Z=this.norU2Y=this.norU2X=this.norU1Z=this.norU1Y=this.norU1X=this.rp2Z=this.rp2Y=this.rp2X=this.rp1Z=this.rp1Y=this.rp1X=this.binZ=this.binY=this.binX=this.tanZ=this.tanY=this.tanX=this.norZ=this.norY=this.norX=NaN;this.next=null;this.last=!1};OIMO.ImpulseDataBuffer=function(){this.impulse=this.lp2Z=this.lp2Y=this.lp2X=this.lp1Z=this.lp1Y=this.lp1X=NaN};OIMO.ManifoldPoint=function(){this.warmStarted=!1;this.position=new OIMO.Vec3;this.localPoint1=new OIMO.Vec3;this.localPoint2=new OIMO.Vec3;this.normal=new OIMO.Vec3;this.tangent=new OIMO.Vec3;this.binormal=new OIMO.Vec3;this.penetration=this.binormalDenominator=this.tangentDenominator=this.normalDenominator=this.binormalImpulse=this.tangentImpulse=this.normalImpulse=0};OIMO.MassInfo=function(){this.mass=0;this.inertia=new OIMO.Mat33};OIMO.Shape=function(a){this.type=OIMO.SHAPE_NULL;this.id=OIMO.nextID++;this.contactLink=this.parent=this.proxy=this.next=this.prev=null;this.numContacts=0;this.position=new OIMO.Vec3;this.rotation=new OIMO.Mat33;this.relativePosition=(new OIMO.Vec3).copy(a.relativePosition);this.relativeRotation=(new OIMO.Mat33).copy(a.relativeRotation);this.aabb=new OIMO.AABB;this.density=a.density;this.friction=a.friction;this.restitution=a.restitution;this.belongsTo=a.belongsTo;this.collidesWith=a.collidesWith};
OIMO.Shape.prototype={constructor:OIMO.Shape,calculateMassInfo:function(a){OIMO.Error("Shape","Inheritance error.")},updateProxy:function(){OIMO.Error("Shape","Inheritance error.")}};OIMO.ShapeConfig=function(){this.relativePosition=new OIMO.Vec3;this.relativeRotation=new OIMO.Mat33;this.friction=0.4;this.restitution=0.2;this.belongsTo=this.density=1;this.collidesWith=4294967295};OIMO.BoxShape=function(a,c,b,d){OIMO.Shape.call(this,a);this.type=OIMO.SHAPE_BOX;this.width=c;this.height=b;this.depth=d;this.halfWidth=0.5*c;this.halfHeight=0.5*b;this.halfDepth=0.5*d;this.dimentions=new OIMO_ARRAY_TYPE(18);this.elements=new OIMO_ARRAY_TYPE(24)};OIMO.BoxShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.BoxShape.prototype.constructor=OIMO.BoxShape;
OIMO.BoxShape.prototype.calculateMassInfo=function(a){var c=this.width*this.height*this.depth*this.density,b=1/12;a.mass=c;a.inertia.set(c*(this.height*this.height+this.depth*this.depth)*b,0,0,0,c*(this.width*this.width+this.depth*this.depth)*b,0,0,0,c*(this.width*this.width+this.height*this.height)*b)};
OIMO.BoxShape.prototype.updateProxy=function(){var a=this.rotation.elements,c=this.dimentions;c[0]=a[0];c[1]=a[3];c[2]=a[6];c[3]=a[1];c[4]=a[4];c[5]=a[7];c[6]=a[2];c[7]=a[5];c[8]=a[8];c[9]=a[0]*this.halfWidth;c[10]=a[3]*this.halfWidth;c[11]=a[6]*this.halfWidth;c[12]=a[1]*this.halfHeight;c[13]=a[4]*this.halfHeight;c[14]=a[7]*this.halfHeight;c[15]=a[2]*this.halfDepth;c[16]=a[5]*this.halfDepth;c[17]=a[8]*this.halfDepth;var a=c[9],b=c[10],d=c[11],e=c[12],f=c[13],g=c[14],h=c[15],k=c[16],l=c[17],n=this.position.x,
m=this.position.y,p=this.position.z,s=this.elements;s[0]=n+a+e+h;s[1]=m+b+f+k;s[2]=p+d+g+l;s[3]=n+a+e-h;s[4]=m+b+f-k;s[5]=p+d+g-l;s[6]=n+a-e+h;s[7]=m+b-f+k;s[8]=p+d-g+l;s[9]=n+a-e-h;s[10]=m+b-f-k;s[11]=p+d-g-l;s[12]=n-a+e+h;s[13]=m-b+f+k;s[14]=p-d+g+l;s[15]=n-a+e-h;s[16]=m-b+f-k;s[17]=p-d+g-l;s[18]=n-a-e+h;s[19]=m-b-f+k;s[20]=p-d-g+l;s[21]=n-a-e-h;s[22]=m-b-f-k;s[23]=p-d-g-l;a=0>c[9]?-c[9]:c[9];b=0>c[10]?-c[10]:c[10];d=0>c[11]?-c[11]:c[11];a=0>c[12]?a-c[12]:a+c[12];b=0>c[13]?b-c[13]:b+c[13];d=0>c[14]?
d-c[14]:d+c[14];a=0>c[15]?a-c[15]:a+c[15];b=0>c[16]?b-c[16]:b+c[16];d=0>c[17]?d-c[17]:d+c[17];c=OIMO.AABB_PROX;this.aabb.set(this.position.x-a-c,this.position.x+a+c,this.position.y-b-c,this.position.y+b+c,this.position.z-d-c,this.position.z+d+c);null!=this.proxy&&this.proxy.update()};OIMO.SphereShape=function(a,c){OIMO.Shape.call(this,a);this.type=OIMO.SHAPE_SPHERE;this.radius=c};OIMO.SphereShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.SphereShape.prototype.constructor=OIMO.SphereShape;OIMO.SphereShape.prototype.calculateMassInfo=function(a){var c=1.333*OIMO.PI*this.radius*this.radius*this.radius*this.density;a.mass=c;c=c*this.radius*this.radius*0.4;a.inertia.set(c,0,0,0,c,0,0,0,c)};
OIMO.SphereShape.prototype.updateProxy=function(){var a=OIMO.AABB_PROX;this.aabb.set(this.position.x-this.radius-a,this.position.x+this.radius+a,this.position.y-this.radius-a,this.position.y+this.radius+a,this.position.z-this.radius-a,this.position.z+this.radius+a);null!=this.proxy&&this.proxy.update()};OIMO.CylinderShape=function(a,c,b){OIMO.Shape.call(this,a);this.type=OIMO.SHAPE_CYLINDER;this.radius=c;this.height=b;this.halfHeight=0.5*b;this.normalDirection=new OIMO.Vec3;this.halfDirection=new OIMO.Vec3};OIMO.CylinderShape.prototype=Object.create(OIMO.Shape.prototype);OIMO.CylinderShape.prototype.constructor=OIMO.CylinderShape;
OIMO.CylinderShape.prototype.calculateMassInfo=function(a){var c=this.radius*this.radius,b=OIMO.PI*c*this.height*this.density,d=(0.25*c+0.0833*this.height*this.height)*b;a.mass=b;a.inertia.set(d,0,0,0,0.5*c,0,0,0,d)};
OIMO.CylinderShape.prototype.updateProxy=function(){var a=this.rotation.elements,c,b,d,e,f,g;e=a[1]*a[1];f=a[4]*a[4];g=a[7]*a[7];this.normalDirection.set(a[1],a[4],a[7]);this.halfDirection.scale(this.normalDirection,this.halfHeight);a=1-e;c=OIMO.sqrt(a*a+e*f+e*g);0<c&&(c=this.radius/c);a*=c;b=1-f;c=OIMO.sqrt(f*e+b*b+f*g);0<c&&(c=this.radius/c);b*=c;d=1-g;c=OIMO.sqrt(g*e+g*f+d*d);0<c&&(c=this.radius/c);d*=c;e=0>this.halfDirection.x?-this.halfDirection.x:this.halfDirection.x;f=0>this.halfDirection.y?
-this.halfDirection.y:this.halfDirection.y;g=0>this.halfDirection.z?-this.halfDirection.z:this.halfDirection.z;e=0>a?e-a:e+a;f=0>b?f-b:f+b;g=0>d?g-d:g+d;a=OIMO.AABB_PROX;this.aabb.set(this.position.x-e-a,this.position.x+e+a,this.position.y-f-a,this.position.y+f+a,this.position.z-g-a,this.position.z+g+a);null!=this.proxy&&this.proxy.update()};OIMO.CollisionDetector=function(){this.flip=!1};OIMO.CollisionDetector.prototype={constructor:OIMO.CollisionDetector,detectCollision:function(a,c,b){OIMO.Error("CollisionDetector","Inheritance error.")}};OIMO.BoxBoxCollisionDetector=function(){OIMO.CollisionDetector.call(this);this.clipVertices1=new OIMO_ARRAY_TYPE(24);this.clipVertices2=new OIMO_ARRAY_TYPE(24);this.used=new OIMO_ARRAY_TYPE(8);this.INF=1/0};OIMO.BoxBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.BoxBoxCollisionDetector.prototype.constructor=OIMO.BoxBoxCollisionDetector;
OIMO.BoxBoxCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;a.id<c.id?(d=a,e=c):(d=c,e=a);var f=d.elements,g=e.elements,h=d.dimentions,k=e.dimentions,l=d.position,n=e.position,m=l.x,p=l.y,s=l.z,q=n.x,u=n.y,r=n.z,t=q-m,z=u-p,F=r-s,J=d.halfWidth,H=d.halfHeight,B=d.halfDepth,I=e.halfWidth,K=e.halfHeight,x=e.halfDepth,C=h[0],v=h[1],L=h[2],O=h[3],P=h[4],Q=h[5],S=h[6],M=h[7],N=h[8],U=h[9],V=h[10],Pa=h[11],Ca=h[12],Da=h[13],Ea=h[14],Ka=h[15],La=h[16],X=h[17],D=k[0],E=k[1],R=k[2],Y=k[3],
Z=k[4],ha=k[5],da=k[6],ja=k[7],ka=k[8],ea=k[9],fa=k[10],W=k[11],$=k[12],sa=k[13],ta=k[14],ya=k[15],za=k[16],Aa=k[17],yb=v*R-L*E,Nb=L*D-C*R,Ob=C*E-v*D,Pb=v*ha-L*Z,dc=L*Y-C*ha,ec=C*Z-v*Y,fc=v*ka-L*ja,gc=L*da-C*ka,hc=C*ja-v*da,Qa=P*R-Q*E,Ra=Q*D-O*R,Sa=O*E-P*D,Ga=P*ha-Q*Z,Za=Q*Y-O*ha,db=O*Z-P*Y,la=P*ka-Q*ja,ma=Q*da-O*ka,na=O*ja-P*da,eb=M*R-N*E,fb=N*D-S*R,gb=S*E-M*D,hb=M*ha-N*Z,Ab=N*Y-S*ha,Bb=S*Z-M*Y,Cb=M*ka-N*ja,Db=N*da-S*ka,Eb=S*ja-M*da,qc,Ma,Na,Oa,ia,nb,ib,jb,ra,Ba,ob,ua,Kb,Lb,Mb,Fb,Gb,Hb,pb,qb,pc,
Qb,Rb,Sb,Tb,Ub,Vb,Wb,Xb,ic,rc=!1,sc=!1,T=!1,Kc=!1,Lc=!1,Mc=!1,Nc=!1,Oc=!1,Pc=!1,A,Ta,Ua,w,y,Va;A=C*t+v*z+L*F;(qc=0<A)||(A=-A);Ta=J;w=C*D+v*E+L*R;y=C*Y+v*Z+L*ha;Va=C*da+v*ja+L*ka;0>w&&(w=-w);0>y&&(y=-y);0>Va&&(Va=-Va);Ua=w*I+y*K+Va*x;Fb=A-Ta-Ua;if(!(0<Fb||(A=O*t+P*z+Q*F,(Ma=0<A)||(A=-A),Ta=H,w=O*D+P*E+Q*R,y=O*Y+P*Z+Q*ha,Va=O*da+P*ja+Q*ka,0>w&&(w=-w),0>y&&(y=-y),0>Va&&(Va=-Va),Ua=w*I+y*K+Va*x,Gb=A-Ta-Ua,0<Gb||(A=S*t+M*z+N*F,(Na=0<A)||(A=-A),Ta=B,w=S*D+M*E+N*R,y=S*Y+M*Z+N*ha,Va=S*da+M*ja+N*ka,0>w&&(w=
-w),0>y&&(y=-y),0>Va&&(Va=-Va),Ua=w*I+y*K+Va*x,Hb=A-Ta-Ua,0<Hb||(A=D*t+E*z+R*F,(Oa=0<A)||(A=-A),w=D*C+E*v+R*L,y=D*O+E*P+R*Q,Va=D*S+E*M+R*N,0>w&&(w=-w),0>y&&(y=-y),0>Va&&(Va=-Va),Ta=w*J+y*H+Va*B,Ua=I,pb=1*(A-Ta-Ua),0<pb||(A=Y*t+Z*z+ha*F,(ia=0<A)||(A=-A),w=Y*C+Z*v+ha*L,y=Y*O+Z*P+ha*Q,Va=Y*S+Z*M+ha*N,0>w&&(w=-w),0>y&&(y=-y),0>Va&&(Va=-Va),Ta=w*J+y*H+Va*B,Ua=K,qb=1*(A-Ta-Ua),0<qb||(A=da*t+ja*z+ka*F,(nb=0<A)||(A=-A),w=da*C+ja*v+ka*L,y=da*O+ja*P+ka*Q,Va=da*S+ja*M+ka*N,0>w&&(w=-w),0>y&&(y=-y),0>Va&&(Va=
-Va),Ta=w*J+y*H+Va*B,Ua=x,pc=1*(A-Ta-Ua),0<pc))))))){A=yb*yb+Nb*Nb+Ob*Ob;if(1E-5<A){if(A=1/OIMO.sqrt(A),yb*=A,Nb*=A,Ob*=A,A=yb*t+Nb*z+Ob*F,(ib=0<A)||(A=-A),w=yb*O+Nb*P+Ob*Q,y=yb*S+Nb*M+Ob*N,0>w&&(w=-w),0>y&&(y=-y),Ta=w*H+y*B,w=yb*Y+Nb*Z+Ob*ha,y=yb*da+Nb*ja+Ob*ka,0>w&&(w=-w),0>y&&(y=-y),Ua=w*K+y*x,Qb=A-Ta-Ua,0<Qb)return}else ib=!1,Qb=0,rc=!0;A=Pb*Pb+dc*dc+ec*ec;if(1E-5<A){if(A=1/OIMO.sqrt(A),Pb*=A,dc*=A,ec*=A,A=Pb*t+dc*z+ec*F,(jb=0<A)||(A=-A),w=Pb*O+dc*P+ec*Q,y=Pb*S+dc*M+ec*N,0>w&&(w=-w),0>y&&(y=-y),
Ta=w*H+y*B,w=Pb*D+dc*E+ec*R,y=Pb*da+dc*ja+ec*ka,0>w&&(w=-w),0>y&&(y=-y),Ua=w*I+y*x,Rb=A-Ta-Ua,0<Rb)return}else jb=!1,Rb=0,sc=!0;A=fc*fc+gc*gc+hc*hc;if(1E-5<A){if(A=1/OIMO.sqrt(A),fc*=A,gc*=A,hc*=A,A=fc*t+gc*z+hc*F,(ra=0<A)||(A=-A),w=fc*O+gc*P+hc*Q,y=fc*S+gc*M+hc*N,0>w&&(w=-w),0>y&&(y=-y),Ta=w*H+y*B,w=fc*D+gc*E+hc*R,y=fc*Y+gc*Z+hc*ha,0>w&&(w=-w),0>y&&(y=-y),Ua=w*I+y*K,Sb=A-Ta-Ua,0<Sb)return}else ra=!1,Sb=0,T=!0;A=Qa*Qa+Ra*Ra+Sa*Sa;if(1E-5<A){if(A=1/OIMO.sqrt(A),Qa*=A,Ra*=A,Sa*=A,A=Qa*t+Ra*z+Sa*F,(Ba=
0<A)||(A=-A),w=Qa*C+Ra*v+Sa*L,y=Qa*S+Ra*M+Sa*N,0>w&&(w=-w),0>y&&(y=-y),Ta=w*J+y*B,w=Qa*Y+Ra*Z+Sa*ha,y=Qa*da+Ra*ja+Sa*ka,0>w&&(w=-w),0>y&&(y=-y),Ua=w*K+y*x,Tb=A-Ta-Ua,0<Tb)return}else Ba=!1,Tb=0,Kc=!0;A=Ga*Ga+Za*Za+db*db;if(1E-5<A){if(A=1/OIMO.sqrt(A),Ga*=A,Za*=A,db*=A,A=Ga*t+Za*z+db*F,(ob=0<A)||(A=-A),w=Ga*C+Za*v+db*L,y=Ga*S+Za*M+db*N,0>w&&(w=-w),0>y&&(y=-y),Ta=w*J+y*B,w=Ga*D+Za*E+db*R,y=Ga*da+Za*ja+db*ka,0>w&&(w=-w),0>y&&(y=-y),Ua=w*I+y*x,Ub=A-Ta-Ua,0<Ub)return}else ob=!1,Ub=0,Lc=!0;A=la*la+ma*ma+
na*na;if(1E-5<A){if(A=1/OIMO.sqrt(A),la*=A,ma*=A,na*=A,A=la*t+ma*z+na*F,(ua=0<A)||(A=-A),w=la*C+ma*v+na*L,y=la*S+ma*M+na*N,0>w&&(w=-w),0>y&&(y=-y),Ta=w*J+y*B,w=la*D+ma*E+na*R,y=la*Y+ma*Z+na*ha,0>w&&(w=-w),0>y&&(y=-y),Ua=w*I+y*K,Vb=A-Ta-Ua,0<Vb)return}else ua=!1,Vb=0,Mc=!0;A=eb*eb+fb*fb+gb*gb;if(1E-5<A){if(A=1/OIMO.sqrt(A),eb*=A,fb*=A,gb*=A,A=eb*t+fb*z+gb*F,(Kb=0<A)||(A=-A),w=eb*C+fb*v+gb*L,y=eb*O+fb*P+gb*Q,0>w&&(w=-w),0>y&&(y=-y),Ta=w*J+y*H,w=eb*Y+fb*Z+gb*ha,y=eb*da+fb*ja+gb*ka,0>w&&(w=-w),0>y&&(y=
-y),Ua=w*K+y*x,Wb=A-Ta-Ua,0<Wb)return}else Kb=!1,Wb=0,Nc=!0;A=hb*hb+Ab*Ab+Bb*Bb;if(1E-5<A){if(A=1/OIMO.sqrt(A),hb*=A,Ab*=A,Bb*=A,A=hb*t+Ab*z+Bb*F,(Lb=0<A)||(A=-A),w=hb*C+Ab*v+Bb*L,y=hb*O+Ab*P+Bb*Q,0>w&&(w=-w),0>y&&(y=-y),Ta=w*J+y*H,w=hb*D+Ab*E+Bb*R,y=hb*da+Ab*ja+Bb*ka,0>w&&(w=-w),0>y&&(y=-y),Ua=w*I+y*x,Xb=A-Ta-Ua,0<Xb)return}else Lb=!1,Xb=0,Oc=!0;A=Cb*Cb+Db*Db+Eb*Eb;if(1E-5<A){if(A=1/OIMO.sqrt(A),Cb*=A,Db*=A,Eb*=A,A=Cb*t+Db*z+Eb*F,(Mb=0<A)||(A=-A),w=Cb*C+Db*v+Eb*L,y=Cb*O+Db*P+Eb*Q,0>w&&(w=-w),0>y&&
(y=-y),Ta=w*J+y*H,w=Cb*D+Db*E+Eb*R,y=Cb*Y+Db*Z+Eb*ha,0>w&&(w=-w),0>y&&(y=-y),Ua=w*I+y*K,ic=A-Ta-Ua,0<ic)return}else Mb=!1,ic=0,Pc=!0;var Ib=Fb,cb=Fb,Wa=0,zb=qc;Gb>cb&&(cb=Ib=Gb,Wa=1,zb=Ma);Hb>cb&&(cb=Ib=Hb,Wa=2,zb=Na);pb>cb&&(cb=Ib=pb,Wa=3,zb=Oa);qb>cb&&(cb=Ib=qb,Wa=4,zb=ia);pc>cb&&(cb=Ib=pc,Wa=5,zb=nb);Qb-0.01>cb&&!rc&&(Ib=Qb,cb=Qb-0.01,Wa=6,zb=ib);Rb-0.01>cb&&!sc&&(Ib=Rb,cb=Rb-0.01,Wa=7,zb=jb);Sb-0.01>cb&&!T&&(Ib=Sb,cb=Sb-0.01,Wa=8,zb=ra);Tb-0.01>cb&&!Kc&&(Ib=Tb,cb=Tb-0.01,Wa=9,zb=Ba);Ub-0.01>cb&&
!Lc&&(Ib=Ub,cb=Ub-0.01,Wa=10,zb=ob);Vb-0.01>cb&&!Mc&&(Ib=Vb,cb=Vb-0.01,Wa=11,zb=ua);Wb-0.01>cb&&!Nc&&(Ib=Wb,cb=Wb-0.01,Wa=12,zb=Kb);Xb-0.01>cb&&!Oc&&(Ib=Xb,cb=Xb-0.01,Wa=13,zb=Lb);ic-0.01>cb&&!Pc&&(Ib=ic,Wa=14,zb=Mb);var aa=0,ba=0,ca=0,rb=0,sb=0,tb=0,vb=0,wb=0,xb=0,kb=0,lb=0,mb=0,wc=0,xc=0,yc=0,zc=0,Ac=0,Bc=0,Fc=!1;0==Wa?(zb?(kb=m+U,lb=p+V,mb=s+Pa,aa=C,ba=v,ca=L):(kb=m-U,lb=p-V,mb=s-Pa,aa=-C,ba=-v,ca=-L),wc=Ca,xc=Da,yc=Ea,rb=-O,sb=-P,tb=-Q,zc=Ka,Ac=La,Bc=X,vb=-S,wb=-M,xb=-N):1==Wa?(zb?(kb=m+Ca,lb=
p+Da,mb=s+Ea,aa=O,ba=P,ca=Q):(kb=m-Ca,lb=p-Da,mb=s-Ea,aa=-O,ba=-P,ca=-Q),wc=U,xc=V,yc=Pa,rb=-C,sb=-v,tb=-L,zc=Ka,Ac=La,Bc=X,vb=-S,wb=-M,xb=-N):2==Wa?(zb?(kb=m+Ka,lb=p+La,mb=s+X,aa=S,ba=M,ca=N):(kb=m-Ka,lb=p-La,mb=s-X,aa=-S,ba=-M,ca=-N),wc=U,xc=V,yc=Pa,rb=-C,sb=-v,tb=-L,zc=Ca,Ac=Da,Bc=Ea,vb=-O,wb=-P,xb=-Q):3==Wa?(Fc=!0,zb?(kb=q-ea,lb=u-fa,mb=r-W,aa=-D,ba=-E,ca=-R):(kb=q+ea,lb=u+fa,mb=r+W,aa=D,ba=E,ca=R),wc=$,xc=sa,yc=ta,rb=-Y,sb=-Z,tb=-ha,zc=ya,Ac=za,Bc=Aa,vb=-da,wb=-ja,xb=-ka):4==Wa?(Fc=!0,zb?(kb=
q-$,lb=u-sa,mb=r-ta,aa=-Y,ba=-Z,ca=-ha):(kb=q+$,lb=u+sa,mb=r+ta,aa=Y,ba=Z,ca=ha),wc=ea,xc=fa,yc=W,rb=-D,sb=-E,tb=-R,zc=ya,Ac=za,Bc=Aa,vb=-da,wb=-ja,xb=-ka):5==Wa?(Fc=!0,zb?(kb=q-ya,lb=u-za,mb=r-Aa,aa=-da,ba=-ja,ca=-ka):(kb=q+ya,lb=u+za,mb=r+Aa,aa=da,ba=ja,ca=ka),wc=ea,xc=fa,yc=W,rb=-D,sb=-E,tb=-R,zc=$,Ac=sa,Bc=ta,vb=-Y,wb=-Z,xb=-ha):6==Wa?(aa=yb,ba=Nb,ca=Ob,rb=C,sb=v,tb=L,vb=D,wb=E,xb=R):7==Wa?(aa=Pb,ba=dc,ca=ec,rb=C,sb=v,tb=L,vb=Y,wb=Z,xb=ha):8==Wa?(aa=fc,ba=gc,ca=hc,rb=C,sb=v,tb=L,vb=da,wb=ja,xb=
ka):9==Wa?(aa=Qa,ba=Ra,ca=Sa,rb=O,sb=P,tb=Q,vb=D,wb=E,xb=R):10==Wa?(aa=Ga,ba=Za,ca=db,rb=O,sb=P,tb=Q,vb=Y,wb=Z,xb=ha):11==Wa?(aa=la,ba=ma,ca=na,rb=O,sb=P,tb=Q,vb=da,wb=ja,xb=ka):12==Wa?(aa=eb,ba=fb,ca=gb,rb=S,sb=M,tb=N,vb=D,wb=E,xb=R):13==Wa?(aa=hb,ba=Ab,ca=Bb,rb=S,sb=M,tb=N,vb=Y,wb=Z,xb=ha):14==Wa&&(aa=Cb,ba=Db,ca=Eb,rb=S,sb=M,tb=N,vb=da,wb=ja,xb=ka);if(5<Wa){zb||(aa=-aa,ba=-ba,ca=-ca);var Fa,Xa,va,wa,xa,tc,uc,vc,Cc,Dc,Ec;tc=f[0];uc=f[1];vc=f[2];Xa=aa*tc+ba*uc+ca*vc;va=f[3];wa=f[4];xa=f[5];Fa=aa*
va+ba*wa+ca*xa;Fa>Xa&&(Xa=Fa,tc=va,uc=wa,vc=xa);va=f[6];wa=f[7];xa=f[8];Fa=aa*va+ba*wa+ca*xa;Fa>Xa&&(Xa=Fa,tc=va,uc=wa,vc=xa);va=f[9];wa=f[10];xa=f[11];Fa=aa*va+ba*wa+ca*xa;Fa>Xa&&(Xa=Fa,tc=va,uc=wa,vc=xa);va=f[12];wa=f[13];xa=f[14];Fa=aa*va+ba*wa+ca*xa;Fa>Xa&&(Xa=Fa,tc=va,uc=wa,vc=xa);va=f[15];wa=f[16];xa=f[17];Fa=aa*va+ba*wa+ca*xa;Fa>Xa&&(Xa=Fa,tc=va,uc=wa,vc=xa);va=f[18];wa=f[19];xa=f[20];Fa=aa*va+ba*wa+ca*xa;Fa>Xa&&(Xa=Fa,tc=va,uc=wa,vc=xa);va=f[21];wa=f[22];xa=f[23];Fa=aa*va+ba*wa+ca*xa;Fa>Xa&&
(Xa=Fa,tc=va,uc=wa,vc=xa);Cc=g[0];Dc=g[1];Ec=g[2];Xa=aa*Cc+ba*Dc+ca*Ec;va=g[3];wa=g[4];xa=g[5];Fa=aa*va+ba*wa+ca*xa;Fa<Xa&&(Xa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[6];wa=g[7];xa=g[8];Fa=aa*va+ba*wa+ca*xa;Fa<Xa&&(Xa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[9];wa=g[10];xa=g[11];Fa=aa*va+ba*wa+ca*xa;Fa<Xa&&(Xa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[12];wa=g[13];xa=g[14];Fa=aa*va+ba*wa+ca*xa;Fa<Xa&&(Xa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[15];wa=g[16];xa=g[17];Fa=aa*va+ba*wa+ca*xa;Fa<Xa&&(Xa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[18];wa=g[19];xa=g[20];Fa=aa*
va+ba*wa+ca*xa;Fa<Xa&&(Xa=Fa,Cc=va,Dc=wa,Ec=xa);va=g[21];wa=g[22];xa=g[23];Fa=aa*va+ba*wa+ca*xa;Fa<Xa&&(Xa=Fa,Cc=va,Dc=wa,Ec=xa);va=Cc-tc;wa=Dc-uc;xa=Ec-vc;w=rb*vb+sb*wb+tb*xb;var Ia=(va*(rb-vb*w)+wa*(sb-wb*w)+xa*(tb-xb*w))/(1-w*w);b.addPoint(tc+rb*Ia+aa*Ib*0.5,uc+sb*Ia+ba*Ib*0.5,vc+tb*Ia+ca*Ib*0.5,aa,ba,ca,Ib,!1)}else{var Yb,Zb,$b,ac,bc,cc,jc,kc,lc,mc,nc,oc,Ya=1,ga=0,ub=0;Fc?(ga=C*aa+v*ba+L*ca,ga<Ya&&(Ya=ga,ub=0),-ga<Ya&&(Ya=-ga,ub=1),ga=O*aa+P*ba+Q*ca,ga<Ya&&(Ya=ga,ub=2),-ga<Ya&&(Ya=-ga,ub=3),ga=
S*aa+M*ba+N*ca,ga<Ya&&(Ya=ga,ub=4),-ga<Ya&&(Ya=-ga,ub=5),0==ub?(Yb=f[0],Zb=f[1],$b=f[2],ac=f[6],bc=f[7],cc=f[8],jc=f[9],kc=f[10],lc=f[11],mc=f[3],nc=f[4],oc=f[5]):1==ub?(Yb=f[15],Zb=f[16],$b=f[17],ac=f[21],bc=f[22],cc=f[23],jc=f[18],kc=f[19],lc=f[20],mc=f[12],nc=f[13],oc=f[14]):2==ub?(Yb=f[12],Zb=f[13],$b=f[14],ac=f[0],bc=f[1],cc=f[2],jc=f[3],kc=f[4],lc=f[5],mc=f[15],nc=f[16],oc=f[17]):3==ub?(Yb=f[21],Zb=f[22],$b=f[23],ac=f[9],bc=f[10],cc=f[11],jc=f[6],kc=f[7],lc=f[8],mc=f[18],nc=f[19],oc=f[20]):
4==ub?(Yb=f[12],Zb=f[13],$b=f[14],ac=f[18],bc=f[19],cc=f[20],jc=f[6],kc=f[7],lc=f[8],mc=f[0],nc=f[1],oc=f[2]):5==ub&&(Yb=f[3],Zb=f[4],$b=f[5],ac=f[6],bc=f[7],cc=f[8],jc=f[21],kc=f[22],lc=f[23],mc=f[15],nc=f[16],oc=f[17])):(ga=D*aa+E*ba+R*ca,ga<Ya&&(Ya=ga,ub=0),-ga<Ya&&(Ya=-ga,ub=1),ga=Y*aa+Z*ba+ha*ca,ga<Ya&&(Ya=ga,ub=2),-ga<Ya&&(Ya=-ga,ub=3),ga=da*aa+ja*ba+ka*ca,ga<Ya&&(Ya=ga,ub=4),-ga<Ya&&(Ya=-ga,ub=5),0==ub?(Yb=g[0],Zb=g[1],$b=g[2],ac=g[6],bc=g[7],cc=g[8],jc=g[9],kc=g[10],lc=g[11],mc=g[3],nc=g[4],
oc=g[5]):1==ub?(Yb=g[15],Zb=g[16],$b=g[17],ac=g[21],bc=g[22],cc=g[23],jc=g[18],kc=g[19],lc=g[20],mc=g[12],nc=g[13],oc=g[14]):2==ub?(Yb=g[12],Zb=g[13],$b=g[14],ac=g[0],bc=g[1],cc=g[2],jc=g[3],kc=g[4],lc=g[5],mc=g[15],nc=g[16],oc=g[17]):3==ub?(Yb=g[21],Zb=g[22],$b=g[23],ac=g[9],bc=g[10],cc=g[11],jc=g[6],kc=g[7],lc=g[8],mc=g[18],nc=g[19],oc=g[20]):4==ub?(Yb=g[12],Zb=g[13],$b=g[14],ac=g[18],bc=g[19],cc=g[20],jc=g[6],kc=g[7],lc=g[8],mc=g[0],nc=g[1],oc=g[2]):5==ub&&(Yb=g[3],Zb=g[4],$b=g[5],ac=g[9],bc=g[10],
cc=g[11],jc=g[21],kc=g[22],lc=g[23],mc=g[15],nc=g[16],oc=g[17]));var Jb,Ha,G,oa,pa,qa,$a,ab,bb;this.clipVertices1[0]=Yb;this.clipVertices1[1]=Zb;this.clipVertices1[2]=$b;this.clipVertices1[3]=ac;this.clipVertices1[4]=bc;this.clipVertices1[5]=cc;this.clipVertices1[6]=jc;this.clipVertices1[7]=kc;this.clipVertices1[8]=lc;this.clipVertices1[9]=mc;this.clipVertices1[10]=nc;this.clipVertices1[11]=oc;Ha=0;oa=this.clipVertices1[9];pa=this.clipVertices1[10];qa=this.clipVertices1[11];w=(oa-kb-wc)*rb+(pa-lb-
xc)*sb+(qa-mb-yc)*tb;for(var Ja=0;4>Ja;Ja++)G=3*Ja,$a=this.clipVertices1[G],ab=this.clipVertices1[G+1],bb=this.clipVertices1[G+2],y=($a-kb-wc)*rb+(ab-lb-xc)*sb+(bb-mb-yc)*tb,0<w?0<y?(G=3*Ha,Ha++,this.clipVertices2[G]=$a,this.clipVertices2[G+1]=ab,this.clipVertices2[G+2]=bb):(G=3*Ha,Ha++,Ia=w/(w-y),this.clipVertices2[G]=oa+($a-oa)*Ia,this.clipVertices2[G+1]=pa+(ab-pa)*Ia,this.clipVertices2[G+2]=qa+(bb-qa)*Ia):0<y&&(G=3*Ha,Ha++,Ia=w/(w-y),this.clipVertices2[G]=oa+($a-oa)*Ia,this.clipVertices2[G+1]=
pa+(ab-pa)*Ia,this.clipVertices2[G+2]=qa+(bb-qa)*Ia,G=3*Ha,Ha++,this.clipVertices2[G]=$a,this.clipVertices2[G+1]=ab,this.clipVertices2[G+2]=bb),oa=$a,pa=ab,qa=bb,w=y;Jb=Ha;if(0!=Jb){Ha=0;G=3*(Jb-1);oa=this.clipVertices2[G];pa=this.clipVertices2[G+1];qa=this.clipVertices2[G+2];w=(oa-kb-zc)*vb+(pa-lb-Ac)*wb+(qa-mb-Bc)*xb;for(Ja=0;Ja<Jb;Ja++)G=3*Ja,$a=this.clipVertices2[G],ab=this.clipVertices2[G+1],bb=this.clipVertices2[G+2],y=($a-kb-zc)*vb+(ab-lb-Ac)*wb+(bb-mb-Bc)*xb,0<w?0<y?(G=3*Ha,Ha++,this.clipVertices1[G]=
$a,this.clipVertices1[G+1]=ab,this.clipVertices1[G+2]=bb):(G=3*Ha,Ha++,Ia=w/(w-y),this.clipVertices1[G]=oa+($a-oa)*Ia,this.clipVertices1[G+1]=pa+(ab-pa)*Ia,this.clipVertices1[G+2]=qa+(bb-qa)*Ia):0<y&&(G=3*Ha,Ha++,Ia=w/(w-y),this.clipVertices1[G]=oa+($a-oa)*Ia,this.clipVertices1[G+1]=pa+(ab-pa)*Ia,this.clipVertices1[G+2]=qa+(bb-qa)*Ia,G=3*Ha,Ha++,this.clipVertices1[G]=$a,this.clipVertices1[G+1]=ab,this.clipVertices1[G+2]=bb),oa=$a,pa=ab,qa=bb,w=y;Jb=Ha;if(0!=Jb){Ha=0;G=3*(Jb-1);oa=this.clipVertices1[G];
pa=this.clipVertices1[G+1];qa=this.clipVertices1[G+2];w=(oa-kb+wc)*-rb+(pa-lb+xc)*-sb+(qa-mb+yc)*-tb;for(Ja=0;Ja<Jb;Ja++)G=3*Ja,$a=this.clipVertices1[G],ab=this.clipVertices1[G+1],bb=this.clipVertices1[G+2],y=($a-kb+wc)*-rb+(ab-lb+xc)*-sb+(bb-mb+yc)*-tb,0<w?0<y?(G=3*Ha,Ha++,this.clipVertices2[G]=$a,this.clipVertices2[G+1]=ab,this.clipVertices2[G+2]=bb):(G=3*Ha,Ha++,Ia=w/(w-y),this.clipVertices2[G]=oa+($a-oa)*Ia,this.clipVertices2[G+1]=pa+(ab-pa)*Ia,this.clipVertices2[G+2]=qa+(bb-qa)*Ia):0<y&&(G=3*
Ha,Ha++,Ia=w/(w-y),this.clipVertices2[G]=oa+($a-oa)*Ia,this.clipVertices2[G+1]=pa+(ab-pa)*Ia,this.clipVertices2[G+2]=qa+(bb-qa)*Ia,G=3*Ha,Ha++,this.clipVertices2[G]=$a,this.clipVertices2[G+1]=ab,this.clipVertices2[G+2]=bb),oa=$a,pa=ab,qa=bb,w=y;Jb=Ha;if(0!=Jb){Ha=0;G=3*(Jb-1);oa=this.clipVertices2[G];pa=this.clipVertices2[G+1];qa=this.clipVertices2[G+2];w=(oa-kb+zc)*-vb+(pa-lb+Ac)*-wb+(qa-mb+Bc)*-xb;for(Ja=0;Ja<Jb;Ja++)G=3*Ja,$a=this.clipVertices2[G],ab=this.clipVertices2[G+1],bb=this.clipVertices2[G+
2],y=($a-kb+zc)*-vb+(ab-lb+Ac)*-wb+(bb-mb+Bc)*-xb,0<w?0<y?(G=3*Ha,Ha++,this.clipVertices1[G]=$a,this.clipVertices1[G+1]=ab,this.clipVertices1[G+2]=bb):(G=3*Ha,Ha++,Ia=w/(w-y),this.clipVertices1[G]=oa+($a-oa)*Ia,this.clipVertices1[G+1]=pa+(ab-pa)*Ia,this.clipVertices1[G+2]=qa+(bb-qa)*Ia):0<y&&(G=3*Ha,Ha++,Ia=w/(w-y),this.clipVertices1[G]=oa+($a-oa)*Ia,this.clipVertices1[G+1]=pa+(ab-pa)*Ia,this.clipVertices1[G+2]=qa+(bb-qa)*Ia,G=3*Ha,Ha++,this.clipVertices1[G]=$a,this.clipVertices1[G+1]=ab,this.clipVertices1[G+
2]=bb),oa=$a,pa=ab,qa=bb,w=y;Jb=Ha;if(Fc){var Sc=d;d=e;e=Sc}if(0!=Jb){var Gc=d!=a;if(4<Jb){oa=0.25*(Yb+ac+jc+mc);pa=0.25*(Zb+bc+kc+nc);qa=0.25*($b+cc+lc+oc);for(var rb=Yb-oa,sb=Zb-pa,tb=$b-qa,vb=ac-oa,wb=bc-pa,xb=cc-qa,Ic=0,Qc=0,Jc=0,Rc=0,Hc=-this.INF,Ya=this.INF,Ja=0;Ja<Jb;Ja++)this.used[Ja]=!1,G=3*Ja,oa=this.clipVertices1[G],pa=this.clipVertices1[G+1],qa=this.clipVertices1[G+2],ga=oa*rb+pa*sb+qa*tb,ga<Ya&&(Ya=ga,Ic=Ja),ga>Hc&&(Hc=ga,Jc=Ja);this.used[Ic]=!0;this.used[Jc]=!0;Hc=-this.INF;Ya=this.INF;
for(Ja=0;Ja<Jb;Ja++)this.used[Ja]||(G=3*Ja,oa=this.clipVertices1[G],pa=this.clipVertices1[G+1],qa=this.clipVertices1[G+2],ga=oa*vb+pa*wb+qa*xb,ga<Ya&&(Ya=ga,Qc=Ja),ga>Hc&&(Hc=ga,Rc=Ja));G=3*Ic;oa=this.clipVertices1[G];pa=this.clipVertices1[G+1];qa=this.clipVertices1[G+2];ga=(oa-kb)*aa+(pa-lb)*ba+(qa-mb)*ca;0>ga&&b.addPoint(oa,pa,qa,aa,ba,ca,ga,Gc);G=3*Qc;oa=this.clipVertices1[G];pa=this.clipVertices1[G+1];qa=this.clipVertices1[G+2];ga=(oa-kb)*aa+(pa-lb)*ba+(qa-mb)*ca;0>ga&&b.addPoint(oa,pa,qa,aa,
ba,ca,ga,Gc);G=3*Jc;oa=this.clipVertices1[G];pa=this.clipVertices1[G+1];qa=this.clipVertices1[G+2];ga=(oa-kb)*aa+(pa-lb)*ba+(qa-mb)*ca;0>ga&&b.addPoint(oa,pa,qa,aa,ba,ca,ga,Gc);G=3*Rc;oa=this.clipVertices1[G];pa=this.clipVertices1[G+1];qa=this.clipVertices1[G+2];ga=(oa-kb)*aa+(pa-lb)*ba+(qa-mb)*ca;0>ga&&b.addPoint(oa,pa,qa,aa,ba,ca,ga,Gc)}else for(Ja=0;Ja<Jb;Ja++)G=3*Ja,oa=this.clipVertices1[G],pa=this.clipVertices1[G+1],qa=this.clipVertices1[G+2],ga=(oa-kb)*aa+(pa-lb)*ba+(qa-mb)*ca,0>ga&&b.addPoint(oa,
pa,qa,aa,ba,ca,ga,Gc)}}}}}}};OIMO.SphereBoxCollisionDetector=function(a){OIMO.CollisionDetector.call(this);this.flip=a};OIMO.SphereBoxCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereBoxCollisionDetector.prototype.constructor=OIMO.SphereBoxCollisionDetector;
OIMO.SphereBoxCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;this.flip?(d=c,e=a):(d=a,e=c);var f=e.dimentions,g=d.position;a=g.x;c=g.y;var h=g.z,k=e.position,l=k.x,n=k.y,k=k.z;d=d.radius;var m=e.halfWidth,p=e.halfHeight,s=e.halfDepth;e=a-l;var q=c-n,u=h-k,r=f[0]*e+f[1]*q+f[2]*u,t=f[3]*e+f[4]*q+f[5]*u,z=f[6]*e+f[7]*q+f[8]*u;e=0;r>m?r=m:r<-m?r=-m:e=1;t>p?t=p:t<-p?t=-p:e|=2;z>s?z=s:z<-s?z=-s:e|=4;7==e?(e=0>r?m+r:m-r,q=0>t?p+t:p-t,u=0>z?s+z:s-z,e<q?e<u?(g=e-m,0>r?(e=f[0],q=f[1],u=
f[2]):(e=-f[0],q=-f[1],u=-f[2])):(g=u-s,0>z?(e=f[6],q=f[7],u=f[8]):(e=-f[6],q=-f[7],u=-f[8])):q<u?(g=q-p,0>t?(e=f[3],q=f[4],u=f[5]):(e=-f[3],q=-f[4],u=-f[5])):(g=u-s,0>z?(e=f[6],q=f[7],u=f[8]):(e=-f[6],q=-f[7],u=-f[8])),b.addPoint(a+d*e,c+d*q,h+d*u,e,q,u,g-d,this.flip)):(l=l+r*f[0]+t*f[3]+z*f[6],n=n+r*f[1]+t*f[4]+z*f[7],f=k+r*f[2]+t*f[5]+z*f[8],e=l-g.x,q=n-g.y,u=f-g.z,g=e*e+q*q+u*u,0<g&&g<d*d&&(g=OIMO.sqrt(g),f=1/g,e*=f,q*=f,u*=f,b.addPoint(a+d*e,c+d*q,h+d*u,e,q,u,g-d,this.flip)))};OIMO.SphereSphereCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.SphereSphereCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereSphereCollisionDetector.prototype.constructor=OIMO.SphereSphereCollisionDetector;
OIMO.SphereSphereCollisionDetector.prototype.detectCollision=function(a,c,b){var d=a.position,e=c.position,f=e.x-d.x,g=e.y-d.y,e=e.z-d.z,h=f*f+g*g+e*e;a=a.radius;c=a+c.radius;if(0<h&&h<c*c){var h=OIMO.sqrt(h),k=1/h,f=f*k,g=g*k,e=e*k;b.addPoint(d.x+f*a,d.y+g*a,d.z+e*a,f,g,e,h-c,!1)}};OIMO.BoxCylinderCollisionDetector=function(a){OIMO.CollisionDetector.call(this);this.flip=a};OIMO.BoxCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.BoxCylinderCollisionDetector.prototype.constructor=OIMO.BoxCylinderCollisionDetector;
OIMO.BoxCylinderCollisionDetector.prototype.getSep=function(a,c,b,d,e){var f,g,h,k,l,n,m=new OIMO.Vec3,p,s,q,u,r,t,z=a.position.x,F=a.position.y,J=a.position.z,H=c.position.x,B=c.position.y,I=c.position.z,K=H-z,x=B-F,C=I-J;0==K*K+x*x+C*C&&(x=0.001);var v=-K;n=-x;k=-C;this.supportPointB(a,-v,-n,-k,m);var L=m.x,O=m.y,P=m.z;this.supportPointC(c,v,n,k,m);var Q=m.x,S=m.y,M=m.z,N=Q-L,U=S-O,V=M-P;if(0>=N*v+U*n+V*k)return!1;v=U*C-V*x;n=V*K-N*C;k=N*x-U*K;if(0==v*v+n*n+k*k)return b.init(N-K,U-x,V-C),b.normalize(b),
d.init(0.5*(L+Q),0.5*(O+S),0.5*(P+M)),!0;this.supportPointB(a,-v,-n,-k,m);var Pa=m.x,Ca=m.y,Da=m.z;this.supportPointC(c,v,n,k,m);var Ea=m.x,Ka=m.y,La=m.z,X=Ea-Pa,D=Ka-Ca,E=La-Da;if(0>=X*v+D*n+E*k)return!1;f=N-K;g=U-x;h=V-C;k=X-K;l=D-x;n=E-C;v=g*n-h*l;n=h*k-f*n;k=f*l-g*k;0<v*K+n*x+k*C&&(f=N,g=U,h=V,N=X,U=D,V=E,X=f,D=g,E=h,f=L,g=O,h=P,L=Pa,O=Ca,P=Da,Pa=f,Ca=g,Da=h,f=Q,g=S,h=M,Q=Ea,S=Ka,M=La,Ea=f,Ka=g,La=h,v=-v,n=-n,k=-k);for(var R=0;;){if(100<++R)return!1;this.supportPointB(a,-v,-n,-k,m);var Y=m.x,
Z=m.y,ha=m.z;this.supportPointC(c,v,n,k,m);var da=m.x,ja=m.y,ka=m.z,ea=da-Y,fa=ja-Z,W=ka-ha;if(0>=ea*v+fa*n+W*k)return!1;if(0>(U*W-V*fa)*K+(V*ea-N*W)*x+(N*fa-U*ea)*C)X=ea,D=fa,E=W,Pa=Y,Ca=Z,Da=ha,Ea=da,Ka=ja,La=ka,f=N-K,g=U-x,h=V-C,k=ea-K,l=fa-x,n=W-C,v=g*n-h*l,n=h*k-f*n,k=f*l-g*k;else if(0>(fa*E-W*D)*K+(W*X-ea*E)*x+(ea*D-fa*X)*C)N=ea,U=fa,V=W,L=Y,O=Z,P=ha,Q=da,S=ja,M=ka,f=ea-K,g=fa-x,h=W-C,k=X-K,l=D-x,n=E-C,v=g*n-h*l,n=h*k-f*n,k=f*l-g*k;else for(var $=!1;;){f=X-N;g=D-U;h=E-V;k=ea-N;l=fa-U;n=W-V;
v=g*n-h*l;n=h*k-f*n;k=f*l-g*k;f=1/OIMO.sqrt(v*v+n*n+k*k);v*=f;n*=f;k*=f;0<=v*N+n*U+k*V&&!$&&(t=(U*E-V*D)*ea+(V*X-N*E)*fa+(N*D-U*X)*W,$=(fa*E-W*D)*K+(W*X-ea*E)*x+(ea*D-fa*X)*C,f=(x*V-C*U)*ea+(C*N-K*V)*fa+(K*U-x*N)*W,g=(D*V-E*U)*K+(E*N-X*V)*x+(X*U-D*N)*C,p=t+$+f+g,0>=p&&(t=0,$=(D*W-E*fa)*v+(E*ea-X*W)*n+(X*fa-D*ea)*k,f=(fa*E-W*D)*v+(W*X-ea*E)*n+(ea*D-fa*X)*k,g=(U*E-V*D)*v+(V*X-N*E)*n+(N*D-U*X)*k,p=$+f+g),h=1/p,p=(z*t+L*$+Pa*f+Y*g)*h,s=(F*t+O*$+Ca*f+Z*g)*h,q=(J*t+P*$+Da*f+ha*g)*h,u=(H*t+Q*$+Ea*f+da*g)*
h,r=(B*t+S*$+Ka*f+ja*g)*h,t=(I*t+M*$+La*f+ka*g)*h,$=!0);this.supportPointB(a,-v,-n,-k,m);f=m.x;g=m.y;h=m.z;this.supportPointC(c,v,n,k,m);l=m.x;var sa=m.y,ta=m.z,ya=l-f,za=sa-g,Aa=ta-h,yb=-(ya*v+za*n+Aa*k);if(0.01>=(ya-ea)*v+(za-fa)*n+(Aa-W)*k||0<=yb)return $?(b.init(-v,-n,-k),d.init(0.5*(p+u),0.5*(s+r),0.5*(q+t)),e.x=yb,!0):!1;0>(za*V-Aa*U)*K+(Aa*N-ya*V)*x+(ya*U-za*N)*C?0>(za*E-Aa*D)*K+(Aa*X-ya*E)*x+(ya*D-za*X)*C?(N=ya,U=za,V=Aa,L=f,O=g,P=h,Q=l,S=sa,M=ta):(ea=ya,fa=za,W=Aa,Y=f,Z=g,ha=h,da=l,ja=sa,
ka=ta):0>(za*W-Aa*fa)*K+(Aa*ea-ya*W)*x+(ya*fa-za*ea)*C?(X=ya,D=za,E=Aa,Pa=f,Ca=g,Da=h,Ea=l,Ka=sa,La=ta):(N=ya,U=za,V=Aa,L=f,O=g,P=h,Q=l,S=sa,M=ta)}}};
OIMO.BoxCylinderCollisionDetector.prototype.supportPointB=function(a,c,b,d,e){var f=a.rotation.elements,g=f[0]*c+f[3]*b+f[6]*d,h=f[1]*c+f[4]*b+f[7]*d;c=f[2]*c+f[5]*b+f[8]*d;d=a.halfWidth;var k=a.halfHeight;b=a.halfDepth;d=0>g?-d:d;k=0>h?-k:k;c=0>c?-b:b;g=f[0]*d+f[1]*k+f[2]*c+a.position.x;h=f[3]*d+f[4]*k+f[5]*c+a.position.y;c=f[6]*d+f[7]*k+f[8]*c+a.position.z;e.init(g,h,c)};
OIMO.BoxCylinderCollisionDetector.prototype.supportPointC=function(a,c,b,d,e){var f=a.rotation.elements,g=f[0]*c+f[3]*b+f[6]*d,h=f[1]*c+f[4]*b+f[7]*d;c=f[2]*c+f[5]*b+f[8]*d;b=g;g=c;c=b*b+g*g;var k=a.radius;d=a.halfHeight;0==c?(0>h?(b=k,d=-d):b=k,c=0):(c=a.radius/OIMO.sqrt(c),0>h?(b*=c,d=-d):b*=c,c*=g);g=f[0]*b+f[1]*d+f[2]*c+a.position.x;h=f[3]*b+f[4]*d+f[5]*c+a.position.y;c=f[6]*b+f[7]*d+f[8]*c+a.position.z;e.init(g,h,c)};
OIMO.BoxCylinderCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;this.flip?(d=c,e=a):(d=a,e=c);var f=new OIMO.Vec3,g=new OIMO.Vec3,h=new OIMO.Vec3;if(this.getSep(d,e,f,g,h)){var k=d.position.x,l=d.position.y,n=d.position.z,m=e.position.x,p=e.position.y,s=e.position.z,q=d.halfWidth,u=d.halfHeight,r=d.halfDepth,t=e.halfHeight,z=e.radius,F=d.dimentions,J=F[0],H=F[1],B=F[2],I=F[3],K=F[4],x=F[5],C=F[6],v=F[7],L=F[8],O=F[9],P=F[10],Q=F[11],S=F[12],M=F[13],N=F[14],U=F[15],V=F[16],Pa=F[17],
Ca=e.normalDirection.x,Da=e.normalDirection.y,Ea=e.normalDirection.z,Ka=e.halfDirection.x,La=e.halfDirection.y,X=e.halfDirection.z,D=f.x,E=f.y,R=f.z,Y=D*J+E*H+R*B,Z=D*I+E*K+R*x,ha=D*C+E*v+R*L,da=D*Ca+E*Da+R*Ea,ja=0<Y,ka=0<Z,ea=0<ha,fa=0<da;ja||(Y=-Y);ka||(Z=-Z);ea||(ha=-ha);fa||(da=-da);var W=0;0.999<da?W=0.999<Y?Y>da?1:4:0.999<Z?Z>da?2:4:0.999<ha?ha>da?3:4:4:0.999<Y?W=1:0.999<Z?W=2:0.999<ha&&(W=3);var $,sa,ta,ya,za,Aa,yb,Nb,Ob,Pb,dc,ec,fc,gc,hc,Qa,Ra,Sa,Ga,Za,db,la,ma,na,eb,fb,gb,hb,Ab,Bb,Cb,Db,
Eb,qc,Ma,Na,Oa,ia,nb,ib,jb,ra,Ba,ob,ua,Kb,Lb,Mb,Fb,Gb,Hb,pb,qb;if(0==W)b.addPoint(g.x,g.y,g.z,D,E,R,h.x,this.flip);else if(4==W){fa?(ya=m-Ka,za=p-La,Aa=s-X,D=-Ca,E=-Da,R=-Ea):(ya=m+Ka,za=p+La,Aa=s+X,D=Ca,E=Da,R=Ea);var pc,Qb,Rb,Sb,Tb,Ub,Vb,Wb,Xb,ic,rc,sc;Za=1;W=0;Ba=J*D+H*E+B*R;Ba<Za&&(Za=Ba,W=0);-Ba<Za&&(Za=-Ba,W=1);Ba=I*D+K*E+x*R;Ba<Za&&(Za=Ba,W=2);-Ba<Za&&(Za=-Ba,W=3);Ba=C*D+v*E+L*R;Ba<Za&&(Za=Ba,W=4);-Ba<Za&&(Za=-Ba,W=5);var T=d.elements;switch(W){case 0:pc=T[0];Qb=T[1];Rb=T[2];Sb=T[6];Tb=T[7];
Ub=T[8];Vb=T[9];Wb=T[10];Xb=T[11];ic=T[3];rc=T[4];sc=T[5];break;case 1:pc=T[15];Qb=T[16];Rb=T[17];Sb=T[21];Tb=T[22];Ub=T[23];Vb=T[18];Wb=T[19];Xb=T[20];ic=T[12];rc=T[13];sc=T[14];break;case 2:pc=T[12];Qb=T[13];Rb=T[14];Sb=T[0];Tb=T[1];Ub=T[2];Vb=T[3];Wb=T[4];Xb=T[5];ic=T[15];rc=T[16];sc=T[17];break;case 3:pc=T[21];Qb=T[22];Rb=T[23];Sb=T[9];Tb=T[10];Ub=T[11];Vb=T[6];Wb=T[7];Xb=T[8];ic=T[18];rc=T[19];sc=T[20];break;case 4:pc=T[12];Qb=T[13];Rb=T[14];Sb=T[18];Tb=T[19];Ub=T[20];Vb=T[6];Wb=T[7];Xb=T[8];
ic=T[0];rc=T[1];sc=T[2];break;case 5:pc=T[3],Qb=T[4],Rb=T[5],Sb=T[9],Tb=T[10],Ub=T[11],Vb=T[21],Wb=T[22],Xb=T[23],ic=T[15],rc=T[16],sc=T[17]}Ga=D*(pc-ya)+E*(Qb-za)+R*(Rb-Aa);0>=Ga&&b.addPoint(pc,Qb,Rb,-D,-E,-R,Ga,this.flip);Ga=D*(Sb-ya)+E*(Tb-za)+R*(Ub-Aa);0>=Ga&&b.addPoint(Sb,Tb,Ub,-D,-E,-R,Ga,this.flip);Ga=D*(Vb-ya)+E*(Wb-za)+R*(Xb-Aa);0>=Ga&&b.addPoint(Vb,Wb,Xb,-D,-E,-R,Ga,this.flip);Ga=D*(ic-ya)+E*(rc-za)+R*(sc-Aa);0>=Ga&&b.addPoint(ic,rc,sc,-D,-E,-R,Ga,this.flip)}else{switch(W){case 1:ja?($=
k+O,sa=l+P,ta=n+Q,D=J,E=H,R=B):($=k-O,sa=l-P,ta=n-Q,D=-J,E=-H,R=-B);Kb=I;Lb=K;Mb=x;pb=u;Fb=C;Gb=v;Hb=L;qb=r;break;case 2:ka?($=k+S,sa=l+M,ta=n+N,D=I,E=K,R=x):($=k-S,sa=l-M,ta=n-N,D=-I,E=-K,R=-x);Kb=J;Lb=H;Mb=B;pb=q;Fb=C;Gb=v;Hb=L;qb=r;break;case 3:ea?($=k+U,sa=l+V,ta=n+Pa,D=C,E=v,R=L):($=k-U,sa=l-V,ta=n-Pa,D=-C,E=-v,R=-L),Kb=J,Lb=H,Mb=B,pb=q,Fb=I,Gb=K,Hb=x,qb=u}Za=D*Ca+E*Da+R*Ea;db=0>Za?t:-t;ya=m+db*Ca;za=p+db*Da;Aa=s+db*Ea;0.999999<=da?(la=-E,ma=R,na=D):(la=D,ma=E,na=R);db=la*Ca+ma*Da+na*Ea;fb=db*
Ca-la;gb=db*Da-ma;hb=db*Ea-na;db=OIMO.sqrt(fb*fb+gb*gb+hb*hb);if(0!=db)if(db=z/db,fb*=db,gb*=db,hb*=db,la=ya+fb,ma=za+gb,na=Aa+hb,-0.96>Za||0.96<Za)yb=Ca*Ca*1.5-0.5,Nb=Ca*Da*1.5-0.866025403*Ea,Ob=Ca*Ea*1.5+0.866025403*Da,Pb=Da*Ca*1.5+0.866025403*Ea,dc=Da*Da*1.5-0.5,ec=Da*Ea*1.5-0.866025403*Ca,fc=Ea*Ca*1.5-0.866025403*Da,gc=Ea*Da*1.5+0.866025403*Ca,hc=Ea*Ea*1.5-0.5,Qa=la,Ra=ma,Sa=na,Ga=D*(Qa-$)+E*(Ra-sa)+R*(Sa-ta),la=Qa-Ga*D-$,ma=Ra-Ga*E-sa,na=Sa-Ga*R-ta,ia=Kb*la+Lb*ma+Mb*na,ra=Fb*la+Gb*ma+Hb*na,ia<
-pb?ia=-pb:ia>pb&&(ia=pb),ra<-qb?ra=-qb:ra>qb&&(ra=qb),la=ia*Kb+ra*Fb,ma=ia*Lb+ra*Gb,na=ia*Mb+ra*Hb,Qa=$+la,Ra=sa+ma,Sa=ta+na,b.addPoint(Qa,Ra,Sa,D,E,R,Ga,this.flip),Qa=fb*yb+gb*Nb+hb*Ob,Ra=fb*Pb+gb*dc+hb*ec,Sa=fb*fc+gb*gc+hb*hc,Qa=(fb=Qa)+ya,Ra=(gb=Ra)+za,Sa=(hb=Sa)+Aa,Ga=D*(Qa-$)+E*(Ra-sa)+R*(Sa-ta),0>=Ga&&(la=Qa-Ga*D-$,ma=Ra-Ga*E-sa,na=Sa-Ga*R-ta,ia=Kb*la+Lb*ma+Mb*na,ra=Fb*la+Gb*ma+Hb*na,ia<-pb?ia=-pb:ia>pb&&(ia=pb),ra<-qb?ra=-qb:ra>qb&&(ra=qb),la=ia*Kb+ra*Fb,ma=ia*Lb+ra*Gb,na=ia*Mb+ra*Hb,Qa=$+
la,Ra=sa+ma,Sa=ta+na,b.addPoint(Qa,Ra,Sa,D,E,R,Ga,this.flip)),Qa=fb*yb+gb*Nb+hb*Ob,Ra=fb*Pb+gb*dc+hb*ec,Sa=fb*fc+gb*gc+hb*hc,Qa=(fb=Qa)+ya,Ra=(gb=Ra)+za,Sa=(hb=Sa)+Aa,Ga=D*(Qa-$)+E*(Ra-sa)+R*(Sa-ta),0>=Ga&&(la=Qa-Ga*D-$,ma=Ra-Ga*E-sa,na=Sa-Ga*R-ta,ia=Kb*la+Lb*ma+Mb*na,ra=Fb*la+Gb*ma+Hb*na,ia<-pb?ia=-pb:ia>pb&&(ia=pb),ra<-qb?ra=-qb:ra>qb&&(ra=qb),la=ia*Kb+ra*Fb,ma=ia*Lb+ra*Gb,na=ia*Mb+ra*Hb,Qa=$+la,Ra=sa+ma,Sa=ta+na,b.addPoint(Qa,Ra,Sa,D,E,R,Ga,this.flip));else{Ma=la;Na=ma;Oa=na;ia=D*(Ma-$)+E*(Na-
sa)+R*(Oa-ta);Ma-=ia*D;Na-=ia*E;Oa-=ia*R;0<Za?(nb=la+2*Ka,ib=ma+2*La,jb=na+2*X):(nb=la-2*Ka,ib=ma-2*La,jb=na-2*X);ra=D*(nb-$)+E*(ib-sa)+R*(jb-ta);nb-=ra*D;ib-=ra*E;jb-=ra*R;Ab=Ma-$;Bb=Na-sa;Cb=Oa-ta;Db=nb-$;Eb=ib-sa;qc=jb-ta;la=nb-Ma;ma=ib-Na;na=jb-Oa;eb=ra-ia;Y=Ab*Kb+Bb*Lb+Cb*Mb;Z=Db*Kb+Eb*Lb+qc*Mb;Ba=Y-pb;ob=Z-pb;if(0<Ba){if(0<ob)return;ua=Ba/(Ba-ob);Ma+=la*ua;Na+=ma*ua;Oa+=na*ua;ia+=eb*ua;Ab=Ma-$;Bb=Na-sa;Cb=Oa-ta;Y=Ab*Kb+Bb*Lb+Cb*Mb;la=nb-Ma;ma=ib-Na;na=jb-Oa;eb=ra-ia}else 0<ob&&(ua=Ba/(Ba-ob),
nb=Ma+la*ua,ib=Na+ma*ua,jb=Oa+na*ua,ra=ia+eb*ua,Db=nb-$,Eb=ib-sa,qc=jb-ta,Z=Db*Kb+Eb*Lb+qc*Mb,la=nb-Ma,ma=ib-Na,na=jb-Oa,eb=ra-ia);Ba=Y+pb;ob=Z+pb;if(0>Ba){if(0>ob)return;ua=Ba/(Ba-ob);Ma+=la*ua;Na+=ma*ua;Oa+=na*ua;ia+=eb*ua;Ab=Ma-$;Bb=Na-sa;Cb=Oa-ta;la=nb-Ma;ma=ib-Na;na=jb-Oa;eb=ra-ia}else 0>ob&&(ua=Ba/(Ba-ob),nb=Ma+la*ua,ib=Na+ma*ua,jb=Oa+na*ua,ra=ia+eb*ua,Db=nb-$,Eb=ib-sa,qc=jb-ta,la=nb-Ma,ma=ib-Na,na=jb-Oa,eb=ra-ia);Y=Ab*Fb+Bb*Gb+Cb*Hb;Z=Db*Fb+Eb*Gb+qc*Hb;Ba=Y-qb;ob=Z-qb;if(0<Ba){if(0<ob)return;
ua=Ba/(Ba-ob);Ma+=la*ua;Na+=ma*ua;Oa+=na*ua;ia+=eb*ua;Ab=Ma-$;Bb=Na-sa;Cb=Oa-ta;Y=Ab*Fb+Bb*Gb+Cb*Hb;la=nb-Ma;ma=ib-Na;na=jb-Oa;eb=ra-ia}else 0<ob&&(ua=Ba/(Ba-ob),nb=Ma+la*ua,ib=Na+ma*ua,jb=Oa+na*ua,ra=ia+eb*ua,Db=nb-$,Eb=ib-sa,qc=jb-ta,Z=Db*Fb+Eb*Gb+qc*Hb,la=nb-Ma,ma=ib-Na,na=jb-Oa,eb=ra-ia);Ba=Y+qb;ob=Z+qb;if(0>Ba){if(0>ob)return;ua=Ba/(Ba-ob);Ma+=la*ua;Na+=ma*ua;Oa+=na*ua;ia+=eb*ua}else 0>ob&&(ua=Ba/(Ba-ob),nb=Ma+la*ua,ib=Na+ma*ua,jb=Oa+na*ua,ra=ia+eb*ua);0>ia&&b.addPoint(Ma,Na,Oa,D,E,R,ia,this.flip);
0>ra&&b.addPoint(nb,ib,jb,D,E,R,ra,this.flip)}}}};OIMO.CylinderCylinderCollisionDetector=function(){OIMO.CollisionDetector.call(this)};OIMO.CylinderCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.CylinderCylinderCollisionDetector.prototype.constructor=OIMO.CylinderCylinderCollisionDetector;
OIMO.CylinderCylinderCollisionDetector.prototype.getSep=function(a,c,b,d,e){var f,g,h,k,l,n,m=new OIMO.Vec3,p,s,q,u,r,t,z=a.position.x,F=a.position.y,J=a.position.z,H=c.position.x,B=c.position.y,I=c.position.z,K=H-z,x=B-F,C=I-J;0==K*K+x*x+C*C&&(x=0.001);var v=-K;n=-x;k=-C;this.supportPoint(a,-v,-n,-k,m);var L=m.x,O=m.y,P=m.z;this.supportPoint(c,v,n,k,m);var Q=m.x,S=m.y,M=m.z,N=Q-L,U=S-O,V=M-P;if(0>=N*v+U*n+V*k)return!1;v=U*C-V*x;n=V*K-N*C;k=N*x-U*K;if(0==v*v+n*n+k*k)return b.init(N-K,U-x,V-C),b.normalize(b),
d.init(0.5*(L+Q),0.5*(O+S),0.5*(P+M)),!0;this.supportPoint(a,-v,-n,-k,m);var Pa=m.x,Ca=m.y,Da=m.z;this.supportPoint(c,v,n,k,m);var Ea=m.x,Ka=m.y,La=m.z,X=Ea-Pa,D=Ka-Ca,E=La-Da;if(0>=X*v+D*n+E*k)return!1;f=N-K;g=U-x;h=V-C;k=X-K;l=D-x;n=E-C;v=g*n-h*l;n=h*k-f*n;k=f*l-g*k;0<v*K+n*x+k*C&&(f=N,g=U,h=V,N=X,U=D,V=E,X=f,D=g,E=h,f=L,g=O,h=P,L=Pa,O=Ca,P=Da,Pa=f,Ca=g,Da=h,f=Q,g=S,h=M,Q=Ea,S=Ka,M=La,Ea=f,Ka=g,La=h,v=-v,n=-n,k=-k);for(var R=0;;){if(100<++R)return!1;this.supportPoint(a,-v,-n,-k,m);var Y=m.x,Z=m.y,
ha=m.z;this.supportPoint(c,v,n,k,m);var da=m.x,ja=m.y,ka=m.z,ea=da-Y,fa=ja-Z,W=ka-ha;if(0>=ea*v+fa*n+W*k)return!1;if(0>(U*W-V*fa)*K+(V*ea-N*W)*x+(N*fa-U*ea)*C)X=ea,D=fa,E=W,Pa=Y,Ca=Z,Da=ha,Ea=da,Ka=ja,La=ka,f=N-K,g=U-x,h=V-C,k=ea-K,l=fa-x,n=W-C,v=g*n-h*l,n=h*k-f*n,k=f*l-g*k;else if(0>(fa*E-W*D)*K+(W*X-ea*E)*x+(ea*D-fa*X)*C)N=ea,U=fa,V=W,L=Y,O=Z,P=ha,Q=da,S=ja,M=ka,f=ea-K,g=fa-x,h=W-C,k=X-K,l=D-x,n=E-C,v=g*n-h*l,n=h*k-f*n,k=f*l-g*k;else for(var $=!1;;){f=X-N;g=D-U;h=E-V;k=ea-N;l=fa-U;n=W-V;v=g*n-h*
l;n=h*k-f*n;k=f*l-g*k;f=1/OIMO.sqrt(v*v+n*n+k*k);v*=f;n*=f;k*=f;0<=v*N+n*U+k*V&&!$&&(t=(U*E-V*D)*ea+(V*X-N*E)*fa+(N*D-U*X)*W,$=(fa*E-W*D)*K+(W*X-ea*E)*x+(ea*D-fa*X)*C,f=(x*V-C*U)*ea+(C*N-K*V)*fa+(K*U-x*N)*W,g=(D*V-E*U)*K+(E*N-X*V)*x+(X*U-D*N)*C,p=t+$+f+g,0>=p&&(t=0,$=(D*W-E*fa)*v+(E*ea-X*W)*n+(X*fa-D*ea)*k,f=(fa*E-W*D)*v+(W*X-ea*E)*n+(ea*D-fa*X)*k,g=(U*E-V*D)*v+(V*X-N*E)*n+(N*D-U*X)*k,p=$+f+g),h=1/p,p=(z*t+L*$+Pa*f+Y*g)*h,s=(F*t+O*$+Ca*f+Z*g)*h,q=(J*t+P*$+Da*f+ha*g)*h,u=(H*t+Q*$+Ea*f+da*g)*h,r=(B*
t+S*$+Ka*f+ja*g)*h,t=(I*t+M*$+La*f+ka*g)*h,$=!0);this.supportPoint(a,-v,-n,-k,m);f=m.x;g=m.y;h=m.z;this.supportPoint(c,v,n,k,m);l=m.x;var sa=m.y,ta=m.z,ya=l-f,za=sa-g,Aa=ta-h,yb=-(ya*v+za*n+Aa*k);if(0.01>=(ya-ea)*v+(za-fa)*n+(Aa-W)*k||0<=yb)return $?(b.init(-v,-n,-k),d.init(0.5*(p+u),0.5*(s+r),0.5*(q+t)),e.x=yb,!0):!1;0>(za*V-Aa*U)*K+(Aa*N-ya*V)*x+(ya*U-za*N)*C?0>(za*E-Aa*D)*K+(Aa*X-ya*E)*x+(ya*D-za*X)*C?(N=ya,U=za,V=Aa,L=f,O=g,P=h,Q=l,S=sa,M=ta):(ea=ya,fa=za,W=Aa,Y=f,Z=g,ha=h,da=l,ja=sa,ka=ta):0>
(za*W-Aa*fa)*K+(Aa*ea-ya*W)*x+(ya*fa-za*ea)*C?(X=ya,D=za,E=Aa,Pa=f,Ca=g,Da=h,Ea=l,Ka=sa,La=ta):(N=ya,U=za,V=Aa,L=f,O=g,P=h,Q=l,S=sa,M=ta)}}};
OIMO.CylinderCylinderCollisionDetector.prototype.supportPoint=function(a,c,b,d,e){var f=a.rotation.elements,g=f[0]*c+f[3]*b+f[6]*d,h=f[1]*c+f[4]*b+f[7]*d;c=f[2]*c+f[5]*b+f[8]*d;b=g;g=c;c=b*b+g*g;var k=a.radius;d=a.halfHeight;0==c?(0>h?(b=k,d=-d):b=k,c=0):(c=a.radius/OIMO.sqrt(c),0>h?(b*=c,d=-d):b*=c,c*=g);g=f[0]*b+f[1]*d+f[2]*c+a.position.x;h=f[3]*b+f[4]*d+f[5]*c+a.position.y;c=f[6]*b+f[7]*d+f[8]*c+a.position.z;e.init(g,h,c)};
OIMO.CylinderCylinderCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;a.id<c.id?(d=a,e=c):(d=c,e=a);c=d.position;a=e.position;var f=c.x,g=c.y,h=c.z,k=a.x,l=a.y,n=a.z,m=d.halfHeight,p=e.halfHeight,s=d.normalDirection,q=e.normalDirection,u=d.halfDirection,r=e.halfDirection;a=d.radius;c=e.radius;var t=s.x,z=s.y,s=s.z,F=q.x,J=q.y,q=q.z,H=u.x,B=u.y,I=u.z,K=r.x,x=r.y,C=r.z,u=f-k,v=g-l,L=h-n,O,P,Q,r=new OIMO.Vec3,L=new OIMO.Vec3,S=new OIMO.Vec3;if(this.getSep(d,e,r,L,S)){u=r.x*t+r.y*z+
r.z*s;v=r.x*F+r.y*J+r.z*q;O=0<u;P=0<v;O||(u=-u);P||(v=-v);Q=0;if(0.999<u||0.999<v)Q=u>v?1:2;var S=S.x,M;d=r.x;e=r.y;r=r.z;switch(Q){case 0:b.addPoint(L.x,L.y,L.z,d,e,r,S,!1);break;case 1:O?(f+=H,g+=B,h+=I,d=t,e=z,r=s):(f-=H,g-=B,h-=I,d=-t,e=-z,r=-s);Q=d*F+e*J+r*q;B=0>Q?p:-p;k+=B*F;l+=B*J;n+=B*q;0.999999<=v?(I=-e,H=r,x=d):(I=d,H=e,x=r);B=I*F+H*J+x*q;u=B*F-I;v=B*J-H;L=B*q-x;B=OIMO.sqrt(u*u+v*v+L*L);if(0==B)break;B=c/B;u*=B;v*=B;L*=B;I=k+u;H=l+v;x=n+L;if(-0.96>Q||0.96<Q)m=F*F*1.5-0.5,p=F*J*1.5-0.866025403*
q,C=F*q*1.5+0.866025403*J,K=J*F*1.5+0.866025403*q,O=J*J*1.5-0.5,P=J*q*1.5-0.866025403*F,Q=q*F*1.5-0.866025403*J,z=q*J*1.5+0.866025403*F,s=q*q*1.5-0.5,q=I,t=H,J=x,M=d*(q-f)+e*(t-g)+r*(J-h),I=q-M*d-f,H=t-M*e-g,x=J-M*r-h,B=I*I+H*H+x*x,B>a*a&&(B=a/OIMO.sqrt(B),I*=B,H*=B,x*=B),b.addPoint(f+I,g+H,h+x,d,e,r,M,!1),t=u*K+v*O+L*P,J=u*Q+v*z+L*s,q=(u=u*m+v*p+L*C)+k,t=(v=t)+l,J=(L=J)+n,M=d*(q-f)+e*(t-g)+r*(J-h),0>=M&&(I=q-M*d-f,H=t-M*e-g,x=J-M*r-h,B=I*I+H*H+x*x,B>a*a&&(B=a/OIMO.sqrt(B),I*=B,H*=B,x*=B),b.addPoint(f+
I,g+H,h+x,d,e,r,M,!1)),q=u*m+v*p+L*C+k,t=u*K+v*O+L*P+l,J=u*Q+v*z+L*s+n,M=d*(q-f)+e*(t-g)+r*(J-h),0>=M&&(I=q-M*d-f,H=t-M*e-g,x=J-M*r-h,B=I*I+H*H+x*x,B>a*a&&(B=a/OIMO.sqrt(B),I*=B,H*=B,x*=B),b.addPoint(f+I,g+H,h+x,d,e,r,M,!1));else{C=I;K=H;O=x;P=d*(C-f)+e*(K-g)+r*(O-h);C-=P*d;K-=P*e;O-=P*r;0<Q?(t=I+F*p*2,z=H+J*p*2,s=x+q*p*2):(t=I-F*p*2,z=H-J*p*2,s=x-q*p*2);q=d*(t-f)+e*(z-g)+r*(s-h);t-=q*d;z-=q*e;s-=q*r;u=f-C;v=g-K;L=h-O;I=t-C;H=z-K;x=s-O;J=u*I+v*H+L*x;F=I*I+H*H+x*x;c=J*J-F*(u*u+v*v+L*L-a*a);if(0>c)break;
c=OIMO.sqrt(c);a=(J+c)/F;c=(J-c)/F;c<a&&(B=a,a=c,c=B);1<c&&(c=1);0>a&&(a=0);I=C+(t-C)*a;H=K+(z-K)*a;x=O+(s-O)*a;t=C+(t-C)*c;z=K+(z-K)*c;s=O+(s-O)*c;B=P+(q-P)*a;q=P+(q-P)*c;0>B&&b.addPoint(I,H,x,d,e,r,M,!1);0>q&&b.addPoint(t,z,s,d,e,r,M,!1)}break;case 2:P?(k-=K,l-=x,n-=C,d=-F,e=-J,r=-q):(k+=K,l+=x,n+=C,d=F,e=J,r=q);Q=d*t+e*z+r*s;B=0>Q?m:-m;f+=B*t;g+=B*z;h+=B*s;0.999999<=u?(I=-e,H=r,x=d):(I=d,H=e,x=r);B=I*t+H*z+x*s;u=B*t-I;v=B*z-H;L=B*s-x;B=OIMO.sqrt(u*u+v*v+L*L);if(0==B)break;B=a/B;u*=B;v*=B;L*=B;
I=f+u;H=g+v;x=h+L;if(-0.96>Q||0.96<Q)m=t*t*1.5-0.5,p=t*z*1.5-0.866025403*s,C=t*s*1.5+0.866025403*z,K=z*t*1.5+0.866025403*s,O=z*z*1.5-0.5,P=z*s*1.5-0.866025403*t,Q=s*t*1.5-0.866025403*z,z=s*z*1.5+0.866025403*t,s=s*s*1.5-0.5,q=I,t=H,J=x,M=d*(q-k)+e*(t-l)+r*(J-n),I=q-M*d-k,H=t-M*e-l,x=J-M*r-n,B=I*I+H*H+x*x,B>c*c&&(B=c/OIMO.sqrt(B),I*=B,H*=B,x*=B),b.addPoint(k+I,l+H,n+x,-d,-e,-r,M,!1),t=u*K+v*O+L*P,J=u*Q+v*z+L*s,q=(u=u*m+v*p+L*C)+f,t=(v=t)+g,J=(L=J)+h,M=d*(q-k)+e*(t-l)+r*(J-n),0>=M&&(I=q-M*d-k,H=t-M*
e-l,x=J-M*r-n,B=I*I+H*H+x*x,B>c*c&&(B=c/OIMO.sqrt(B),I*=B,H*=B,x*=B),b.addPoint(k+I,l+H,n+x,-d,-e,-r,M,!1)),q=u*m+v*p+L*C+f,t=u*K+v*O+L*P+g,J=u*Q+v*z+L*s+h,M=d*(q-k)+e*(t-l)+r*(J-n),0>=M&&(I=q-M*d-k,H=t-M*e-l,x=J-M*r-n,B=I*I+H*H+x*x,B>c*c&&(B=c/OIMO.sqrt(B),I*=B,H*=B,x*=B),b.addPoint(k+I,l+H,n+x,-d,-e,-r,M,!1));else{C=I;K=H;O=x;P=d*(C-k)+e*(K-l)+r*(O-n);C-=P*d;K-=P*e;O-=P*r;0<Q?(t=I+t*m*2,z=H+z*m*2,s=x+s*m*2):(t=I-t*m*2,z=H-z*m*2,s=x-s*m*2);q=d*(t-k)+e*(z-l)+r*(s-n);t-=q*d;z-=q*e;s-=q*r;u=k-C;v=l-
K;L=n-O;I=t-C;H=z-K;x=s-O;J=u*I+v*H+L*x;F=I*I+H*H+x*x;c=J*J-F*(u*u+v*v+L*L-c*c);if(0>c)break;c=OIMO.sqrt(c);a=(J+c)/F;c=(J-c)/F;c<a&&(B=a,a=c,c=B);1<c&&(c=1);0>a&&(a=0);I=C+(t-C)*a;H=K+(z-K)*a;x=O+(s-O)*a;t=C+(t-C)*c;z=K+(z-K)*c;s=O+(s-O)*c;B=P+(q-P)*a;q=P+(q-P)*c;P=B;0>P&&b.addPoint(I,H,x,-d,-e,-r,P,!1);0>q&&b.addPoint(t,z,s,-d,-e,-r,q,!1)}}}};OIMO.SphereCylinderCollisionDetector=function(a){OIMO.CollisionDetector.call(this);this.flip=a};OIMO.SphereCylinderCollisionDetector.prototype=Object.create(OIMO.CollisionDetector.prototype);OIMO.SphereCylinderCollisionDetector.prototype.constructor=OIMO.SphereCylinderCollisionDetector;
OIMO.SphereCylinderCollisionDetector.prototype.detectCollision=function(a,c,b){var d,e;this.flip?(d=c,e=a):(d=a,e=c);var f=d.position;a=f.x;c=f.y;var f=f.z,g=e.position,h=g.x,k=g.y,g=g.z,l=e.normalDirection.x,n=e.normalDirection.y,m=e.normalDirection.z;d=d.radius;var p=e.radius,s=d+p,q=e.halfHeight,u=(a-h)*l+(c-k)*n+(f-g)*m;if(!(u<-q-d||u>q+d)){var r=a-(h+u*l),t=c-(k+u*n),z=f-(g+u*m);e=r*r+t*t+z*z;e>s*s||(e>p*p&&(e=p/OIMO.sqrt(e),r*=e,t*=e,z*=e),u<-q?u=-q:u>q&&(u=q),h=h+u*l+r-a,k=k+u*n+t-c,g=g+u*
m+z-f,e=h*h+k*k+g*g,0<e&&e<d*d&&(e=OIMO.sqrt(e),m=1/e,h*=m,k*=m,g*=m,b.addPoint(a+h*d,c+k*d,f+g*d,h,k,g,e-d,this.flip)))}};OIMO.AABB=function(a,c,b,d,e,f){var g=this.elements=new OIMO_ARRAY_TYPE(6);g[0]=a||0;g[1]=b||0;g[2]=e||0;g[3]=c||0;g[4]=d||0;g[5]=f||0};
OIMO.AABB.prototype={constructor:OIMO.AABB,set:function(a,c,b,d,e,f){var g=this.elements;g[0]=a;g[3]=c;g[1]=b;g[4]=d;g[2]=e;g[5]=f;return this},intersectTest:function(a){var c=this.elements;a=a.elements;return c[0]>a[3]||c[1]>a[4]||c[2]>a[5]||c[3]<a[0]||c[4]<a[1]||c[5]<a[2]},intersectTestTwo:function(a){var c=this.elements;a=a.elements;return c[0]<a[0]||c[1]<a[1]||c[2]<a[2]||c[3]>a[3]||c[4]>a[4]||c[5]>a[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(a,c){var b=
c||0,d=a.elements;this.set(d[0]-b,d[3]+b,d[1]-b,d[4]+b,d[2]-b,d[5]+b);return this},fromArray:function(a){this.elements.set(a);return this},combine:function(a,c){var b=a.elements,d=c.elements,e=this.elements;e[0]=b[0]<d[0]?b[0]:d[0];e[1]=b[1]<d[1]?b[1]:d[1];e[2]=b[2]<d[2]?b[2]:d[2];e[3]=b[3]>d[3]?b[3]:d[3];e[4]=b[4]>d[4]?b[4]:d[4];e[5]=b[5]>d[5]?b[5]:d[5];return this},surfaceArea:function(){var a=this.elements,c=a[4]-a[1],b=a[5]-a[2];return 2*((a[3]-a[0])*(c+b)+c*b)},intersectsWithPoint:function(a,
c,b){var d=this.elements;return a>=d[0]&&a<=d[3]&&c>=d[1]&&c<=d[4]&&b>=d[2]&&b<=d[5]}};OIMO.Proxy=function(a){this.shape=a;this.aabb=a.aabb};OIMO.Proxy.prototype={constructor:OIMO.Proxy,update:function(){OIMO.Error("Proxy","Inheritance error.")}};OIMO.BasicProxy=function(a){OIMO.Proxy.call(this,a);this.id=OIMO.proxyID++};OIMO.BasicProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.BasicProxy.prototype.constructor=OIMO.BasicProxy;OIMO.BasicProxy.prototype.update=function(){};OIMO.BroadPhase=function(){this.types=OIMO.BR_NULL;this.numPairs=this.numPairChecks=0;this.pairs=[]};
OIMO.BroadPhase.prototype={constructor:OIMO.BroadPhase,createProxy:function(a){OIMO.Error("BroadPhase","Inheritance error.")},addProxy:function(a){OIMO.Error("BroadPhase","Inheritance error.")},removeProxy:function(a){OIMO.Error("BroadPhase","Inheritance error.")},isAvailablePair:function(a,c){var b=a.parent,d=c.parent;if(b==d||!b.isDynamic&&!d.isDynamic||0==(a.belongsTo&c.collidesWith)||0==(c.belongsTo&a.collidesWith))return!1;var e;for(e=b.numJoints<d.numJoints?b.jointLink:d.jointLink;null!==e;){var f=
e.joint;if(!f.allowCollision&&(f.body1==b&&f.body2==d||f.body1==d&&f.body2==b))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[];this.numPairChecks=this.numPairs=0;this.collectPairs()},collectPairs:function(){OIMO.Error("BroadPhase","Inheritance error.")},addPair:function(a,c){var b=new OIMO.Pair(a,c);this.pairs.push(b);this.numPairs++}};OIMO.BruteForceBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=OIMO.BR_BRUTE_FORCE;this.proxies=[]};OIMO.BruteForceBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.BruteForceBroadPhase.prototype.constructor=OIMO.BruteForceBroadPhase;OIMO.BruteForceBroadPhase.prototype.createProxy=function(a){return new OIMO.BasicProxy(a)};OIMO.BruteForceBroadPhase.prototype.addProxy=function(a){this.proxies.push(a)};
OIMO.BruteForceBroadPhase.prototype.removeProxy=function(a){a=this.proxies.indexOf(a);-1<a&&this.proxies.splice(a,1)};OIMO.BruteForceBroadPhase.prototype.collectPairs=function(){var a=0,c,b,d,e=this.proxies,f=e.length;for(this.numPairChecks=f*(f-1)>>1;a<f;)for(b=e[a++],c=a+1;c<f;)d=e[c++],!b.aabb.intersectTest(d.aabb)&&this.isAvailablePair(b.shape,d.shape)&&this.addPair(b.shape,d.shape)};OIMO.Pair=function(a,c){this.shape1=a||null;this.shape2=c||null};OIMO.SAPAxis=function(){this.numElements=0;this.bufferSize=256;this.elements=[];this.elements.length=this.bufferSize;this.stack=new OIMO_ARRAY_TYPE(64)};
OIMO.SAPAxis.prototype={constructor:OIMO.SAPAxis,addElements:function(a,c){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var b=this.numElements;b--;);}this.elements[this.numElements++]=a;this.elements[this.numElements++]=c},removeElements:function(a,c){for(var b=-1,d=-1,e=0,f=this.numElements;e<f;e++){var g=this.elements[e];if(g==a||g==c)if(-1==b)b=e;else{d=e;break}}e=b+1;for(f=d;e<f;e++)this.elements[e-1]=this.elements[e];e=d+1;for(f=this.numElements;e<f;e++)this.elements[e-2]=this.elements[e];
this.elements[--this.numElements]=null;this.elements[--this.numElements]=null},sort:function(){for(var a=0,c=1;0!=this.numElements>>c;)c++;for(var c=c*this.numElements>>2,a=0,b=!1,d=this.elements,e=1,f=this.numElements;e<f;e++){var g=d[e],h=g.value,k=d[e-1];if(k.value>h){var l=e;do{d[l]=k;if(0==--l)break;k=d[l-1]}while(k.value>h);d[l]=g;a+=e-l;if(a>c){b=!0;break}}}if(b)for(a=2,c=this.stack,c[0]=0,c[1]=this.numElements-1;0<a;)if(b=c[--a],k=c[--a],g=b-k,16<g){e=k+OIMO.floor(0.5*g);g=d[e];d[e]=d[b];
d[b]=g;h=g.value;e=k-1;for(l=b;;){var n;do f=d[++e];while(f.value<h);do n=d[--l];while(h<n.value&&l!=k);if(e>=l)break;d[e]=n;d[l]=f}d[b]=d[e];d[e]=g;e-k>b-e?(c[a++]=k,c[a++]=e-1,c[a++]=e+1,c[a++]=b):(c[a++]=e+1,c[a++]=b,c[a++]=k,c[a++]=e-1)}else for(e=k+1;e<=b;e++)if(g=d[e],h=g.value,k=d[e-1],k.value>h){l=e;do{d[l]=k;if(0==--l)break;k=d[l-1]}while(k.value>h);d[l]=g}},calculateTestCount:function(){for(var a=1,c=0,b=1,d=this.numElements;b<d;b++)this.elements[b].max?a--:(c+=a,a++);return c}};OIMO.SAPBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=OIMO.BR_SWEEP_AND_PRUNE;this.numElementsS=this.numElementsD=0;this.axesD=[new OIMO.SAPAxis,new OIMO.SAPAxis,new OIMO.SAPAxis];this.axesS=[new OIMO.SAPAxis,new OIMO.SAPAxis,new OIMO.SAPAxis];this.index1=0;this.index2=1};OIMO.SAPBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.SAPBroadPhase.prototype.constructor=OIMO.SAPBroadPhase;OIMO.SAPBroadPhase.prototype.createProxy=function(a){return new OIMO.SAPProxy(this,a)};
OIMO.SAPBroadPhase.prototype.addProxy=function(a){a.isDynamic()?(this.axesD[0].addElements(a.min[0],a.max[0]),this.axesD[1].addElements(a.min[1],a.max[1]),this.axesD[2].addElements(a.min[2],a.max[2]),a.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(a.min[0],a.max[0]),this.axesS[1].addElements(a.min[1],a.max[1]),this.axesS[2].addElements(a.min[2],a.max[2]),a.belongsTo=2,this.numElementsS+=2)};
OIMO.SAPBroadPhase.prototype.removeProxy=function(a){if(0!=a.belongsTo){switch(a.belongsTo){case 1:this.axesD[0].removeElements(a.min[0],a.max[0]);this.axesD[1].removeElements(a.min[1],a.max[1]);this.axesD[2].removeElements(a.min[2],a.max[2]);this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(a.min[0],a.max[0]),this.axesS[1].removeElements(a.min[1],a.max[1]),this.axesS[2].removeElements(a.min[2],a.max[2]),this.numElementsS-=2}a.belongsTo=0}};
OIMO.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var a=this.axesD[this.index1],c=this.axesD[this.index2];a.sort();c.sort();var b=a.calculateTestCount(),d=c.calculateTestCount();b<=d?(c=this.axesS[this.index1],c.sort(),b=a.elements,a=c.elements):(a=this.axesS[this.index2],a.sort(),b=c.elements,a=a.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var e,f,d=c=0;c<this.numElementsD;){var g,h;d==this.numElementsS?(g=b[c],h=!0,c++):(g=
b[c],h=a[d],g.value<h.value?(h=!0,c++):(g=h,h=!1,d++));if(g.max){var k=g.pair;if(h)if(k==e){e=e.pair;continue}else g=e;else if(k==f){f=f.pair;continue}else g=f;do{s=g.pair;if(s==k){g.pair=s.pair;break}g=s}while(null!=g)}else{for(var k=g.proxy.shape,l=g.min1.value,n=g.max1.value,m=g.min2.value,p=g.max2.value,s=e;null!=s;s=s.pair){var q=s.proxy.shape;this.numPairChecks++;l>s.max1.value||n<s.min1.value||m>s.max2.value||p<s.min2.value||!this.isAvailablePair(k,q)||this.addPair(k,q)}if(h){for(s=f;null!=
s;s=s.pair)q=s.proxy.shape,this.numPairChecks++,l>s.max1.value||n<s.min1.value||m>s.max2.value||p<s.min2.value||!this.isAvailablePair(k,q)||this.addPair(k,q);g.pair=e;e=g}else g.pair=f,f=g}}this.index2=(this.index1|this.index2)^3}};OIMO.SAPElement=function(a,c){this.proxy=a;this.max2=this.min2=this.max1=this.min1=this.pair=null;this.max=c;this.value=0};OIMO.SAPProxy=function(a,c){OIMO.Proxy.call(this,c);this.belongsTo=0;this.max=[];this.min=[];this.sap=a;this.min[0]=new OIMO.SAPElement(this,!1);this.max[0]=new OIMO.SAPElement(this,!0);this.min[1]=new OIMO.SAPElement(this,!1);this.max[1]=new OIMO.SAPElement(this,!0);this.min[2]=new OIMO.SAPElement(this,!1);this.max[2]=new OIMO.SAPElement(this,!0);this.max[0].pair=this.min[0];this.max[1].pair=this.min[1];this.max[2].pair=this.min[2];this.min[0].min1=this.min[1];this.min[0].max1=this.max[1];this.min[0].min2=
this.min[2];this.min[0].max2=this.max[2];this.min[1].min1=this.min[0];this.min[1].max1=this.max[0];this.min[1].min2=this.min[2];this.min[1].max2=this.max[2];this.min[2].min1=this.min[0];this.min[2].max1=this.max[0];this.min[2].min2=this.min[1];this.min[2].max2=this.max[1]};OIMO.SAPProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.SAPProxy.prototype.constructor=OIMO.SAPProxy;OIMO.SAPProxy.prototype.isDynamic=function(){var a=this.shape.parent;return a.isDynamic&&!a.sleeping};
OIMO.SAPProxy.prototype.update=function(){var a=this.aabb.elements;this.min[0].value=a[0];this.min[1].value=a[1];this.min[2].value=a[2];this.max[0].value=a[3];this.max[1].value=a[4];this.max[2].value=a[5];if(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())this.sap.removeProxy(this),this.sap.addProxy(this)};OIMO.DBVT=function(){this.root=null;this.freeNodes=[];this.freeNodes.length=16384;this.numFreeNodes=0;this.aabb=new OIMO.AABB};
OIMO.DBVT.prototype={constructor:OIMO.DBVT,moveLeaf:function(a){this.deleteLeaf(a);this.insertLeaf(a)},insertLeaf:function(a){if(null==this.root)this.root=a;else{for(var c=a.aabb,b=this.root,d,e;null==b.proxy;){var f=b.child1,g=b.child2,h=b.aabb,k=f.aabb,l=g.aabb;d=h.surfaceArea();this.aabb.combine(c,h);e=this.aabb.surfaceArea();h=2*e;d=e=2*(e-d);this.aabb.combine(c,k);d=null!=f.proxy?d+this.aabb.surfaceArea():d+(this.aabb.surfaceArea()-k.surfaceArea());k=e;this.aabb.combine(c,l);k=null!=g.proxy?
k+this.aabb.surfaceArea():k+(this.aabb.surfaceArea()-l.surfaceArea());if(d<k)if(h<d)break;else b=f;else if(h<k)break;else b=g}c=b.parent;f=0<this.numFreeNodes?this.freeNodes[--this.numFreeNodes]:new OIMO.DBVTNode;f.parent=c;f.child1=a;f.child2=b;f.aabb.combine(a.aabb,b.aabb);f.height=b.height+1;b.parent=f;a.parent=f;b==this.root?this.root=f:c.child1==b?c.child1=f:c.child2=f;do f=this.balance(f),this.fix(f),f=f.parent;while(null!=f)}},getBalance:function(a){return null!=a.proxy?0:a.child1.height-a.child2.height},
deleteLeaf:function(a){if(a==this.root)this.root=null;else{var c=a.parent;a=c.child1==a?c.child2:c.child1;if(c==this.root)this.root=a,a.parent=null;else{var b=c.parent;a.parent=b;b.child1==c?b.child1=a:b.child2=a;16384>this.numFreeNodes&&(this.freeNodes[this.numFreeNodes++]=c);do b=this.balance(b),this.fix(b),b=b.parent;while(null!=b)}}},balance:function(a){var c=a.height;if(2>c)return a;var b=a.parent,d=a.child1,e=a.child2,f=d.height,g=e.height,h=f-g;if(1<h){var f=d.child1,h=d.child2,k=f.height,
l=h.height;k>l?(d.child2=a,a.parent=d,a.child1=h,h.parent=a,a.aabb.combine(h.aabb,e.aabb),g=l-g,a.height=l-(g&g>>31)+1,d.aabb.combine(f.aabb,a.aabb),g=k-c,d.height=k-(g&g>>31)+1):(d.child1=a,a.parent=d,a.child1=f,f.parent=a,a.aabb.combine(f.aabb,e.aabb),g=k-g,a.height=k-(g&g>>31)+1,d.aabb.combine(a.aabb,h.aabb),g=c-l,d.height=c-(g&g>>31)+1);null!=b?b.child1==a?b.child1=d:b.child2=d:this.root=d;d.parent=b;return d}if(-1>h){var h=e.child1,k=e.child2,l=h.height,n=k.height;l>n?(e.child2=a,a.parent=e,
a.child2=k,k.parent=a,a.aabb.combine(d.aabb,k.aabb),g=f-n,a.height=f-(g&g>>31)+1,e.aabb.combine(h.aabb,a.aabb),g=l-c,e.height=l-(g&g>>31)+1):(e.child1=a,a.parent=e,a.child2=h,h.parent=a,a.aabb.combine(d.aabb,h.aabb),g=f-l,a.height=f-(g&g>>31)+1,e.aabb.combine(a.aabb,k.aabb),g=c-n,e.height=c-(g&g>>31)+1);null!=b?b.child1==a?b.child1=e:b.child2=e:this.root=e;e.parent=b;return e}return a},fix:function(a){var c=a.child1,b=a.child2;a.aabb.combine(c.aabb,b.aabb);a.height=c.height<b.height?b.height+1:c.height+
1}};OIMO.DBVTBroadPhase=function(){OIMO.BroadPhase.call(this);this.types=OIMO.BR_BOUNDING_VOLUME_TREE;this.tree=new OIMO.DBVT;this.stack=[];this.leaves=[];this.numLeaves=0};OIMO.DBVTBroadPhase.prototype=Object.create(OIMO.BroadPhase.prototype);OIMO.DBVTBroadPhase.prototype.constructor=OIMO.DBVTBroadPhase;OIMO.DBVTBroadPhase.prototype.createProxy=function(a){return new OIMO.DBVTProxy(a)};OIMO.DBVTBroadPhase.prototype.addProxy=function(a){this.tree.insertLeaf(a.leaf);this.leaves.push(a.leaf);this.numLeaves++};
OIMO.DBVTBroadPhase.prototype.removeProxy=function(a){this.tree.deleteLeaf(a.leaf);a=this.leaves.indexOf(a.leaf);-1<a&&(this.leaves.splice(a,1),this.numLeaves--)};OIMO.DBVTBroadPhase.prototype.collectPairs=function(){if(!(2>this.numLeaves))for(var a,c=this.numLeaves;c--;)a=this.leaves[c],a.proxy.aabb.intersectTestTwo(a.aabb)&&(a.aabb.copy(a.proxy.aabb,0.1),this.tree.deleteLeaf(a),this.tree.insertLeaf(a),this.collide(a,this.tree.root))};
OIMO.DBVTBroadPhase.prototype.collide=function(a,c){var b=2,d,e,f,g;this.stack[0]=a;for(this.stack[1]=c;0<b;)d=this.stack[--b],e=this.stack[--b],f=null!=d.proxy,g=null!=e.proxy,this.numPairChecks++,f&&g?(d=d.proxy.shape,e=e.proxy.shape,d!=e&&!d.aabb.intersectTest(e.aabb)&&this.isAvailablePair(d,e)&&this.addPair(d,e)):d.aabb.intersectTest(e.aabb)||(g||!f&&d.aabb.surfaceArea()>e.aabb.surfaceArea()?(this.stack[b++]=d.child1,this.stack[b++]=e,this.stack[b++]=d.child2,this.stack[b++]=e):(this.stack[b++]=
d,this.stack[b++]=e.child1,this.stack[b++]=d,this.stack[b++]=e.child2))};OIMO.DBVTNode=function(){this.proxy=this.parent=this.child2=this.child1=null;this.height=0;this.aabb=new OIMO.AABB};OIMO.DBVTProxy=function(a){OIMO.Proxy.call(this,a);this.leaf=new OIMO.DBVTNode;this.leaf.proxy=this};OIMO.DBVTProxy.prototype=Object.create(OIMO.Proxy.prototype);OIMO.DBVTProxy.prototype.constructor=OIMO.DBVTProxy;OIMO.DBVTProxy.prototype.update=function(){};OIMO.World.prototype.add=function(a){a=a||{};var c=a.type||"box";"string"===typeof c&&(c=[c]);if("joint"==c[0].substring(0,5)){"joint"===c[0]&&(c[0]="jointHinge");var b=a.axe1||[1,0,0],d=a.axe2||[1,0,0],e=a.pos1||[0,0,0],f=a.pos2||[0,0,0],e=e.map(function(a){return a*OIMO.INV_SCALE}),f=f.map(function(a){return a*OIMO.INV_SCALE}),g,h;"jointDistance"===c[0]?(g=a.min||0,h=a.max||10,g*=OIMO.INV_SCALE,h*=OIMO.INV_SCALE):(g=a.min||57.29578,h=a.max||0,g*=OIMO.degtorad,h*=OIMO.degtorad);var k=a.limit||null,
l=a.spring||null,n=a.motor||null,m=new OIMO.JointConfig;m.allowCollision=a.collision||!1;m.localAxis1.init(b[0],b[1],b[2]);m.localAxis2.init(d[0],d[1],d[2]);m.localAnchorPoint1.init(e[0],e[1],e[2]);m.localAnchorPoint2.init(f[0],f[1],f[2]);if("string"==typeof a.body1||a.body1 instanceof String)a.body1=this.getByName(a.body1);if("string"==typeof a.body2||a.body2 instanceof String)a.body2=this.getByName(a.body2);m.body1=a.body1;m.body2=a.body2;var p;switch(c[0]){case "jointDistance":p=new OIMO.DistanceJoint(m,
g,h);null!==l&&p.limitMotor.setSpring(l[0],l[1]);null!==n&&p.limitMotor.setSpring(n[0],n[1]);break;case "jointHinge":p=new OIMO.HingeJoint(m,g,h);null!==l&&p.limitMotor.setSpring(l[0],l[1]);null!==n&&p.limitMotor.setSpring(n[0],n[1]);break;case "jointPrisme":p=new OIMO.PrismaticJoint(m,g,h);break;case "jointSlide":p=new OIMO.SliderJoint(m,g,h);break;case "jointBall":p=new OIMO.BallAndSocketJoint(m);break;case "jointWheel":p=new OIMO.WheelJoint(m),null!==k&&p.rotationalLimitMotor1.setLimit(k[0],k[1]),
null!==l&&p.rotationalLimitMotor1.setSpring(l[0],l[1]),null!==n&&p.rotationalLimitMotor1.setSpring(n[0],n[1])}p.name=a.name||"";this.addJoint(p);return p}b=a.move||!1;d=a.noSleep||!1;e=a.pos||[0,0,0];e=e.map(function(a){return a*OIMO.INV_SCALE});f=a.size||[1,1,1];f=f.map(function(a){return a*OIMO.INV_SCALE});k=a.rot||[0,0,0];k=k.map(function(a){return a*OIMO.degtorad});g=[];for(h=0;h<k.length/3;h++)l=OIMO.EulerToAxis(k[h+0],k[h+1],k[h+2]),g.push(l[0]),g.push(l[1]),g.push(l[2]),g.push(l[3]);k=new OIMO.ShapeConfig;
void 0!==a.sc&&(k=a.sc);a.config&&(k.density=void 0===a.config[0]?1:a.config[0],k.friction=void 0===a.config[1]?0.4:a.config[1],k.restitution=void 0===a.config[2]?0.2:a.config[2],k.belongsTo=a.config[3]||1,k.collidesWith=a.config[4]||4294967295);void 0!==a.density&&(k.density=a.density);void 0!==a.friction&&(k.friction=a.friction);void 0!==a.restitution&&(k.restitution=a.restitution);void 0!==a.belongsTo&&(k.belongsTo=a.belongsTo);void 0!==a.collidesWith&&(k.collidesWith=a.collidesWith);a.massPos&&
(a.massPos=a.massPos.map(function(a){return a*OIMO.INV_SCALE}),k.relativePosition.init(a.massPos[0],a.massPos[1],a.massPos[2]));a.massRot&&(a.massRot=a.massRot.map(function(a){return a*OIMO.degtorad}),k.relativeRotation=OIMO.EulerToMatrix(a.massRot[0],a.massRot[1],a.massRot[2]));l=new OIMO.RigidBody(e[0],e[1],e[2],g[0],g[1],g[2],g[3]);n=[];for(h=0;h<c.length;h++){m=3*h;p=4*h;switch(c[h]){case "sphere":n[h]=new OIMO.SphereShape(k,f[m]);break;case "cylinder":n[h]=new OIMO.CylinderShape(k,f[m],f[m+1]);
break;case "box":n[h]=new OIMO.BoxShape(k,f[m],f[m+1],f[m+2])}l.addShape(n[h]);0<h&&(n[h].relativePosition=new OIMO.Vec3(e[m],e[m+1],e[m+2]),g[p+0]&&(n[h].relativeRotation=[g[p],g[p+1],g[p+2],g[p+3]]))}b?(a.massPos||a.massRot?l.setupMass(1,!1):l.setupMass(1,!0),l.allowSleep=d?!1:!0):l.setupMass(2);l.name=a.name||" ";this.addRigidBody(l);return l};
