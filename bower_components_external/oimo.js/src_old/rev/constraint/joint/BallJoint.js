OIMO.BallJoint = function(config,rigid1,rigid2){
    OIMO.Joint.call( this );

    this.relPos1X=NaN;
    this.relPos1Y=NaN;
    this.relPos1Z=NaN;
    this.relPos2X=NaN;
    this.relPos2Y=NaN;
    this.relPos2Z=NaN;
    this.xTorqueUnit1X=NaN;
    this.xTorqueUnit1Y=NaN;
    this.xTorqueUnit1Z=NaN;
    this.xTorqueUnit2X=NaN;
    this.xTorqueUnit2Y=NaN;
    this.xTorqueUnit2Z=NaN;
    this.yTorqueUnit1X=NaN;
    this.yTorqueUnit1Y=NaN;
    this.yTorqueUnit1Z=NaN;
    this.yTorqueUnit2X=NaN;
    this.yTorqueUnit2Y=NaN;
    this.yTorqueUnit2Z=NaN;
    this.zTorqueUnit1X=NaN;
    this.zTorqueUnit1Y=NaN;
    this.zTorqueUnit1Z=NaN;
    this.zTorqueUnit2X=NaN;
    this.zTorqueUnit2Y=NaN;
    this.zTorqueUnit2Z=NaN;
    this.invI1e00=NaN;
    this.invI1e01=NaN;
    this.invI1e02=NaN;
    this.invI1e10=NaN;
    this.invI1e11=NaN;
    this.invI1e12=NaN;
    this.invI1e20=NaN;
    this.invI1e21=NaN;
    this.invI1e22=NaN;
    this.invI2e00=NaN;
    this.invI2e01=NaN;
    this.invI2e02=NaN;
    this.invI2e10=NaN;
    this.invI2e11=NaN;
    this.invI2e12=NaN;
    this.invI2e20=NaN;
    this.invI2e21=NaN;
    this.invI2e22=NaN;
    this.d00=NaN;
    this.d01=NaN;
    this.d02=NaN;
    this.d10=NaN;
    this.d11=NaN;
    this.d12=NaN;
    this.d20=NaN;
    this.d21=NaN;
    this.d22=NaN;
    this.targetVelX=NaN;
    this.targetVelY=NaN;
    this.targetVelZ=NaN;

    this.type=this.JOINT_BALL;
    this.body1=rigid1;
    this.body2=rigid2;
    this.connection1.connected=rigid2;
    this.connection2.connected=rigid1;
    this.allowCollision=config.allowCollision;
    this.localRelativeAnchorPosition1.copy(config.localRelativeAnchorPosition1);
    this.localRelativeAnchorPosition2.copy(config.localRelativeAnchorPosition2);
    this.lVel1=this.body1.linearVelocity;
    this.lVel2=this.body2.linearVelocity;
    this.aVel1=this.body1.angularVelocity;
    this.aVel2=this.body2.angularVelocity;
    this.invM1=this.body1.invertMass;
    this.invM2=this.body2.invertMass;
    this.impulse=new OIMO.Vec3();
    this.impulseX=0;
    this.impulseY=0;
    this.impulseZ=0;
}
OIMO.BallJoint.prototype = Object.create( OIMO.Joint.prototype );
OIMO.BallJoint.prototype.preSolve = function (timeStep,invTimeStep) {
    var tmpM;
    var tmp1X;
    var tmp1Y;
    var tmp1Z;
    var tmp2X;
    var tmp2Y;
    var tmp2Z;
    var t00;
    var t01;
    var t02;
    var t10;
    var t11;
    var t12;
    var t20;
    var t21;
    var t22;
    var u00;
    var u01;
    var u02;
    var u10;
    var u11;
    var u12;
    var u20;
    var u21;
    var u22;
    tmpM=this.body1.rotation.elements;
    tmp1X=this.localRelativeAnchorPosition1.x;
    tmp1Y=this.localRelativeAnchorPosition1.y;
    tmp1Z=this.localRelativeAnchorPosition1.z;
    this.relPos1X=this.relativeAnchorPosition1.x=tmp1X*tmpM[0]+tmp1Y*tmpM[1]+tmp1Z*tmpM[2];
    this.relPos1Y=this.relativeAnchorPosition1.y=tmp1X*tmpM[3]+tmp1Y*tmpM[4]+tmp1Z*tmpM[5];
    this.relPos1Z=this.relativeAnchorPosition1.z=tmp1X*tmpM[6]+tmp1Y*tmpM[7]+tmp1Z*tmpM[8];
    tmpM=this.body2.rotation.elements;
    tmp1X=this.localRelativeAnchorPosition2.x;
    tmp1Y=this.localRelativeAnchorPosition2.y;
    tmp1Z=this.localRelativeAnchorPosition2.z;
    this.relPos2X=this.relativeAnchorPosition2.x=tmp1X*tmpM[0]+tmp1Y*tmpM[1]+tmp1Z*tmpM[2];
    this.relPos2Y=this.relativeAnchorPosition2.y=tmp1X*tmpM[3]+tmp1Y*tmpM[4]+tmp1Z*tmpM[5];
    this.relPos2Z=this.relativeAnchorPosition2.z=tmp1X*tmpM[6]+tmp1Y*tmpM[7]+tmp1Z*tmpM[8];
    this.anchorPosition1.x=this.relPos1X+this.body1.position.x;
    this.anchorPosition1.y=this.relPos1Y+this.body1.position.y;
    this.anchorPosition1.z=this.relPos1Z+this.body1.position.z;
    this.anchorPosition2.x=this.relPos2X+this.body2.position.x;
    this.anchorPosition2.y=this.relPos2Y+this.body2.position.y;
    this.anchorPosition2.z=this.relPos2Z+this.body2.position.z;
    tmpM=this.body1.invertInertia.elements;
    this.invI1e00=tmpM[0];
    this.invI1e01=tmpM[1];
    this.invI1e02=tmpM[2];
    this.invI1e10=tmpM[3];
    this.invI1e11=tmpM[4];
    this.invI1e12=tmpM[5];
    this.invI1e20=tmpM[6];
    this.invI1e21=tmpM[7];
    this.invI1e22=tmpM[8];
    tmpM=this.body2.invertInertia.elements;
    this.invI2e00=tmpM[0];
    this.invI2e01=tmpM[1];
    this.invI2e02=tmpM[2];
    this.invI2e10=tmpM[3];
    this.invI2e11=tmpM[4];
    this.invI2e12=tmpM[5];
    this.invI2e20=tmpM[6];
    this.invI2e21=tmpM[7];
    this.invI2e22=tmpM[8];
    this.xTorqueUnit1X=this.relPos1Z*this.invI1e01-this.relPos1Y*this.invI1e02;
    this.xTorqueUnit1Y=this.relPos1Z*this.invI1e11-this.relPos1Y*this.invI1e12;
    this.xTorqueUnit1Z=this.relPos1Z*this.invI1e21-this.relPos1Y*this.invI1e22;
    this.xTorqueUnit2X=this.relPos2Z*this.invI2e01-this.relPos2Y*this.invI2e02;
    this.xTorqueUnit2Y=this.relPos2Z*this.invI2e11-this.relPos2Y*this.invI2e12;
    this.xTorqueUnit2Z=this.relPos2Z*this.invI2e21-this.relPos2Y*this.invI2e22;
    this.yTorqueUnit1X=-this.relPos1Z*this.invI1e00+this.relPos1X*this.invI1e02;
    this.yTorqueUnit1Y=-this.relPos1Z*this.invI1e10+this.relPos1X*this.invI1e12;
    this.yTorqueUnit1Z=-this.relPos1Z*this.invI1e20+this.relPos1X*this.invI1e22;
    this.yTorqueUnit2X=-this.relPos2Z*this.invI2e00+this.relPos2X*this.invI2e02;
    this.yTorqueUnit2Y=-this.relPos2Z*this.invI2e10+this.relPos2X*this.invI2e12;
    this.yTorqueUnit2Z=-this.relPos2Z*this.invI2e20+this.relPos2X*this.invI2e22;
    this.zTorqueUnit1X=this.relPos1Y*this.invI1e00-this.relPos1X*this.invI1e01;
    this.zTorqueUnit1Y=this.relPos1Y*this.invI1e10-this.relPos1X*this.invI1e11;
    this.zTorqueUnit1Z=this.relPos1Y*this.invI1e20-this.relPos1X*this.invI1e21;
    this.zTorqueUnit2X=this.relPos2Y*this.invI2e00-this.relPos2X*this.invI2e01;
    this.zTorqueUnit2Y=this.relPos2Y*this.invI2e10-this.relPos2X*this.invI2e11;
    this.zTorqueUnit2Z=this.relPos2Y*this.invI2e20-this.relPos2X*this.invI2e21;
    this.d00=this.invM1+this.invM2;
    this.d01=0;
    this.d02=0;
    this.d10=0;
    this.d11=this.d00;
    this.d12=0;
    this.d20=0;
    this.d21=0;
    this.d22=this.d00;
    t01=-this.relPos1Z;
    t02=this.relPos1Y;
    t10=this.relPos1Z;
    t12=-this.relPos1X;
    t20=-this.relPos1Y;
    t21=this.relPos1X;
    u00=this.invI1e01*t10+this.invI1e02*t20;
    u01=this.invI1e00*t01+this.invI1e02*t21;
    u02=this.invI1e00*t02+this.invI1e01*t12;
    u10=this.invI1e11*t10+this.invI1e12*t20;
    u11=this.invI1e10*t01+this.invI1e12*t21;
    u12=this.invI1e10*t02+this.invI1e11*t12;
    u20=this.invI1e21*t10+this.invI1e22*t20;
    u21=this.invI1e20*t01+this.invI1e22*t21;
    u22=this.invI1e20*t02+this.invI1e21*t12;
    this.d00-=t01*u10+t02*u20;
    this.d01-=t01*u11+t02*u21;
    this.d02-=t01*u12+t02*u22;
    this.d10-=t10*u00+t12*u20;
    this.d11-=t10*u01+t12*u21;
    this.d12-=t10*u02+t12*u22;
    this.d20-=t20*u00+t21*u10;
    this.d21-=t20*u01+t21*u11;
    this.d22-=t20*u02+t21*u12;
    t01=-this.relPos2Z;
    t02=this.relPos2Y;
    t10=this.relPos2Z;
    t12=-this.relPos2X;
    t20=-this.relPos2Y;
    t21=this.relPos2X;
    u00=this.invI2e01*t10+this.invI2e02*t20;
    u01=this.invI2e00*t01+this.invI2e02*t21;
    u02=this.invI2e00*t02+this.invI2e01*t12;
    u10=this.invI2e11*t10+this.invI2e12*t20;
    u11=this.invI2e10*t01+this.invI2e12*t21;
    u12=this.invI2e10*t02+this.invI2e11*t12;
    u20=this.invI2e21*t10+this.invI2e22*t20;
    u21=this.invI2e20*t01+this.invI2e22*t21;
    u22=this.invI2e20*t02+this.invI2e21*t12;
    this.d00-=t01*u10+t02*u20;
    this.d01-=t01*u11+t02*u21;
    this.d02-=t01*u12+t02*u22;
    this.d10-=t10*u00+t12*u20;
    this.d11-=t10*u01+t12*u21;
    this.d12-=t10*u02+t12*u22;
    this.d20-=t20*u00+t21*u10;
    this.d21-=t20*u01+t21*u11;
    this.d22-=t20*u02+t21*u12;
    tmp1X=1/(this.d00*(this.d11*this.d22-this.d21*this.d12)+this.d10*(this.d21*this.d02-this.d01*this.d22)+this.d20*(this.d01*this.d12-this.d11*this.d02));
    t00=(this.d11*this.d22-this.d12*this.d21)*tmp1X;
    t01=(this.d02*this.d21-this.d01*this.d22)*tmp1X;
    t02=(this.d01*this.d12-this.d02*this.d11)*tmp1X;
    t10=(this.d12*this.d20-this.d10*this.d22)*tmp1X;
    t11=(this.d00*this.d22-this.d02*this.d20)*tmp1X;
    t12=(this.d02*this.d10-this.d00*this.d12)*tmp1X;
    t20=(this.d10*this.d21-this.d11*this.d20)*tmp1X;
    t21=(this.d01*this.d20-this.d00*this.d21)*tmp1X;
    t22=(this.d00*this.d11-this.d01*this.d10)*tmp1X;
    this.d00=t00;
    this.d01=t01;
    this.d02=t02;
    this.d10=t10;
    this.d11=t11;
    this.d12=t12;
    this.d20=t20;
    this.d21=t21;
    this.d22=t22;
    this.lVel1.x+=this.impulseX*this.invM1;
    this.lVel1.y+=this.impulseY*this.invM1;
    this.lVel1.z+=this.impulseZ*this.invM1;
    this.aVel1.x+=this.xTorqueUnit1X*this.impulseX+this.yTorqueUnit1X*this.impulseY+this.zTorqueUnit1X*this.impulseZ;
    this.aVel1.y+=this.xTorqueUnit1Y*this.impulseX+this.yTorqueUnit1Y*this.impulseY+this.zTorqueUnit1Y*this.impulseZ;
    this.aVel1.z+=this.xTorqueUnit1Z*this.impulseX+this.yTorqueUnit1Z*this.impulseY+this.zTorqueUnit1Z*this.impulseZ;
    this.lVel2.x-=this.impulseX*this.invM2;
    this.lVel2.y-=this.impulseY*this.invM2;
    this.lVel2.z-=this.impulseZ*this.invM2;
    this.aVel2.x-=this.xTorqueUnit2X*this.impulseX+this.yTorqueUnit2X*this.impulseY+this.zTorqueUnit2X*this.impulseZ;
    this.aVel2.y-=this.xTorqueUnit2Y*this.impulseX+this.yTorqueUnit2Y*this.impulseY+this.zTorqueUnit2Y*this.impulseZ;
    this.aVel2.z-=this.xTorqueUnit2Z*this.impulseX+this.yTorqueUnit2Z*this.impulseY+this.zTorqueUnit2Z*this.impulseZ;
    this.targetVelX=this.anchorPosition2.x-this.anchorPosition1.x;
    this.targetVelY=this.anchorPosition2.y-this.anchorPosition1.y;
    this.targetVelZ=this.anchorPosition2.z-this.anchorPosition1.z;
    tmp1X=Math.sqrt(this.targetVelX*this.targetVelX+this.targetVelY*this.targetVelY+this.targetVelZ*this.targetVelZ);
    if(tmp1X<0.005){
    this.targetVelX=0;
    this.targetVelY=0;
    this.targetVelZ=0;
    }else{
    tmp1X=(0.005-tmp1X)/tmp1X*invTimeStep*0.05;
    this.targetVelX*=tmp1X;
    this.targetVelY*=tmp1X;
    this.targetVelZ*=tmp1X;
    }
}
OIMO.BallJoint.prototype.solve = function () {
    var relVelX;
    var relVelY;
    var relVelZ;
    var newImpulseX;
    var newImpulseY;
    var newImpulseZ;
    relVelX=this.lVel2.x-this.lVel1.x+this.aVel2.y*this.relPos2Z-this.aVel2.z*this.relPos2Y-this.aVel1.y*this.relPos1Z+this.aVel1.z*this.relPos1Y-this.targetVelX;
    relVelY=this.lVel2.y-this.lVel1.y+this.aVel2.z*this.relPos2X-this.aVel2.x*this.relPos2Z-this.aVel1.z*this.relPos1X+this.aVel1.x*this.relPos1Z-this.targetVelY;
    relVelZ=this.lVel2.z-this.lVel1.z+this.aVel2.x*this.relPos2Y-this.aVel2.y*this.relPos2X-this.aVel1.x*this.relPos1Y+this.aVel1.y*this.relPos1X-this.targetVelZ;
    newImpulseX=relVelX*this.d00+relVelY*this.d01+relVelZ*this.d02;
    newImpulseY=relVelX*this.d10+relVelY*this.d11+relVelZ*this.d12;
    newImpulseZ=relVelX*this.d20+relVelY*this.d21+relVelZ*this.d22;
    this.impulseX+=newImpulseX;
    this.impulseY+=newImpulseY;
    this.impulseZ+=newImpulseZ;
    this.lVel1.x+=newImpulseX*this.invM1;
    this.lVel1.y+=newImpulseY*this.invM1;
    this.lVel1.z+=newImpulseZ*this.invM1;
    this.aVel1.x+=this.xTorqueUnit1X*newImpulseX+this.yTorqueUnit1X*newImpulseY+this.zTorqueUnit1X*newImpulseZ;
    this.aVel1.y+=this.xTorqueUnit1Y*newImpulseX+this.yTorqueUnit1Y*newImpulseY+this.zTorqueUnit1Y*newImpulseZ;
    this.aVel1.z+=this.xTorqueUnit1Z*newImpulseX+this.yTorqueUnit1Z*newImpulseY+this.zTorqueUnit1Z*newImpulseZ;
    this.lVel2.x-=newImpulseX*this.invM2;
    this.lVel2.y-=newImpulseY*this.invM2;
    this.lVel2.z-=newImpulseZ*this.invM2;
    this.aVel2.x-=this.xTorqueUnit2X*newImpulseX+this.yTorqueUnit2X*newImpulseY+this.zTorqueUnit2X*newImpulseZ;
    this.aVel2.y-=this.xTorqueUnit2Y*newImpulseX+this.yTorqueUnit2Y*newImpulseY+this.zTorqueUnit2Y*newImpulseZ;
    this.aVel2.z-=this.xTorqueUnit2Z*newImpulseX+this.yTorqueUnit2Z*newImpulseY+this.zTorqueUnit2Z*newImpulseZ;
}
OIMO.BallJoint.prototype.postSolve = function () {
    this.impulse.x=this.impulseX;
    this.impulse.y=this.impulseY;
    this.impulse.z=this.impulseZ;
}